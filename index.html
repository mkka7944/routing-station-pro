<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Routing Station Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Force Scrollbar Visibility */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-left: 1px solid #e2e8f0;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
            border: 2px solid #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }


        :root {
            --primary: #2563eb;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #1e293b;
            --bg: #f8fafc;
            --sidebar-w: 320px;
            --sidebar-collapsed-w: 0px;
            --spacer: 16px;
            --spacer-lg: 24px;
            --font-xs: 11px;
            --font-sm: 13px;
            --font-base: 14px;
            --font-md: 16px;
            --font-lg: 18px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
            background: var(--bg);
            font-size: var(--font-base);
            color: var(--text);
        }

        /* Layout */
        #sidebar {
            width: var(--sidebar-w);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(226, 232, 240, 0.8);
            display: flex;
            flex-direction: column;
            z-index: 2000;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.03);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        #sidebar.collapsed {
            width: 0;
            border-right: none;
        }

        /* Desktop Toggle Button */
        #sidebar-toggle {
            position: absolute;
            left: 0;
            top: 12px;
            width: 32px;
            height: 38px;
            background: white;
            border: 1px solid #e2e8f0;
            border-left: none;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: black;
            z-index: 3000;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        #sidebar-toggle:hover {
            background: #f8fafc;
            color: var(--primary);
        }

        #sidebar-toggle i {
            transition: transform 0.4s;
            font-weight: bold;
        }

        .collapsed-toggle i {
            transform: rotate(180deg);
        }

        #main-stage {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .hide-map-ui #sidebar-toggle,
        .hide-map-ui .map-controls,
        .hide-map-ui #info-card {
            display: none !important;
        }

        #map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #ddd;
        }

        .leaflet-container img.leaflet-tile {
            outline: 1px solid transparent;
        }

        .leaflet-container * {
            box-sizing: content-box;
        }

        /* Fullscreen List View */
        #list-view-stage {
            position: absolute;
            inset: 0;
            background: var(--bg);
            z-index: 6000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            pointer-events: none;
        }

        #list-view-stage.active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .list-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .map-nav {
            position: absolute;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 50px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 25000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (max-width: 768px) {
            .map-nav {
                bottom: 65px;
                width: auto;
                min-width: 220px;
                justify-content: space-between;
                padding: 6px 12px;
            }

            .map-nav-text {
                font-size: 11px;
            }

            .map-nav .gal-btn {
                width: 44px !important;
                height: 44px !important;
            }
        }

        .map-nav-text {
            color: var(--text);
            font-weight: 700;
            font-size: 13px;
            white-space: nowrap;
        }

        .float-btn.active {
            background: var(--primary) !important;
            color: white !important;
        }

        .record-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 24px 24px 24px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            overflow-y: auto;
        }

        .card-header {
            margin-bottom: 8px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 6px;
        }

        .card-title {
            font-size: var(--font-lg);
            font-weight: 700;
            color: var(--text);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(var(--grid-cols, 3), 1fr);
            gap: 12px;
            margin-bottom: 20px;
            padding: 4px 12px 12px 12px;
        }

        .grid-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .grid-label {
            font-size: var(--font-xs);
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .grid-val {
            font-size: var(--font-base);
            font-weight: 500;
            color: var(--text);
        }

        .card-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .gallery-thumb {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .gallery-thumb:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Sidebar UI refinements */
        .filters {
            padding: 12px var(--spacer) 40px var(--spacer);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: all 0.3s;
            margin-bottom: 4px;
        }

        .filter-group.collapsed {
            gap: 0;
        }

        .filter-group.collapsed .multi-select-container {
            display: none;
        }

        .filter-group.collapsed .filter-content {
            display: none;
        }

        .filter-group.collapsed #f-start-container,
        .filter-group.collapsed #f-end-container {
            display: none;
        }

        .selection-badge {
            background: #eff6ff;
            color: #2563eb;
            font-size: 10px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 20px;
            border: 1.5px solid #dbeafe;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-transform: none;
            line-height: 1;
            height: 18px;
            min-width: 22px;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
            margin-left: auto;
            flex-shrink: 0;
        }

        .filter-label {
            font-size: 11px;
            font-weight: 800;
            color: #1e293b;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toggle-group-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1.5px solid #e2e8f0;
            background: white;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }

        .toggle-group-btn i {
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-group.active-group .toggle-group-btn i {
            transform: rotate(180deg);
        }

        .panel-header-premium {
            background: white;
            border: 1.5px solid #e2e8f0;
            border-radius: 12px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 40px;
        }

        .panel-header-premium:hover {
            background: #f8fafc;
            border-color: var(--primary);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.08);
        }

        .filter-group.active-group .panel-header-premium {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .panel-header-premium.action-btn-premium {
            border-color: transparent;
        }

        /* Sidebar Footer Styles */
        .sidebar-footer {
            margin-top: auto;
            padding: 12px 16px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 6px;
            z-index: 2100;
        }

        .footer-btn {
            flex: 1;
            height: 40px;
            border-radius: 10px;
            border: 1.5px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .footer-btn.apply {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .footer-btn.today {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }

        .footer-btn.reset {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .footer-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Nested Accordion Content */
        .nested-content {
            display: none;
            padding: 6px 12px 10px 12px;
        }

        .filter-group:not(.collapsed) .nested-content {
            display: block;
        }

        .sub-tool-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            color: #475569;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .sub-tool-item:hover {
            background: #eff6ff;
            color: var(--primary);
            transform: translateX(4px);
        }

        .sub-tool-item .material-icons-round {
            font-size: 20px;
        }

        .stat-badge {
            margin: 4px var(--spacer);
            padding: 10px 14px;
            border-radius: 12px;
            background: #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1.5px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: default;
        }

        .stat-badge:hover {
            transform: translateX(4px);
            background: #eff6ff;
            border-color: var(--primary);
        }



        /* Modernized Multi-Select List */
        .multi-select-container {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #fdfdfd;
            max-height: 180px;
            overflow-y: auto;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        #f-pay.multi-select-container {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 8px;
            max-height: none;
        }

        #f-pay .multi-option {
            padding: 6px 10px;
            flex: 1;
            justify-content: center;
            min-width: 80px;
        }

        .multi-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: var(--font-sm);
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            border: 1px solid transparent;
        }

        .multi-option:hover {
            background: #f8fafc;
            border-color: #f1f5f9;
        }

        .multi-option input {
            width: 18px;
            height: 18px;
            border-radius: 5px;
            border: 2px solid #cbd5e1;
            accent-color: var(--primary);
            margin: 0;
            cursor: pointer;
        }

        .multi-option.selected {
            background: #eff6ff;
            color: var(--primary);
            font-weight: 600;
            border-color: #dbeafe;
        }

        .multi-option.active-context {
            background: #fffbeb;
            border-color: #fef3c7;
            box-shadow: 0 0 0 1px #fef3c7;
        }

        .multi-option span {
            flex: 1;
            pointer-events: none;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            min-height: 28px;
            width: 100%;
        }

        .filter-actions {
            display: flex;
            gap: 4px;
            border-left: 1px solid #e2e8f0;
            padding-left: 8px;
            margin-left: auto;
        }

        .select-all-btn {
            background: #f8fafc;
            border: 1.5px solid #e2e8f0;
            color: #64748b;
            font-size: 10px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .select-all-btn:hover {
            background: #eff6ff;
            color: var(--primary);
            border-color: #bfdbfe;
        }

        .select-all-btn.unselect:hover {
            background: #fef2f2;
            color: #ef4444;
            border-color: #fee2e2;
        }

        .select-all-btn.unselect {
            color: #64748b;
            background: #f8fafc;
        }

        .apply-btn {
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: var(--font-base);
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3);
            transition: all 0.2s;
        }

        .apply-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .apply-btn:active {
            transform: translateY(0);
        }

        .secondary-btn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: white;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .secondary-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .secondary-btn span {
            font-size: 20px;
        }

        .stat-badge {
            background: #eff6ff;
            color: #1e40af;
            padding: 8px 16px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #dbeafe;
            margin: 12px 16px;
            box-shadow: 0 2px 4px rgba(30, 64, 175, 0.05);
        }

        .stat-badge span {
            font-size: 20px;
            font-weight: 800;
        }

        .stat-badge small {
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 700;
            opacity: 0.9;
            letter-spacing: 0.3px;
        }

        .guide-box {
            background: #fafafa;
            border: 1px solid #f1f5f9;
            border-radius: 12px;
            padding: 16px;
            margin: 0 24px 20px;
            color: #475569;
            font-size: 13px;
            text-align: center;
        }

        .guide-box-content {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        /* Settings UI Tweaks */
        .settings-tab-btn {
            padding: 8px 14px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            color: #64748b;
            font-weight: 500;
            border-radius: 20px;
            font-size: 11px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-tab-btn.active {
            background: #eff6ff;
            color: #2563eb;
            font-weight: 700;
            border-color: #bfdbfe;
        }

        .settings-tabs-row {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 8px;
            padding: 16px 20px;
            background: #fff;
            border-bottom: 1px solid #f1f5f9;
            scrollbar-width: none;
            -ms-overflow-style: none;
            /* Hide scrollbar for Chrome/Safari */
        }

        .settings-tabs-row::-webkit-scrollbar {
            display: none;
        }

        .kml-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 480px) {
            .kml-grid {
                grid-template-columns: 1fr;
            }
        }

        .settings-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            border-radius: 0 0 16px 16px;
            z-index: 10;
        }

        .tab-group-label {
            width: 100%;
            font-size: 10px;
            font-weight: 800;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 8px 0 4px 4px;
        }

        .guide-item {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            background: #fff;
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        }

        .guide-item i {
            font-size: 16px;
        }

        .guide-item b {
            color: #1e293b;
            font-weight: 700;
        }

        .guide-item span.penalty {
            background: #fee2e2;
            color: #b91c1c;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 800;
            margin-left: 4px;
        }

        .guide-box h4 {
            color: #1e293b;
            font-size: 14px;
            margin: 0 0 12px 0;
            font-weight: 700;
        }

        .fail-mark {
            color: #ef4444;
            font-size: 16px;
            margin-left: 2px;
            vertical-align: middle;
        }

        .pass-mark {
            color: #22c55e;
            font-size: 16px;
            margin-left: 2px;
            vertical-align: middle;
        }

        .score-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        button {
            cursor: pointer;
            font-family: inherit;
        }

        /* Leaderboard */
        .rank-row {
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.1s;
            font-size: 15px;
        }

        .rank-row:hover {
            background: #f8fafc;
        }

        .trophy {
            margin-left: 6px;
            display: inline-block;
            vertical-align: middle;
        }

        .trophy.gold {
            font-size: 28px;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.4));
        }

        .trophy.silver {
            font-size: 20px;
            filter: drop-shadow(0 0 3px rgba(148, 163, 184, 0.3));
        }

        .trophy.bronze {
            font-size: 18px;
            filter: drop-shadow(0 0 3px rgba(180, 83, 9, 0.2));
        }

        .idle-warn {
            color: var(--warning);
            font-weight: 700;
        }

        .idle-danger {
            color: var(--danger);
            font-weight: 700;
        }

        .time-warning {
            color: var(--danger);
            font-weight: 800;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.6;
            }
        }

        .stats-table-container {
            width: 100%;
            overflow-x: auto;
        }

        .count-badge {
            padding: 6px 14px;
            border-radius: 24px;
            font-weight: 800;
            font-size: 14px;
            background: #f1f5f9;
            color: #475569;
            display: inline-block;
            min-width: 50px;
            text-align: center;
        }

        .count-high {
            background: #dcfce7;
            color: #166534;
            box-shadow: 0 0 10px rgba(22, 101, 52, 0.1);
        }

        .status-msg {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .status-idle {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-warn {
            background: #fef3c7;
            color: #92400e;
        }

        .status-ok {
            background: #f0fdf4;
            color: #166534;
        }

        /* Map Interactive Focus Fix */
        path.leaflet-interactive:focus {
            outline: none !important;
        }

        /* Modern Tooltip Optimized */
        .leaflet-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            font-size: 11px;
            font-weight: 700;
            color: #1e293b;
            padding: 4px 8px;
            white-space: nowrap;
        }

        .leaflet-tooltip-left:before,
        .leaflet-tooltip-right:before {
            border: none !important;
        }

        /* Settings Modal Desktop Size */
        @media (min-width: 769px) {
            #modal-settings .modal-content {
                max-width: 800px !important;
                height: 700px !important;
            }
        }

        /* Advanced Gallery */
        .gallery-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            flex-direction: column;
            transition: opacity 0.3s;
        }

        .gallery-overlay.active {
            display: flex;
        }

        .gal-header {
            padding: 16px;
            display: flex;
            justify-content: flex-end;
            color: white;
        }

        .gal-viewport {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            touch-action: none;
        }

        .gal-img {
            max-width: 90%;
            max-height: 80%;
            object-fit: contain;
            transition: transform 0.2s cubic-bezier(0.1, 0, 0.2, 1);
            user-select: none;
            pointer-events: auto;
            -webkit-user-drag: none;
            user-drag: none;
        }

        .gal-img.no-transition {
            transition: none !important;
        }

        .rotate {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .gal-controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.5));
        }

        .gal-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            cursor: pointer;
        }

        /* Floating Controls */
        .map-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            opacity: 1;
            transform: translateY(0);
        }

        .control-group.collapsed {
            height: 0;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            margin-bottom: -12px;
        }

        .float-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            color: var(--text);
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1001;
        }

        .float-btn:hover {
            background: #f1f5f9;
            transform: scale(1.05);
        }

        .float-btn:active {
            transform: scale(0.95);
        }

        .float-btn.primary {
            background: var(--primary);
            color: white;
        }

        .float-btn .material-icons-round {
            font-size: 24px;
        }

        /* Info Card Defaults */
        #info-card {
            position: absolute;
            top: 12px;
            left: 50px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.94);
            backdrop-filter: blur(10px);
            border: 1px solid white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 8px 12px;
            width: 340px;
            opacity: 1;
            transform: translateY(0);
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
            transition: opacity 0.3s, transform 0.3s;
        }

        #info-card.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }

        .info-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            gap: 8px;
        }

        #info-card.minimized {
            width: auto;
            height: auto;
            min-width: 0;
            padding: 8px 12px;
            border-radius: 20px;
        }

        .info-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .info-val {
            font-size: 13px;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .pill {
            font-size: 10px;
            padding: 1px 5px;
            border-radius: 4px;
            font-weight: 800;
            white-space: nowrap;
        }

        .pill.dom {
            background: #dcfce7;
            color: #166534;
        }

        .pill.com {
            background: #fef3c7;
            color: #92400e;
        }

        .pill.paid {
            background: #dcfce7;
            color: #166534;
        }

        .pill.unpaid {
            background: #fee2e2;
            color: #991b1b;
        }

        .pill.not-billed {
            background: #f1f5f9;
            color: #475569;
        }

        .pill-lg {
            font-size: 13px;
            padding: 3px 10px;
            border-radius: 6px;
        }

        /* Collapsed logic */
        .filter-group.collapsed .multi-select-container,
        .filter-group.collapsed .filter-content,
        .filter-group.collapsed .filter-actions {
            display: none !important;
        }

        .address-bold {
            font-weight: 800 !important;
            color: #0f172a !important;
        }

        .area-small {
            font-size: 11px !important;
            opacity: 0.8;
        }

        .toggle-btn-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-top: 12px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #cbd5e1;
            transition: .3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                bottom: 0;
                width: var(--sidebar-w);
                z-index: 15000;
                transform: none;
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            #sidebar.collapsed {
                width: var(--sidebar-w);
                transform: none;
                left: -100%;
            }

            #sidebar.open {
                left: 0;
                box-shadow: 0 0 100px rgba(0, 0, 0, 0.5);
            }

            #sidebar-toggle {
                display: none;
            }

            .mobile-only {
                display: block;
            }

            .mobile-sidebar-toggle {
                display: flex !important;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            }

            .map-controls {
                bottom: 90px;
                right: 20px;
                z-index: 10001;
            }

            #sidebar header div:first-child div:first-child {
                font-size: 14px !important;
            }

            .filter-label {
                font-size: 10px !important;
            }

            .sidebar-header-padding {
                padding: 12px 12px 4px 12px !important;
            }

            /* Compact Filters on Mobile */
            .multi-select-container {
                max-height: 120px !important;
            }

            /* Info Card Mobile */
            #info-card {
                left: 50%;
                transform: translateX(-50%);
                width: 96%;
                max-width: 420px;
                top: 12px;
                max-height: 40vh;
                /* Prevent covering too much map */
                z-index: 1000;
            }

            #info-card.hidden {
                display: none !important;
                opacity: 0;
                pointer-events: none;
            }

            /* Hide Routing Station on Mobile */
            #routing-station-overlay {
                display: none !important;
            }

            /* Very small screens */
            @media (max-width: 480px) {
                .user-session-badge {
                    height: 34px;
                    min-width: 34px;
                    max-width: 34px;
                    top: 10px;
                    right: 10px;
                    padding: 1px;
                }

                .user-session-badge.expanded {
                    max-width: 260px;
                    padding-right: 8px;
                }

                .user-avatar {
                    width: 30px;
                    height: 30px;
                    border-width: 1.5px;
                }

                .user-name {
                    font-size: 9px;
                }

                .user-role {
                    font-size: 7px;
                }

                .logout-btn {
                    width: 24px;
                    height: 24px;
                }

                .logout-btn i {
                    font-size: 12px;
                }
            }

            @media (max-width: 380px) {
                .info-label {
                    font-size: 11px !important;
                }

                .info-val {
                    font-size: 11px !important;
                }

                .pill {
                    font-size: 9px !important;
                    padding: 1px 3px !important;
                }
            }

            .modal-header {
                flex-direction: column;
                align-items: stretch !important;
                gap: 16px;
                padding: 16px !important;
            }

            .modal-header>div {
                width: 100%;
                justify-content: space-between;
            }

            .perf-table th,
            .perf-table td {
                padding: 10px 4px !important;
                font-size: 12px;
            }

            .modal-header input[type="date"] {
                font-size: 13px;
                max-width: 110px;
            }

            /* Grid Shift */
            .card-grid {
                --grid-cols: 2;
                gap: 8px;
            }

            .grid-item div {
                font-size: 12px !important;
            }

            /* Mobile Button Fixes */
            .apply-btn {
                font-size: 11px !important;
                padding: 10px 4px !important;
                gap: 4px !important;
            }

            #f-start,
            #f-end {
                width: 100% !important;
                box-sizing: border-box !important;
            }
        }

        /* Sync Station (v4.2 Premium) */
        .sync-station {
            margin-top: 24px;
            margin-bottom: 24px;
            padding: 20px;
            background: rgba(248, 250, 252, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .sync-station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sync-station-title {
            font-size: 11px;
            font-weight: 800;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Spatial Routing Styles */
        .route-badge {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 900;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            border: 2px solid white;
            pointer-events: none;
            position: absolute;
            transform: translate(-50%, -100%) translateY(-10px);
            z-index: 26000;
        }

        .routing-panel {
            background: #f8fafc;
            border-radius: 16px;
            border: 1.5px dashed #cbd5e1;
            padding: 16px;
            margin-top: 12px;
            display: none;
        }

        /* Unified Routing Toolbar */
        .routing-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: transparent;
            border: none;
            flex-wrap: wrap;
        }

        .routing-tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            background: white;
            color: #64748b;
            cursor: pointer;
            padding: 0 2px;
            transition: all 0.15s;
        }

        .routing-tool-btn:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .routing-tool-btn.active {
            background: #e0f2fe;
            color: #0284c7;
            border-color: #bae6fd;
        }

        .routing-tool-btn .material-icons-round {
            font-size: 16px;
        }

        /* Picker Mode Cursor */
        body.picking-point .leaflet-container {
            cursor: crosshair !important;
        }

        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
        }

        .route-step-item.unsequenced {
            opacity: 0.7;
        }

        .route-step-item.unsequenced:hover {
            opacity: 1;
            background: white;
        }

        .routing-panel.active {
            display: block;
        }

        .route-step-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 8px;
            background: white;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: all 0.15s;
        }

        .route-step-item:hover {
            background: #eff6ff;
        }

        .routing-panel-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            /* Remove max-height, let flex handle it relative to parent overlay height */
            min-height: 0;
        }

        /* Info Card Touch Area Extension */
        #info-card::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 0;
            right: 0;
            height: 30px;
            z-index: 999;
            /* Transparent hit area for easier collapsing */
        }

        .route-seq-num,
        .route-seq-input {
            width: 22px;
            height: 22px;
            background: #f8fafc;
            color: var(--primary);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 800;
            border: 1px solid #e2e8f0;
            text-align: center;
            padding: 0;
            outline: none;
            transition: all 0.2s;
            -moz-appearance: textfield;
        }

        .route-seq-input::-webkit-outer-spin-button,
        .route-seq-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .route-seq-input:focus {
            border-color: var(--warning);
            background: #fffbeb;
            color: #92400e;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .route-step-item.is-sequenced {
            background: #f8f9fa !important;
            border-left: 3px solid #d1d5db !important;
        }

        .route-step-item.is-sequenced .route-seq-input {
            background: #9ca3af;
            color: #fff;
            border-color: #9ca3af;
        }

        .route-marker-square {
            background: var(--primary);
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            border: 1.5px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        .sync-status-badge {
            font-size: 10px;
            font-weight: 700;
            color: var(--primary);
            background: #eff6ff;
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid #dbeafe;
        }

        .sync-select-wrapper {
            position: relative;
            width: 100%;
        }

        .sync-select-wrapper select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1.5px solid #e2e8f0;
            background: white;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            appearance: none;
            transition: all 0.2s;
        }

        .sync-select-wrapper select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .sync-select-wrapper::after {
            content: '\e5cf';
            font-family: 'Material Icons Round';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
            font-size: 20px;
        }

        .sync-action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .sync-action-btn {
            height: 48px;
            border-radius: 14px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 800;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sync-action-btn.camera {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .sync-action-btn.camera:hover {
            background: #f0f7ff;
        }

        .sync-action-btn.gallery {
            background: #f8fafc;
            color: #64748b;
            border: 2px solid #e2e8f0;
        }

        .sync-action-btn.gallery:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .sync-action-btn.upload {
            grid-column: span 2;
            background: #10b981;
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .sync-action-btn.upload:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .sync-action-btn.upload:active {
            transform: translateY(0);
        }

        .sync-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .sync-preview-strip {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px;
            scrollbar-width: none;
            /* Firefox */
        }

        .sync-preview-strip::-webkit-scrollbar {
            display: none;
        }

        /* Chrome/Safari */

        .preview-item {
            position: relative;
            width: 64px;
            height: 64px;
            flex-shrink: 0;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ef4444;
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 480px) {
            .sync-action-grid {
                grid-template-columns: 1fr;
            }

            .sync-action-btn {
                height: 56px;
                font-size: 14px;
            }
        }


        /* KML Validation & UI */
        .toast-msg {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 9999;
        }

        .toast-msg.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Quick Filter Panel */
        .quick-filter-panel {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding: 0 4px;
            flex-wrap: wrap;
        }

        .quick-pill {
            flex: 1;
            padding: 8px 12px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: #f1f5f9;
            color: #64748b;
            border: 1.5px solid #e2e8f0;
        }

        .pop-card {
            background: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .leaflet-popup-content-wrapper {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
            padding: 0 !important;
        }

        .leaflet-popup-tip-container {
            width: 40px !important;
            height: 48px !important;
            margin-top: 0 !important;
            pointer-events: none !important;
            overflow: visible !important;
        }

        .leaflet-popup-tip {
            background: black !important;
            border: none !important;
            box-shadow: none !important;
            width: 1px !important;
            height: 40px !important;
            margin: 0 auto !important;
            padding: 0 !important;
            border-radius: 0 !important;
            transform: none !important;
            -webkit-transform: none !important;
            position: relative !important;
            top: 0 !important;
        }

        .leaflet-popup-tip::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%) !important;
            width: 0;
            height: 0;
            border-left: 4.5px solid transparent;
            border-right: 4.5px solid transparent;
            border-top: 8px solid black;
        }

        /* Custom Tooltip with Pointer Tail */
        .custom-tooltip {
            background: rgba(15, 23, 42, 0.88) !important;
            backdrop-filter: blur(8px);
            color: #f8fafc !important;
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            border-radius: 8px !important;
            padding: 6px 10px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            font-family: 'Inter', sans-serif !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25), 0 2px 6px rgba(0, 0, 0, 0.15) !important;
            letter-spacing: -0.2px;
            white-space: nowrap;
            overflow: visible !important;
        }

        .leaflet-tooltip.custom-tooltip::before,
        .leaflet-tooltip.custom-tooltip::after {
            display: none !important;
        }

        .leaflet-tooltip-top.custom-tooltip {
            margin-top: -10px !important;
        }

        .tooltip-arrow {
            position: absolute;
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tooltip-arrow-stem {
            width: 1px;
            height: 12px;
            background: black;
        }

        .tooltip-arrow-tip {
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 5px solid black;
        }

        .seq-tooltip {
            background: transparent;
            border: none;
            box-shadow: none;
            color: white;
            font-size: 10px;
            font-weight: 800;
            margin-top: -10px;
        }

        .seq-tooltip {
            display: none !important;
            /* Hide old tooltips if any remain */
        }

        .route-marker-square {
            background-color: rgba(59, 130, 246, 0.85);
            /* Semi-transparent */
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 3px;
            font-family: 'Inter', sans-serif;
            font-size: 9px;
            font-weight: 800;
            display: flex !important;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            text-align: center;
            line-height: 1;
        }

        .route-marker-square.is-start {
            background-color: #22c55e !important;
            border-color: #16a34a;
        }

        .route-marker-square.is-end {
            background-color: #ef4444 !important;
            border-color: #dc2626;
        }

        .route-item-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .route-item-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
            color: #94a3b8;
        }

        .route-item-btn span {
            font-size: 16px;
        }

        .route-item-btn:hover {
            background: #f1f5f9;
            color: #475569;
        }

        .route-step-item.is-start {
            border-left: 3px solid rgba(34, 197, 94, 0.45);
            background: #f0fdf4 !important;
        }

        .route-step-item.is-end {
            border-left: 3px solid rgba(239, 68, 68, 0.4);
            background: #fef2f2 !important;
        }

        .route-step-item.is-start .route-item-btn.start {
            background: #dcfce7;
            color: #16a34a;
        }

        .route-step-item.is-end .route-item-btn.end {
            background: #fee2e2;
            color: #ef4444;
        }

        .quick-pill:hover {
            background: #e2e8f0;
        }

        .quick-pill.active {
            background: #eff6ff;
            color: var(--primary);
            border-color: #bfdbfe;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .quick-pill.active i {
            color: var(--primary);
        }

        .quick-pill i {
            font-size: 14px;
            color: #94a3b8;
        }

        /* Routing Station Pro UI (v10.0) */
        #routing-station-overlay {
            display: none;
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 5000;
            width: 320px;
            min-width: 300px;
            height: 500px;
            max-height: 85vh;
            background: white;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #routing-drag-handle {
            flex: 0 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #f1f5f9;
            cursor: move;
            user-select: none;
        }

        .routing-toolbar {
            display: flex;
            gap: 5px;
            padding: 4px 8px;
            background: transparent;
            border: none;
            margin: 4px;
            flex-wrap: wrap;
        }

        .routing-tool-btn {
            flex: 0;
            min-width: 28px;
            height: 28px;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            padding: 0 2px;
        }

        .routing-tool-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .routing-tool-btn.active {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }

        .drawing-active,
        .drawing-active * {
            cursor: crosshair !important;
        }

        .routing-tool-btn.danger {
            color: #ef4444;
        }

        .routing-tool-btn.danger:hover {
            background: #fef2f2;
            border-color: #fecaca;
        }

        /* NEW ROUTING LIST DESIGN */
        /* --- ROUTING STATION V6 ULTIMATE RELIABILITY --- */
        #route-list-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        #route-list-container::-webkit-scrollbar-track {
            background: #f8fafc;
            border-left: 1px solid #e2e8f0;
        }

        #route-list-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
            border: 2px solid #f8fafc;
        }

        #route-list-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        #routing-resize-handle {
            position: absolute;
            bottom: 0px;
            right: 0px;
            width: 24px;
            height: 24px;
            cursor: nwse-resize;
            z-index: 10000;
            background: linear-gradient(135deg, transparent 50%, #e2e8f0 50%);
            border-radius: 0 0 16px 0;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            padding: 2px;
        }

        #routing-resize-handle:hover {
            background: linear-gradient(135deg, transparent 50%, #3b82f6 50%);
        }

        #routing-station-overlay {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 380px;
            height: 600px;
            background: white !important;
            border-radius: 16px !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
            z-index: 5000 !important;
            display: none;
            flex-direction: column;
            overflow: hidden;
            /* Enforce container boundary */
            border: 1px solid #e2e8f0;
        }

        #routing-body {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        #v4-panels-container {
            flex: 1;
            overflow: hidden !important;
            display: flex;
            flex-direction: column;
            min-height: 0 !important;
        }

        #routing-editor-panel {
            flex: 1;
            overflow: hidden !important;
            display: flex;
            flex-direction: column;
            min-height: 0 !important;
        }

        #route-list-container {
            flex: 1;
            overflow-y: auto !important;
            position: relative;
            background: #f1f5f9;
            min-height: 0 !important;
            /* height: 100% !important; removed to prevent push-out */
        }

        .v6-header {
            flex: 0 0 auto;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .v6-toolbar {
            flex: 0 0 auto;
            background: #fff;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 6px;
        }

        .v6-content-area {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: #f1f5f9;
            position: relative;
            min-height: 0;
        }

        .v6-list {
            padding: 4px 8px;
            display: flex !important;
            flex-direction: column !important;
            gap: 4px !important;
        }

        .v6-card {
            display: flex !important;
            align-items: center !important;
            background: #fff !important;
            padding: 4px 8px !important;
            border-radius: 6px !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
            color: #1e293b !important;
            min-height: 32px !important;
            flex-shrink: 0 !important;
            width: 100% !important;
            box-sizing: border-box !important;
            margin-bottom: 2px !important;
        }

        .v6-badge {
            width: 26px;
            height: 24px;
            background: #eff6ff;
            color: var(--primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-weight: 800;
            font-size: 11px;
            flex-shrink: 0;
        }

        /* Hide HTML5 Number Input Spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Allow clicks to pass through the transparent fill of routing polygons */
        .leaflet-routingPane-pane path {
            pointer-events: stroke !important;
        }

        .v6-card-body {
            flex: 1;
            min-width: 0;
        }

        .v6-card-title {
            font-weight: 700;
            font-size: 11px;
            color: #1e293b;
            line-height: 1.1;
        }

        .v6-card-sub {
            font-size: 8.5px;
            color: #64748b;
            line-height: 1.1;
        }

        .v6-action-btn {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            border: none;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .v6-tool-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1.5px solid #e2e8f0;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
        }

        .v6-tool-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .v6-tool-btn:disabled {
            opacity: 0.3 !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
        }

        .v6-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
        }

        .v6-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            font-size: 11px;
            font-weight: 700;
            color: #64748b;
            cursor: pointer;
        }

        .v6-tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .route-card {
            display: flex;
            align-items: center;
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            user-select: none;
            cursor: pointer;
        }

        .route-card:hover {
            border-color: #cbd5e1;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }

        .route-card.is-active {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .route-card-badge {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: #f1f5f9;
            color: #64748b;
            font-size: 11px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            border: 1px solid #e2e8f0;
        }

        .route-card.start .route-card-badge {
            background: #dcfce7;
            color: #16a34a;
            border-color: #bbf7d0;
        }

        .route-card.end .route-card-badge {
            background: #fee2e2;
            color: #ef4444;
            border-color: #fecaca;
        }

        .route-card-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .route-card-id {
            font-size: 12px;
            font-weight: 700;
            color: #1e293b;
        }

        .route-card-meta {
            font-size: 10px;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .route-card-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }

        .route-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 4px;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .route-action-btn:hover {
            background: #f1f5f9;
            color: #475569;
        }

        .route-action-btn.delete:hover {
            background: #fee2e2;
            color: #ef4444;
        }

        .routing-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #64748b;
        }

        #routing-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: nwse-resize;
            z-index: 10;
        }

        #paid-dashboard-stage {
            position: fixed;
            inset: 0;
            z-index: 8000;
            background: #f8fafc;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: pan-y;
        }

        .dash-layout {
            flex: 1;
            display: grid;
            grid-template-columns: 320px 1fr;
            overflow: hidden;
            height: 100%;
            background: #f1f5f9;
            transition: grid-template-columns 0.3s ease;
        }

        .dash-layout.sidebar-collapsed {
            grid-template-columns: 0px 1fr;
        }

        .dash-sidebar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(226, 232, 240, 0.8);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 24px 20px;
            transition: transform 0.3s ease, padding 0.3s ease;
        }

        .dash-layout.sidebar-collapsed .dash-sidebar {
            transform: translateX(-320px);
            padding: 24px 0;
            overflow: hidden;
        }

        .dash-main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
            border-radius: 0;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.05);
        }

        .dashboard-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-stats-grid {
            padding: 20px 30px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            background: #f8fafc;
            border-bottom: 1px solid #f1f5f9;
        }

        .dash-stat-card {
            padding: 16px;
            border-radius: 14px;
            background: white;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .dash-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
        }

        .dash-stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .dash-stat-info {
            flex: 1;
        }

        .dash-stat-label {
            font-size: 10px;
            font-weight: 800;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dash-stat-value {
            font-size: 18px;
            font-weight: 800;
            color: #1e293b;
        }

        .dash-filters {
            padding: 16px 30px;
            background: white;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .dash-filter-item {
            flex: 1;
            min-width: 140px;
        }

        .dash-filter-item label {
            display: block;
            font-size: 9px;
            font-weight: 800;
            color: #94a3b8;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dash-filter-item select,
        .dash-filter-item input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1.5px solid #e2e8f0;
            background: #f8fafc;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            transition: all 0.2s;
            outline: none;
            cursor: pointer;
        }

        .dash-filter-item select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        .dash-filter-item select:focus,
        .dash-filter-item input:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .paid-table-container {
            flex: 1;
            overflow: auto;
            background: white;
            -webkit-overflow-scrolling: touch;
        }

        .paid-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 1300px;
        }

        .paid-table th {
            position: sticky;
            top: 0;
            background: #f8fafc;
            z-index: 10;
            text-align: left;
            padding: 14px 12px;
            border-bottom: 2px solid #e2e8f0;
            color: #475569;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
        }

        .paid-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }

        /* Routing Station Overlay */
        #routing-station-overlay {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 300px;
            max-height: 85vh;
            background: white;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.25);
            display: none;
            flex-direction: column;
            overflow: hidden;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 5000;
        }

        #routing-drag-handle {
            flex: 0 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #f1f5f9;
            cursor: move;
            user-select: none;
        }

        .routing-toolbar {
            display: flex;
            gap: 5px;
            padding: 4px 8px;
            background: transparent;
            border: none;
            margin: 4px;
            flex-wrap: wrap;
        }

        .routing-tool-btn {
            flex: 0;
            min-width: 28px;
            height: 28px;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            padding: 0 2px;
        }

        .routing-tool-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .routing-tool-btn.active {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }

        .drawing-active,
        .drawing-active * {
            cursor: crosshair !important;
        }

        .routing-tool-btn.danger {
            color: #ef4444;
        }

        .routing-tool-btn.danger:hover {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .routing-panel-list {
            flex: 1;
            overflow-y: auto;
            padding: 6px 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #f8fafc;
        }

        .route-step-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
            position: relative;
            cursor: pointer;
        }

        .route-step-item:hover {
            border-color: #94a3b8;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        .route-step-item.is-sequenced {
            border-left: 3px solid #d1d5db;
        }

        .route-seq-input {
            width: 26px;
            height: 26px;
            border: 1px solid #e8ecf1;
            border-radius: 6px;
            text-align: center;
            font-size: 10px;
            font-weight: 700;
            color: #94a3b8;
            background: rgba(255, 255, 255, 0.6);
            outline: none;
            transition: all 0.15s;
            appearance: textfield;
            -moz-appearance: textfield;
        }

        .route-seq-input::-webkit-outer-spin-button,
        .route-seq-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .route-seq-input:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* Persistent Scrollbar for Routing List */
        #route-list-container::-webkit-scrollbar {
            width: 8px !important;
            height: 8px !important;
        }

        #route-list-container::-webkit-scrollbar-track {
            background: #f8fafc !important;
            border-left: 1px solid #e2e8f0 !important;
        }

        #route-list-container::-webkit-scrollbar-thumb {
            background: #cbd5e1 !important;
            border-radius: 4px !important;
            border: 2px solid #f8fafc !important;
        }

        #route-list-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8 !important;
        }

        #route-list-container {
            scrollbar-width: thin !important;
            scrollbar-color: #cbd5e1 #f8fafc !important;
            overflow-y: auto !important;
        }

        /* Scrollbar for Route Manager List */
        #route-manager-list::-webkit-scrollbar {
            width: 8px !important;
            height: 8px !important;
        }

        #route-manager-list::-webkit-scrollbar-track {
            background: #f8fafc !important;
            border-left: 1px solid #e2e8f0 !important;
        }

        #route-manager-list::-webkit-scrollbar-thumb {
            background: #cbd5e1 !important;
            border-radius: 4px !important;
            border: 2px solid #f8fafc !important;
        }

        #route-manager-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8 !important;
        }

        #route-manager-list {
            scrollbar-width: thin !important;
            scrollbar-color: #cbd5e1 #f8fafc !important;
            overflow-y: auto !important;
        }

        .nav-mini-btn {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: #94a3b8;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            padding: 0;
        }

        .nav-mini-btn:hover {
            background: #f1f5f9;
            color: #475569;
        }

        .nav-mini-btn span.material-icons-round {
            font-size: 14px;
        }

        .routing-empty-state {
            padding: 24px 16px;
            text-align: center;
            color: #64748b;
        }

        #routing-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: nwse-resize;
            z-index: 10;
        }

        /* Mobile Specific Overwrites */
        @media (max-width: 768px) {
            .dashboard-header {
                padding: 12px 16px;
                flex-direction: column;
                align-items: stretch;
            }

            .dash-main-content {
                padding: 12px;
                gap: 12px;
                overflow-y: auto !important;
                height: 100%;
            }

            .dashboard-stats-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .dash-filters {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }

            .dash-filter-item {
                width: 100%;
            }

            .dash-filter-item input,
            .dash-filter-item select {
                width: 100% !important;
            }

            /* Table to Cards Transformation */
            .paid-table thead {
                display: none;
            }

            .paid-table,
            .paid-table tbody,
            .paid-table tr,
            .paid-table td {
                display: block;
                width: 100%;
                min-width: 0 !important;
            }

            .paid-table tr {
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 16px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
                position: relative;
                overflow: hidden;
            }

            .paid-table tr:active {
                transform: scale(0.98);
                background: #f1f5f9;
            }

            .paid-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 6px 0;
                border: none;
                font-size: 13px;
                color: #475569;
                white-space: normal;
                text-align: right;
            }

            .paid-table td:first-child {
                border-bottom: 1px solid #f1f5f9;
                padding-bottom: 10px;
                margin-bottom: 10px;
                font-weight: 800;
                color: #1e293b;
                text-align: left;
            }

            .paid-table td:first-child::before {
                content: "Serial Number: ";
            }

            .paid-table td::before {
                content: attr(data-label);
                font-weight: 700;
                color: #94a3b8;
                font-size: 11px;
                text-transform: uppercase;
                margin-right: 12px;
                min-width: 100px;
                text-align: left;
            }

            .paid-table-container {
                overflow-y: visible;
            }

            .dash-footer {
                flex-direction: column;
                gap: 16px;
                padding: 16px;
                align-items: center;
            }

            .pagination-controls {
                width: 100%;
                justify-content: center;
            }

            .dash-sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 280px;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s;
                box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1);
            }

            .dash-sidebar.active {
                transform: translateX(0);
            }
        }

        .paid-table tr:hover {
            background: #f8fafc;
            cursor: pointer;
        }

        .paid-table tr:hover td {
            color: var(--primary);
        }

        .paid-id-link {
            display: inline-block;
            padding: 4px 10px;
            background: #eff6ff;
            color: var(--primary);
            font-weight: 800;
            border-radius: 6px;
            text-decoration: none;
            border: 1px solid #dbeafe;
        }

        .paid-deleted-id {
            display: inline-block;
            padding: 4px 10px;
            background: #fee2e2;
            color: #ef4444;
            font-weight: 700;
            border-radius: 6px;
            font-style: normal;
            border: 1px solid #fecaca;
        }

        .panel-heading {
            font-size: 13px;
            font-weight: 800;
            color: #1e293b;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 12px;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }

        .panel-heading:hover {
            background: #eff6ff;
            border-color: var(--primary);
            color: var(--primary);
        }

        .panel-heading span.material-icons-round {
            color: var(--primary);
            font-size: 20px;
            transition: transform 0.3s;
        }

        details[open] .panel-heading span.material-icons-round.chevron {
            transform: rotate(180deg);
        }

        details summary {
            list-style: none;
            outline: none;
        }

        details summary::-webkit-details-marker {
            display: none;
        }

        .analytics-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-top: 12px;
        }

        .analytics-item {
            padding: 12px 16px;
            border-radius: 12px;
            background: white;
            border: 1px solid rgba(226, 232, 240, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .analytics-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .analytics-item .name {
            font-size: 12px;
            font-weight: 700;
            color: #475569;
        }

        .analytics-item .value {
            font-size: 13px;
            font-weight: 800;
            color: #1e293b;
            text-align: right;
        }

        .analytics-item .sub {
            font-size: 10px;
            color: #94a3b8;
            font-weight: 600;
        }

        .top-5-badge {
            background: #fff7ed;
            color: #ea580c;
            border: 1px solid #ffedd5;
            padding: 2px 8px;
            border-radius: 50px;
            font-size: 9px;
            font-weight: 800;
        }

        .dash-footer {
            padding: 12px 30px;
            background: white;
            border-top: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            border: 1.5px solid #e2e8f0;
            background: white;
            color: #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #eff6ff;
            border-color: var(--primary);
            color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-info {
            font-weight: 700;
            color: #1e293b;
            min-width: 80px;
            text-align: center;
            font-size: 12px;
        }

        .rows-per-page {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1.5px solid #e2e8f0;
            font-size: 12px;
            font-weight: 700;
            outline: none;
            cursor: pointer;
        }

        /* User Session Pill (v9.0 Premium) */
        .user-session-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 5000;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.45);
            border-radius: 50px;
            padding: 2px;
            display: flex;
            align-items: center;
            gap: 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            transition: all 0.5s cubic-bezier(0.5, 0, 0.1, 1);
            overflow: hidden;
            cursor: pointer;
            height: 42px;
            min-width: 42px;
            max-width: 42px;
        }

        .user-session-badge.expanded {
            padding-right: 10px;
            gap: 10px;
            max-width: 320px;
        }

        .user-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: #f1f5f9;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            object-fit: cover;
            flex-shrink: 0;
            transition: transform 0.3s;
        }

        .user-session-badge:hover .user-avatar {
            transform: scale(1.05);
        }

        .user-avatar i {
            font-size: 20px;
            color: #64748b;
        }

        /* Sidebar Desktop UI Fixes */
        @media (min-width: 769px) {
            #list-view-stage .mobile-sidebar-toggle {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            #list-view-stage .mobile-sidebar-toggle {
                display: flex !important;
            }
        }

        .user-details-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateX(8px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            overflow: hidden;
            white-space: nowrap;
        }

        .user-session-badge.expanded .user-details-wrapper {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
            transition-delay: 0.15s;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            white-space: nowrap;
        }

        .user-name {
            font-size: 11px;
            font-weight: 800;
            color: #1e293b;
            line-height: 1.2;
        }

        .user-role {
            font-size: 9px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .logout-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #fee2e2;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            color: #ef4444;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0);
        }

        .user-session-badge.expanded .logout-btn {
            transform: scale(1);
            transition-delay: 0.3s;
        }

        .logout-btn:hover {
            background: #fecaca;
            transform: scale(1.15) rotate(-12deg);
            transition-delay: 0s !important;
        }

        .logout-btn i {
            font-size: 16px;
            font-weight: 800;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 1200px) {
            .dash-layout {
                grid-template-columns: 300px 1fr;
            }
        }

        @media (max-width: 992px) {
            .dash-layout {
                grid-template-columns: 1fr;
            }

            .dash-sidebar {
                position: fixed;
                inset: 0;
                z-index: 8500;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                width: 320px;
                box-shadow: 20px 0 50px rgba(0, 0, 0, 0.1);
            }

            .dash-sidebar.active {
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .dashboard-header {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .dashboard-header h2 {
                font-size: 16px;
            }

            .dashboard-stats-grid {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 16px 20px;
            }

            .dash-filters {
                padding: 16px 20px;
                gap: 10px;
            }

            .dash-filter-item {
                min-width: 100%;
            }

            .dash-footer {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
                text-align: center;
            }

            .pagination-controls {
                justify-content: center;
            }

            .paid-table th,
            .paid-table td {
                font-size: 11px;
                padding: 10px 8px;
            }

            .paid-table-container {
                -webkit-overflow-scrolling: touch;
            }

            .desktop-only {
                display: none;
            }

            /* Sticky Column for Survey ID on mobile */
            .paid-table th:nth-child(2),
            .paid-table td:nth-child(2) {
                position: sticky;
                left: 0;
                background: white;
                z-index: 5;
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            }

            .paid-table th:nth-child(2) {
                z-index: 15;
                background: #f8fafc;
            }
        }

        .all-records-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white !important;
            font-weight: 800;
            padding: 0 20px;
            font-size: 12px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: none;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }

        .all-records-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        .all-records-btn:active {
            transform: translateY(0);
        }

        .all-records-btn.active {
            background: #1e293b !important;
            border: 2px solid #3b82f6 !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .paid-deleted-id {
            background: #fee2e2;
            color: #991b1b;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 800;
            font-size: 10px;
        }

        /* Universal Search UI (v6.0 Build) */
        #modal-search {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            z-index: 11000;
            align-items: flex-start;
            justify-content: center;
            padding-top: 80px;
        }

        .search-container {
            background: white;
            width: 100%;
            max-width: 650px;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            margin: 0 20px;
        }

        .search-input-wrapper {
            padding: 20px 24px;
            border-bottom: 1px solid #f1f5f9;
            background: white;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        #universal-search-input {
            flex: 1;
            border: none;
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            outline: none;
            background: transparent;
        }

        /* Custom Premium Select */
        .custom-select-wrapper {
            position: relative;
            width: 100%;
            user-select: none;
        }

        .custom-select-trigger {
            padding: 10px 16px;
            border-radius: 12px;
            border: 1.5px solid #e2e8f0;
            background: #f8fafc;
            font-size: 12px;
            font-weight: 700;
            color: #475569;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-select-trigger:hover {
            border-color: var(--primary);
            background: white;
        }

        .custom-select-wrapper.open .custom-select-trigger {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .custom-select-trigger span.material-icons-round {
            font-size: 18px;
            color: #94a3b8;
            transition: transform 0.2s;
        }

        .custom-select-wrapper.open .custom-select-trigger span.material-icons-round {
            transform: rotate(180deg);
        }

        .custom-select-options {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: white;
            border-radius: 14px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 12000;
            max-height: 250px;
            overflow-y: auto;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .custom-select-wrapper.open .custom-select-options {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .option-item {
            padding: 10px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.1s;
        }

        .option-item:hover {
            background: #f1f5f9;
            color: var(--primary);
        }

        .option-item.active {
            background: #eff6ff;
            color: var(--primary);
            font-weight: 700;
        }

        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background: white;
        }

        .search-item {
            padding: 14px 24px;
            border-bottom: 1px solid #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-item:hover {
            background: #f0f7ff;
            transform: translateX(4px);
        }

        .search-item-main {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .search-item-title {
            font-weight: 800;
            color: #1e293b;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-item-sub {
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-item-meta {
            font-size: 10px;
            font-weight: 800;
            color: var(--primary);
            background: #eff6ff;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 4px;
        }

        .search-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 800;
            background: #f1f5f9;
            color: #475569;
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <div id="login-overlay"
        style="position:fixed; inset:0; background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%); z-index:999999; display:flex; align-items:center; justify-content:center; padding:20px; transition: opacity 0.5s ease;">
        <div
            style="background:white; padding:40px; border-radius:24px; width:100%; max-width:400px; text-align:center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
            <div
                style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); width:72px; height:72px; border-radius:20px; display:flex; align-items:center; justify-content:center; margin:0 auto 24px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);">
                <span class="material-icons-round" style="font-size:36px; color:white;">analytics</span>
            </div>
            <h1 style="margin:0 0 8px; font-size:26px; font-weight:800; color:#1e293b; letter-spacing:-0.5px;">Field
                Staff Pro</h1>
            <p style="margin:0 0 32px; font-size:14px; color:#64748b; font-weight:600;">Recovery & Billing Intelligence
            </p>

            <div id="g_id_onload"
                data-client_id="1039864656694-57q2kbgrpc9fivodbqj7kaffh1kr3fql.apps.googleusercontent.com"
                data-context="signin" data-ux_mode="popup" data-callback="handleCredentialResponse"
                data-auto_select="true" data-itp_support="true">
            </div>
            <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signin_with"
                data-size="large" data-logo_alignment="left">
            </div>

            <div id="auth-status" style="margin-top:24px; font-size:13px; min-height:20px;"></div>
        </div>
    </div>

    <div id="sidebar">
        <!-- Compact Header -->
        <div class="sidebar-header-padding"
            style="padding: 12px 16px 4px 16px; border-bottom: 1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-weight: 700; font-size: 16px;">Routing Station Pro</div>
                <div style="font-size: 10px; color: #64748b; font-weight: 600; margin-top:2px;">
                    Updated: 20-Feb 04:32 PM
                    <span style="color:var(--primary); margin-left:4px;">[Rev. 1228.2220]</span>
                </div>
            </div>

            <div style="text-align: right;">
                <div id="zoom-level-text" style="font-size: 12px; color: #64748b; font-weight: 500;">Z: 13</div>
                <div style="font-size: 10px; color: #94a3b8; font-weight: 500;">Kashif Khalil <span
                        style="font-size: 9px;"></span></div>
            </div>

            <button class="mobile-only" onclick="Sidebar.toggle()"
                style="background:none; border:none; display:none; position:absolute; top:16px; right:16px;"><span
                    class="material-icons-round">close</span></button>
        </div>

        <div id="sidebar-scroll" style="flex:1; overflow-y:auto; overflow-x: hidden; padding-bottom: 20px;">
            <div class="filters" style="padding: 8px var(--spacer) 80px var(--spacer);">
                <div class="filter-group" style="margin-bottom: 16px;">
                    <div class="panel-header-premium" onclick="SpatialRouter.toggleUI()"
                        style="background: white; border: 1.5px solid #e2e8f0;">
                        <span class="material-icons-round" style="color:var(--primary); font-size:20px;">route</span>
                        <span class="filter-label" style="flex:1; color: var(--text);">Routing Station</span>
                        <span class="material-icons-round" style="font-size:18px; opacity:0.7;">chevron_right</span>
                    </div>
                </div>

                <div class="filter-group collapsed">
                    <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                        <span class="material-icons-round" style="color:var(--primary); font-size:20px;">public</span>
                        <span class="filter-label" id="lbl-dist" style="flex:1">Districts</span>
                        <div class="selection-badge" id="badge-f-dist" style="display:none">0</div>
                        <button class="toggle-group-btn"
                            style="border:none; background:none; padding:0; margin-left:8px;">
                            <i class="material-icons-round">expand_more</i>
                        </button>
                    </div>
                    <div id="f-dist" class="multi-select-container"></div>
                </div>
                <div class="filter-group collapsed">
                    <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                        <span class="material-icons-round"
                            style="color:var(--primary); font-size:20px;">location_city</span>
                        <span class="filter-label" id="lbl-tehsil" style="flex:1">Tehsils</span>
                        <div class="selection-badge" id="badge-f-tehsil" style="display:none">0</div>
                        <button class="toggle-group-btn"
                            style="border:none; background:none; padding:0; margin-left:8px;">
                            <i class="material-icons-round">expand_more</i>
                        </button>
                    </div>
                    <div id="f-tehsil" class="multi-select-container"></div>
                </div>
                <div class="filter-group collapsed">
                    <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                        <span class="material-icons-round" style="color:var(--primary); font-size:20px;">map</span>
                        <span class="filter-label" id="lbl-mc" style="flex:1">MC/UC Areas</span>
                        <div class="filter-actions" style="border:none; padding:0; margin-right:8px;">
                            <button class="select-all-btn"
                                onclick="event.stopPropagation(); App.toggleAll('f-mc', true)">All</button>
                            <button class="select-all-btn unselect"
                                onclick="event.stopPropagation(); App.toggleAll('f-mc', false)">None</button>
                        </div>
                        <div class="selection-badge" id="badge-f-mc" style="display:none">0</div>
                        <button class="toggle-group-btn"
                            style="border:none; background:none; padding:0; margin-left:8px;">
                            <i class="material-icons-round">expand_more</i>
                        </button>
                    </div>
                    <div id="f-mc" class="multi-select-container"></div>
                </div>
                <div class="filter-group collapsed">
                    <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                        <span class="material-icons-round"
                            style="color:var(--primary); font-size:20px;">calendar_month</span>
                        <span class="filter-label" style="flex:1">Date Range</span>
                        <button class="select-all-btn unselect" onclick="event.stopPropagation(); App.clearDates()"
                            style="margin-left:auto; margin-right:8px;">Clear</button>
                        <button class="toggle-group-btn" style="border:none; background:none; padding:0;">
                            <i class="material-icons-round">expand_more</i>
                        </button>
                    </div>
                    <div class="filter-content" style="padding: 12px 16px; display:flex; gap:12px;">
                        <div style="flex:1">
                            <input type="text" id="f-start" class="filter-select" placeholder="Start Date"
                                style="padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-size:13px; font-weight:500; width:100%;">
                        </div>
                        <div style="flex:1">
                            <input type="text" id="f-end" class="filter-select" placeholder="End Date"
                                style="padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-size:13px; font-weight:500; width:100%;">
                        </div>
                    </div>
                </div>


                <!-- Cloud Sync Filter -->
                <div class="filter-group collapsed">
                    <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                        <span class="material-icons-round" style="color:#10b981; font-size:20px;">cloud_sync</span>
                        <span class="filter-label" id="lbl-drive" style="flex:1">Drive Sync</span>
                        <button class="select-all-btn unselect"
                            onclick="event.stopPropagation(); document.getElementById('f-drive-only').checked=false; App.handleMultiChange({target:document.getElementById('f-drive-only')}, 'f-drive', 'apply')"
                            style="margin-left:auto; margin-right:8px;">Clear</button>
                        <div class="selection-badge" id="badge-f-drive"
                            style="display:none; margin-left:0; margin-right:8px;">0</div>
                        <button class="toggle-group-btn" style="border:none; background:none; padding:0;">
                            <i class="material-icons-round">expand_more</i>
                        </button>
                    </div>
                    <div id="f-drive" class="multi-select-container" style="padding: 12px 16px;">
                        <div class="multi-option" onclick="App.handleMultiClick(event, 'f-drive', 'apply')">
                            <input type="checkbox" id="f-drive-only"
                                onchange="App.handleMultiChange(event, 'f-drive', 'apply')">
                            <span style="font-weight:600; color:#059669;">Show drive images only</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Categories -->
                <div class="filter-group collapsed">
                    <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                        <span class="material-icons-round" style="color:#8b5cf6; font-size:20px;">category</span>
                        <span class="filter-label" id="lbl-quick"
                            style="flex:1; display:flex; align-items:center; gap:4px;">
                            Categories <sup id="badge-f-quick"
                                style="display:none; color:var(--primary); font-weight:800; font-size:10px;">0</sup>
                        </span>
                        <button class="toggle-group-btn"
                            style="border:none; background:none; padding:0; margin-left:8px;">
                            <i class="material-icons-round">expand_more</i>
                        </button>
                    </div>
                    <div id="f-quick" class="filter-content multi-select-container" style="padding: 12px 16px;">
                        <div class="multi-option selected" data-value="domestic"
                            onclick="App.toggleQuickFilter('domestic', event)">
                            <input type="checkbox" checked id="q-domestic"> <span>Domestic</span>
                        </div>
                        <div class="multi-option selected" data-value="commercial"
                            onclick="App.toggleQuickFilter('commercial', event)">
                            <input type="checkbox" checked id="q-commercial"> <span>Commercial</span>
                        </div>
                    </div>
                </div>

                <!-- Tools: Surveyors -->
                <div class="filter-group collapsed">
                    <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                        <span class="material-icons-round" style="color:#f59e0b; font-size:20px;">engineering</span>
                        <span class="filter-label">Surveyors</span>
                        <span class="selection-badge" id="badge-f-surveyor" style="display:none">0</span>
                        <button class="toggle-group-btn"
                            style="border:none; background:none; padding:0; margin-left:8px;">
                            <i class="material-icons-round">expand_more</i>
                        </button>
                    </div>
                    <div id="f-surveyor" class="filter-content multi-select-container"
                        style="padding: 4px 12px 12px 12px; max-height:240px; overflow-y:auto; background:#fafafa; border-radius:0 0 8px 8px;">
                        <!-- Dynamic -->
                    </div>
                </div>

                <!-- Tools: Bills & Payments -->
                <div class="filter-group collapsed">
                    <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                        <span class="material-icons-round" style="color:#22c55e; font-size:20px;">payments</span>
                        <span class="filter-label">Bills & Payments</span>
                        <span class="selection-badge" id="badge-paid-count" style="display:none">0</span>
                        <button class="toggle-group-btn"
                            style="border:none; background:none; padding:0; margin-left:8px;">
                            <i class="material-icons-round">expand_more</i>
                        </button>
                    </div>
                    <div class="filter-content"
                        style="padding: 4px 12px 12px 12px; display:flex; flex-direction:column; gap:4px;">
                        <div class="nested-content"
                            style="display:flex; flex-direction:column; gap:6px; margin-bottom:8px;">
                            <div class="sub-tool-item admin-only" onclick="PaidBills.open()">
                                <span class="material-icons-round">dashboard</span>
                                <span>Dashboard</span>
                            </div>
                            <div class="sub-tool-item" onclick="BillVerifier.open()">
                                <span class="material-icons-round">verified_user</span>
                                <span>Verify Bill</span>
                            </div>
                        </div>

                        <div id="f-pay" class="multi-select-container"
                            style="padding: 8px 4px; border-top: 1px solid #f1f5f9; background: #fafafa; border-radius: 8px;">
                            <div
                                style="font-size:10px; font-weight:800; color:#94a3b8; text-transform:uppercase; margin-bottom:6px; padding-left:4px;">
                                Payment Filter</div>
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <div class="multi-option" data-value="paid"
                                    onclick="App.handleMultiClick(event, 'f-pay', 'apply')">
                                    <input type="checkbox" onchange="App.handleMultiChange(event, 'f-pay', 'apply')">
                                    <span class="pill paid" style="font-size:10px;">Paid</span>
                                </div>
                                <div class="multi-option" data-value="unpaid"
                                    onclick="App.handleMultiClick(event, 'f-pay', 'apply')">
                                    <input type="checkbox" onchange="App.handleMultiChange(event, 'f-pay', 'apply')">
                                    <span class="pill unpaid" style="font-size:10px;">Unpaid</span>
                                </div>
                                <div class="multi-option" data-value="not-billed"
                                    onclick="App.handleMultiClick(event, 'f-pay', 'apply')">
                                    <input type="checkbox" onchange="App.handleMultiChange(event, 'f-pay', 'apply')">
                                    <span class="pill not-billed" style="font-size:10px;">Not Billed</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tools: List View -->
                <div class="filter-group collapsed">
                    <div class="panel-header-premium" onclick="ViewSwitcher.toList()">
                        <span class="material-icons-round" style="color:#06b6d4; font-size:20px;">view_list</span>
                        <span class="filter-label">List View</span>
                        <span class="material-icons-round"
                            style="font-size:18px; color:#94a3b8; margin-left:auto;">chevron_right</span>
                    </div>
                </div>

                <!-- Tools: Saved Routes -->
                <div class="filter-group collapsed">
                    <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                        <span class="material-icons-round" style="color:var(--warning); font-size:20px;">route</span>
                        <span class="filter-label">Designed Routes</span>
                        <button class="toggle-group-btn"
                            style="border:none; background:none; padding:0; margin-left:auto;">
                            <i class="material-icons-round">expand_more</i>
                        </button>
                    </div>
                    <div class="filter-content" style="padding: 4px 12px 12px 12px;">
                        <div id="side-route-list" style="display:flex; flex-direction:column; gap:8px;">
                            <div style="text-align:center; padding:12px; color:#94a3b8; font-size:11px;">No saved routes
                                found</div>
                        </div>
                    </div>
                </div>

                <!-- Tools: Staff Report -->
                <div class="filter-group collapsed admin-only">
                    <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                        <span class="material-icons-round"
                            style="color:var(--primary); font-size:20px;">assignment_ind</span>
                        <span class="filter-label">Staff Report Section</span>
                        <button class="toggle-group-btn"
                            style="border:none; background:none; padding:0; margin-left:8px;">
                            <i class="material-icons-round">expand_more</i>
                        </button>
                    </div>
                    <div class="filter-content" style="padding: 4px 12px 12px 12px;">
                        <div class="nested-content" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                            <div class="sub-tool-item" onclick="Stats.open()"
                                style="background:#f8fafc; border:1px solid #e2e8f0; justify-content:center; flex-direction:column; gap:4px; padding:12px;">
                                <span class="material-icons-round" style="color:#f59e0b;">leaderboard</span>
                                <span style="font-size:10px;">Leaderboard</span>
                            </div>
                            <div class="sub-tool-item" onclick="PerformanceLog.open()"
                                style="background:#f8fafc; border:1px solid #e2e8f0; justify-content:center; flex-direction:column; gap:4px; padding:12px;">
                                <span class="material-icons-round" style="color:#8b5cf6;">assignment_turned_in</span>
                                <span style="font-size:10px;">Performance</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Live Totals badge (Repositioned above footer) -->
        <div class="stat-badge">
            <small id="stat-label" style="font-weight:700; color:#64748b; text-transform:uppercase; font-size:9px;">Live
                Survey Data</small>
            <span id="stat-count" style="font-weight:800; color:var(--primary); font-size:14px;">0</span>
        </div>

        <!-- Fixed Sidebar Footer -->
        <div class="sidebar-footer">
            <div class="footer-btn apply" onclick="App.apply()">
                <span class="material-icons-round">done</span> Apply
            </div>
            <div class="footer-btn reset" onclick="App.resetFilters()">
                <span class="material-icons-round">refresh</span> Reset
            </div>
        </div>


    </div>

    <div id="main-stage">
        <div id="map-pager" class="map-nav" style="display: none;">
            <button onclick="MapNavigator.move(-1)" class="gal-btn"
                style="background:white; color:var(--text); box-shadow:0 2px 4px rgba(0,0,0,0.05);"><span
                    class="material-icons-round" style="font-size:20px;">chevron_left</span></button>
            <span class="map-nav-text">Record <span id="map-nav-idx">0</span> of <span
                    id="map-nav-total">0</span></span>
            <button onclick="MapNavigator.move(1)" class="gal-btn"
                style="background:white; color:var(--text); box-shadow:0 2px 4px rgba(0,0,0,0.05);"><span
                    class="material-icons-round" style="font-size:20px;">chevron_right</span></button>
        </div>
        <button id="sidebar-toggle" onclick="Sidebar.toggleDesktop()" title="Toggle Sidebar">
            <i class="material-icons-round">keyboard_arrow_left</i>
        </button>
        <div id="info-card" class="minimized">
            <!-- Populated by JS -->
        </div>
        <div id="map-container">
            <div id="user-session" class="user-session-badge" style="display:none" onclick="Auth.toggle()">
                <img id="sess-pic" class="user-avatar" style="display:none">
                <div id="sess-avatar-fallback" class="user-avatar">
                    <i class="material-icons-round">person</i>
                </div>
                <div class="user-details-wrapper">
                    <div class="user-info">
                        <div id="sess-name" class="user-name">User</div>
                        <div id="sess-role" class="user-role">Role</div>
                    </div>
                    <button class="logout-btn" onclick="event.stopPropagation(); Auth.logout()" title="Logout">
                        <i class="material-icons-round">power_settings_new</i>
                    </button>
                </div>
            </div>
            <div id="map"></div>

            <div class="map-controls">
                <div id="extra-ctrls" class="control-group">
                    <button class="float-btn admin-only" onclick="Stats.open()" title="Leaderboard">
                        <span class="material-icons-round" style="color:#f59e0b">leaderboard</span>
                    </button>
                    <button class="float-btn admin-only" onclick="PerformanceLog.open()" title="Performance">
                        <span class="material-icons-round" style="color:#8b5cf6">assignment_turned_in</span>
                    </button>
                    <button class="float-btn" onclick="ViewSwitcher.toList()" title="List View">
                        <span class="material-icons-round" style="color:#06b6d4">view_list</span>
                    </button>
                    <button class="float-btn" onclick="UniversalSearch.open()" title="Universal Search"
                        style="background:var(--primary); color:white;">
                        <span class="material-icons-round">search</span>
                    </button>
                    <button id="btn-nav-toggle" class="float-btn" onclick="MapNavigator.toggle()"
                        title="Map Navigation">
                        <span class="material-icons-round">explore</span>
                    </button>
                    <button class="float-btn" onclick="SpatialRouter.toggleUI()" title="Route Optimization">
                        <span class="material-icons-round" style="color:var(--warning)">route</span>
                    </button>
                    <button class="float-btn" onclick="App.toggleLayer()" title="Toggle Satellite">
                        <span class="material-icons-round" id="layer-icon">satellite_alt</span>
                    </button>
                    <button class="float-btn" onclick="Settings.open()" title="Settings">
                        <span class="material-icons-round" style="color:#10b981">settings</span>
                    </button>
                    <button class="float-btn" onclick="QRScanner.open()" title="Scan QR Code">
                        <span class="material-icons-round" style="color:#6366f1">qr_code_scanner</span>
                    </button>
                    <button class="float-btn" onclick="Sidebar.toggle()" title="Menu">
                        <span class="material-icons-round">menu</span>
                    </button>
                </div>
                <button id="toggle-ctrls-btn" class="float-btn primary" onclick="UIInteractions.toggleExtraCtrls()"
                    title="Collapse Toolbar" style="margin-top: 8px;">
                    <span class="material-icons-round">expand_more</span>
                </button>
            </div>

            <!-- Routing Station Pro Overlay -->
            <div id="routing-station-overlay" style="display:none; flex-direction:column;">
                <!-- Header Handle -->
                <div id="routing-header" style="flex:0 0 auto;">
                    <div id="routing-drag-handle"
                        style="padding:10px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e2e8f0; background:#f8fafc; cursor:move;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span class="material-icons-round" onclick="SpatialRouter.dumpDiagnostics()"
                                style="color:var(--primary); font-size:18px; cursor:help;"
                                title="Click for System Diagnostics (Console)">route</span>
                            <span
                                style="font-weight:700; font-size:13px; color:#1e293b; letter-spacing: -0.2px;">Routing
                                Station PRO</span>
                            <div id="sync-server-badge" class="sync-status-badge"
                                style="margin-left:8px; background:#fefce8; color:#ca8a04; border-color:#fde68a;">
                                <span style="font-size:8px;"> SYNC...</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:4px;">
                            <button onclick="event.stopPropagation(); SpatialRouter.toggleSize()" title="Minimize"
                                style="background:none; border:none; color:#94a3b8; cursor:pointer; padding:4px;">
                                <span class="material-icons-round" id="btn-minimize-icon"
                                    style="font-size:18px;">remove</span>
                            </button>
                            <button onclick="event.stopPropagation(); SpatialRouter.toggleUI()" title="Close"
                                style="background:none; border:none; color:#94a3b8; cursor:pointer; padding:4px;">
                                <span class="material-icons-round" style="font-size:18px;">close</span>
                            </button>
                        </div>
                    </div>

                    <!-- TAB NAVIGATION -->
                    <div class="v6-tabs" style="border-bottom:1px solid #e2e8f0; background:white; flex: 0 0 auto;">
                        <button onclick="SpatialRouter.switchTab('editor')" id="tab-editor"
                            class="v6-tab active">EDITOR</button>
                        <button onclick="SpatialRouter.switchTab('manager')" id="tab-manager"
                            class="v6-tab">ROUTES</button>
                    </div>

                    <!-- Unified Action Toolbar (Persistent) -->
                    <div id="routing-toolbar-row" class="v6-toolbar"
                        style="padding:4px 8px; display:flex; gap:4px; flex-wrap:wrap; border-bottom:1px solid #e2e8f0; background:#fff; flex: 0 0 auto;">
                        <button onclick="event.stopPropagation(); SpatialRouter.startDrawing('append')"
                            class="routing-tool-btn gated-tool" id="btn-draw-append"
                            title="Draw Area (Append to selection)">
                            <span class="material-icons-round">crop_square</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.startDrawing('new')"
                            class="routing-tool-btn gated-tool" id="btn-draw-fresh"
                            title="Start Fresh Area (Clear selection)">
                            <span class="material-icons-round">add_location_alt</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.clearActiveRoute()"
                            class="routing-tool-btn gated-tool" id="btn-clear-route" title="Clear Active Route & Map">
                            <span class="material-icons-round" style="color:#ef4444;">layers_clear</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.finishDrawing()"
                            class="routing-tool-btn" id="btn-finish-draw" title="Finish Drawing"
                            style="display:none; color:#10b981;">
                            <span class="material-icons-round">done</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.cancelDrawing()"
                            class="routing-tool-btn" id="btn-cancel-draw" title="Cancel Drawing"
                            style="display:none; color:#ef4444;">
                            <span class="material-icons-round">close</span>
                        </button>

                        <div style="width:1px; background:#e2e8f0; margin:0 2px;"></div>

                        <button onclick="event.stopPropagation(); SpatialRouter.selectAll()"
                            class="routing-tool-btn gated-tool" id="btn-select-all" title="Number All (by Survey ID)">
                            <span class="material-icons-round">checklist</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.deselectAll()"
                            class="routing-tool-btn gated-tool" id="btn-deselect-all" title="Remove All Numbers">
                            <span class="material-icons-round">deselect</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.toggleLock()"
                            class="routing-tool-btn gated-tool" id="btn-lock-seq" title="Lock/Unlock Sequence">
                            <span class="material-icons-round">lock_open</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.undo()"
                            class="routing-tool-btn gated-tool" id="btn-undo" title="Undo (up to 20)">
                            <span class="material-icons-round">undo</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.redo()"
                            class="routing-tool-btn gated-tool" id="btn-redo" title="Redo">
                            <span class="material-icons-round">redo</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.saveRoute(true)"
                            class="routing-tool-btn gated-tool" id="btn-save-as" title="Save As (Download)"
                            style="color:#64748b;">
                            <span class="material-icons-round">download</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.saveRoute(false)"
                            class="routing-tool-btn gated-tool" id="btn-save-sync" title="Quick Save (Sync Server)"
                            style="color:#16a34a;">
                            <span class="material-icons-round">save</span>
                        </button>

                        <div style="width:1px; background:#e2e8f0; margin:0 2px;"></div>

                        <button onclick="event.stopPropagation(); SpatialRouter.sortBySequenceNumber()"
                            class="routing-tool-btn gated-tool" id="btn-sort-seq" title="Sort by Sequence #">
                            <span class="material-icons-round">sort</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.sortByID('asc')"
                            class="routing-tool-btn gated-tool" id="btn-sort-id-asc" title="Sort ID Asc">
                            <span class="material-icons-round">arrow_upward</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.sortByID('desc')"
                            class="routing-tool-btn gated-tool" id="btn-sort-id-desc" title="Sort ID Desc">
                            <span class="material-icons-round">arrow_downward</span>
                        </button>

                        <div style="width:1px; background:#e2e8f0; margin:0 2px;"></div>

                        <button onclick="event.stopPropagation(); SpatialRouter.pickStart()"
                            class="routing-tool-btn gated-tool" id="btn-pick-start" title="Set Start Point">
                            <span class="material-icons-round" style="color:#10b981">flag</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.pickEnd()"
                            class="routing-tool-btn gated-tool" id="btn-pick-end" title="Set End Point">
                            <span class="material-icons-round" style="color:#ef4444">flag</span>
                        </button>

                        <div style="width:1px; background:#e2e8f0; margin:0 2px;"></div>

                        <button onclick="event.stopPropagation(); SpatialRouter.clear(true)"
                            class="routing-tool-btn gated-tool" id="btn-reset-all" title="Reset All"
                            style="color:#ef4444;">
                            <span class="material-icons-round">delete_sweep</span>
                        </button>
                    </div>
                </div> <!-- END routing-header correctly here -->


                <!-- Panels Container (The Content Area) -->
                <div id="v4-panels-container"
                    style="flex:1; overflow:hidden; background:white; display:flex; flex-direction:column; min-height: 0;">

                    <!-- EDITOR TAB PANEL (Pure Flex Layout) -->
                    <div id="routing-editor-panel"
                        style="display:flex; flex-direction:column; background:white; height:100%; width:100%; overflow:hidden;">

                        <!-- Header Area (Fixed Height) -->
                        <div style="flex:0 0 auto; background:white; border-bottom:1px solid #e2e8f0;">
                            <!-- Row 1: Manual Entry -->
                            <div style="padding:8px; background:#f8fafc; display:flex; gap:6px;">
                                <input type="text" id="manual-id-input" placeholder="Survey ID..."
                                    style="flex:1; padding:0 12px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px; height:34px; outline:none;"
                                    onkeydown="if(event.key === 'Enter') { SpatialRouter.addManualID(this.value); this.value = ''; }">
                                <button
                                    onclick="event.stopPropagation(); SpatialRouter.addManualID(document.getElementById('manual-id-input').value); document.getElementById('manual-id-input').value = '';"
                                    style="width:34px; height:34px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                                    <span class="material-icons-round" style="font-size:20px;">add</span>
                                </button>
                            </div>


                            <!-- Row 2: Stats Bar -->
                            <div id="route-stats"
                                style="display:none; padding:8px 12px; background:#eff6ff; border-bottom:1px solid #dbeafe; justify-content:space-between; align-items:center;">
                                <div id="route-count" style="font-size:12px; font-weight:700; color:#1e40af;">0 Items
                                </div>
                                <div style="display:flex; align-items:center; gap:6px;">
                                    <button onclick="event.stopPropagation(); SpatialRouter.moveInSequence(-1)"
                                        class="nav-mini-btn"><span
                                            class="material-icons-round">chevron_left</span></button>
                                    <span id="route-nav-text"
                                        style="font-size:11px; font-weight:700; color:var(--primary);">0/0</span>
                                    <button onclick="event.stopPropagation(); SpatialRouter.moveInSequence(1)"
                                        class="nav-mini-btn"><span
                                            class="material-icons-round">chevron_right</span></button>
                                </div>
                            </div>
                        </div>

                        <!-- Scrollable Content (Flex 1) -->
                        <div id="route-list-container" class="custom-scrollbar"
                            style="flex:1; position:relative; overflow-y:auto; background:#f1f5f9; pointer-events:auto; min-height: 0;">
                            <!-- Initial State -->
                            <div id="route-initial-state"
                                style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; color:#94a3b8; text-align:center; pointer-events:none; z-index:1;">
                                <span class="material-icons-round"
                                    style="font-size:48px; opacity:0.1; margin-bottom:12px;">map_draw</span>
                                <div style="font-size:13px; font-weight:600;">No active route</div>
                                <div style="font-size:11px; margin-top:4px;">Draw area / Add IDs</div>
                            </div>
                            <!-- Actual List -->
                            <div id="route-list" class="v6-list"
                                style="position:relative; z-index:2; padding-bottom: 20px;"></div>
                        </div>
                    </div>

                    <!-- MANAGER TAB PANEL -->
                    <div id="routing-manager-panel"
                        style="display:none; flex-direction:column; background:#f8fafc; height:100%; width:100%; overflow:hidden;">
                        <div
                            style="flex:0 0 auto; padding:8px; background:white; border-bottom:1px solid #e2e8f0; display:flex; flex-direction:column; gap:6px;">
                            <!-- Row 1: Selection + Clean + Sync -->
                            <div style="display:flex; align-items:center; gap:4px; flex-wrap:wrap;">
                                <button
                                    onclick="event.stopPropagation(); SpatialRouter.toggleSelectAllRoutes(true, 'export')"
                                    style="padding:3px 6px; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:4px; font-size:8px; font-weight:800; color:#64748b; cursor:pointer;"
                                    title="Select All Export">ALL X</button>
                                <button
                                    onclick="event.stopPropagation(); SpatialRouter.toggleSelectAllRoutes(false, 'export')"
                                    style="padding:3px 6px; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:4px; font-size:8px; font-weight:800; color:#64748b; cursor:pointer;"
                                    title="Deselect All Export">0 X</button>
                                <div style="width:1px; height:20px; background:#e2e8f0;"></div>
                                <button
                                    onclick="event.stopPropagation(); SpatialRouter.toggleSelectAllRoutes(true, 'display')"
                                    style="padding:3px 6px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:4px; font-size:8px; font-weight:800; color:#16a34a; cursor:pointer;"
                                    title="Select All Display">ALL D</button>
                                <button
                                    onclick="event.stopPropagation(); SpatialRouter.toggleSelectAllRoutes(false, 'display')"
                                    style="padding:3px 6px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:4px; font-size:8px; font-weight:800; color:#16a34a; cursor:pointer;"
                                    title="Deselect All Display">0 D</button>
                                <div style="flex:1;"></div>
                                <button onclick="event.stopPropagation(); SpatialRouter.loadRoutes(null, true)"
                                    style="padding:4px 8px; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:4px; color:#64748b; cursor:pointer; display:flex; align-items:center;"
                                    title="Sync Routes">
                                    <span class="material-icons-round" style="font-size:16px;">refresh</span>
                                </button>
                                <button onclick="event.stopPropagation(); SpatialRouter.clearMapDisplay()"
                                    style="padding:4px 8px; background:white; border:1px solid #fca5a5; border-radius:4px; color:#ef4444; cursor:pointer; display:flex; align-items:center; gap:3px; font-size:10px; font-weight:700;"
                                    title="Clear displayed routes from map">
                                    <span class="material-icons-round" style="font-size:14px;">layers_clear</span>Clean
                                </button>
                            </div>
                            <!-- Row 2: Display / Export -->
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:4px;">
                                <button onclick="event.stopPropagation(); SpatialRouter.batchLoadDisplay()"
                                    style="padding:6px; background:#f0fdf4; border:1px solid #16a34a; border-radius:5px; font-size:10px; font-weight:700; color:#16a34a; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:4px;"
                                    title="Display Selected">
                                    <span class="material-icons-round" style="font-size:14px;">visibility</span>Display
                                </button>
                                <button onclick="event.stopPropagation(); SpatialRouter.batchExport()"
                                    style="padding:6px; background:#eff6ff; border:1px solid #bfdbfe; border-radius:5px; font-size:10px; font-weight:700; color:#2563eb; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:4px;"
                                    title="Export Selected">
                                    <span class="material-icons-round" style="font-size:14px;">download</span>Export
                                </button>
                            </div>
                        </div>
                        <div id="route-manager-list" class="custom-scrollbar"
                            style="flex:1; overflow-y:auto; padding:8px; display:flex; flex-direction:column; gap:8px;">
                        </div>
                    </div>
                </div>

                <!-- Resize Grip -->
                <div id="routing-resize-handle">
                    <span class="material-icons-round"
                        style="font-size:14px; color:#64748b; transform: rotate(0deg); pointer-events:none;">south_east</span>
                </div>
            </div>

            <!-- Persistent List View -->
            <div id="list-view-stage">
                <div class="list-nav">
                    <div style="display:flex; gap:8px;">
                        <button onclick="ViewSwitcher.back()" class="gal-btn"
                            style="background:#f1f5f9; color:var(--text);" title="Back"><span
                                class="material-icons-round">arrow_back</span></button>
                        <button onclick="Sidebar.toggle()" class="gal-btn mobile-sidebar-toggle"
                            style="background:#eff6ff; color:var(--primary);" title="Filters"><span
                                class="material-icons-round">tune</span></button>
                    </div>
                    <div style="font-weight:700">Record <span id="lv-idx">1</span> of <span id="lv-total">0</span></div>
                    <div style="display:flex; gap:8px;">
                        <button onclick="ListView.prev()" class="gal-btn"
                            style="background:#f1f5f9; color:var(--text);"><span
                                class="material-icons-round">chevron_left</span></button>
                        <button onclick="ListView.next()" class="gal-btn"
                            style="background:#f1f5f9; color:var(--text);"><span
                                class="material-icons-round">chevron_right</span></button>
                        <button onclick="ViewSwitcher.toMap()" class="gal-btn"
                            style="background:var(--primary); color:white; margin-left:8px;" title="Go to Map"><span
                                class="material-icons-round">map</span></button>
                    </div>
                </div>
                <div class="record-card-container"
                    style="flex:1; position:relative; overflow:hidden; display:flex; flex-direction:column;">
                    <div id="lv-search-container"
                        style="position:relative; margin: 12px auto; width: 96%; max-width: 560px; z-index:1002;"></div>
                    <div id="lv-content" class="record-card"></div>
                </div>
            </div>
        </div>
        <!-- Modals & Overlays -->
        <div id="modal-stats"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:6000; align-items:center; justify-content:center; padding:20px;">
            <div
                style="background:white; border-radius:16px; width:100%; max-width:850px; height:90vh; display:flex; flex-direction:column;">
                <div
                    style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0" id="stats-title">Staff Workflow Leaderboard</h3>
                    <button onclick="Stats.close()" style="background:none; border:none; cursor:pointer;"><span
                            class="material-icons-round">close</span></button>
                </div>
                <div id="stats-body" class="stats-table-container" style="flex:1; overflow-y:auto; padding:0;"></div>
            </div>
        </div>

        <div id="modal-verify-bill"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center; padding:10px;">
            <div
                style="background:white; border-radius:16px; width:100%; max-width:1000px; height:90vh; display:flex; flex-direction:column; box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow:hidden;">
                <div
                    style="padding:16px 24px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; background:#fafafa;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span class="material-icons-round"
                            style="color:var(--primary); font-size:28px;">verified_user</span>
                        <div>
                            <h3 style="margin:0; font-size:18px;">Verify Bill Status</h3>
                            <div id="verify-psid-label" style="font-size:11px; color:#64748b; font-weight:700;">
                                EXTERNAL: SUTHRA PUNJAB</div>
                        </div>
                    </div>
                    <button onclick="BillVerifier.close()"
                        style="background:#f1f5f9; border:none; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer;"><span
                            class="material-icons-round">close</span></button>
                </div>
                <div style="flex:1; background:#f8fafc; position:relative;">
                    <div id="verify-loader"
                        style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:white; z-index:1;">
                        <span class="material-icons-round rotate"
                            style="font-size:48px; color:var(--primary); margin-bottom:12px;">sync</span>
                        <div style="font-weight:700; color:#64748b;">Loading Verification Portal...</div>
                    </div>
                    <iframe id="verify-iframe" src="" style="width:100%; height:100%; border:none;"
                        onload="document.getElementById('verify-loader').style.display='none'"></iframe>
                </div>
            </div>
        </div>

        <!-- Advanced Paid Dashboard Stage (v7.2.1) -->
        <div id="paid-dashboard-stage" class="admin-only">
            <div class="dashboard-header">
                <div style="display:flex; align-items:center; gap:16px;">
                    <button onclick="PaidBills.toggleSidebar()" class="gal-btn"
                        style="background:#f1f5f9; color:#64748b; width:40px; height:40px; border-radius:10px;"><span
                            class="material-icons-round">menu_open</span></button>
                    <div
                        style="background:#eff6ff; color:#2563eb; width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center;">
                        <span class="material-icons-round" style="font-size:24px;">analytics</span>
                    </div>
                    <div>
                        <h2 style="margin:0; font-size:18px;">Paid Analytics Hub</h2>
                        <div style="font-size:10px; color:#64748b; font-weight:700; margin-top:2px;">REAL-TIME RECOVERY
                            INSIGHTS</div>
                    </div>
                </div>
                <div style="display:flex; gap:12px;">
                    <button onclick="PaidBills.setType('domestic')" class="all-records-btn dash-type-btn"
                        data-type="domestic" style="background:#0ea5e9; box-shadow:0 4px 12px rgba(14,165,233,0.3);">
                        <span class="material-icons-round">home</span>
                        <span class="desktop-only">DOMESTIC</span>
                    </button>
                    <button onclick="PaidBills.setType('commercial')" class="all-records-btn dash-type-btn"
                        data-type="commercial" style="background:#f59e0b; box-shadow:0 4px 12px rgba(245,158,11,0.3);">
                        <span class="material-icons-round">business</span>
                        <span class="desktop-only">COMMERCIAL</span>
                    </button>
                    <button id="pb-all-records-btn" onclick="PaidBills.reset()" class="all-records-btn active">
                        <span class="material-icons-round" style="font-size:20px;">history</span>
                        <span class="desktop-only">ALL RECORDS</span>
                    </button>
                    <div style="display:flex; gap:8px;">
                        <button onclick="Sidebar.toggle()" class="gal-btn"
                            style="background:#f1f5f9; color:var(--primary); width:40px; height:40px; border-radius:10px;"
                            title="Filters"><span class="material-icons-round">tune</span></button>
                        <button onclick="PaidBills.close()" class="gal-btn"
                            style="background:#1e293b; color:white; width:40px; height:40px; border-radius:10px;"
                            title="Close"><span class="material-icons-round">close</span></button>
                    </div>
                </div>
            </div>

            <div class="dash-layout" id="dash-layout">
                <!-- Unified Dashboard Sidebar -->
                <div class="dash-sidebar" id="dash-sidebar">
                    <details open style="margin-bottom:16px;">
                        <summary>
                            <div class="panel-heading">
                                <span class="material-icons-round">location_on</span>
                                <span style="flex:1">Area Distribution</span>
                                <span class="material-icons-round chevron">expand_more</span>
                            </div>
                        </summary>
                        <div id="pb-uc-summary" class="analytics-list">
                            <!-- Dynamic Content -->
                        </div>
                    </details>

                    <details open>
                        <summary>
                            <div class="panel-heading">
                                <span class="material-icons-round">pie_chart</span>
                                <span style="flex:1">Categorical Split</span>
                                <span class="material-icons-round chevron">expand_more</span>
                            </div>
                        </summary>
                        <div id="pb-category-summary" class="analytics-list">
                            <!-- Dynamic Content -->
                        </div>
                    </details>
                </div>

                <!-- Main Content Central Pane -->
                <div class="dash-main-content">
                    <div class="dashboard-stats-grid">
                        <div class="dash-stat-card">
                            <div class="dash-stat-icon" style="background: #eff6ff; color: #2563eb;">
                                <span class="material-icons-round">payments</span>
                            </div>
                            <div class="dash-stat-info">
                                <div class="dash-stat-label">Filtered Amount</div>
                                <div id="pb-total-amount" class="dash-stat-value">Rs. 0</div>
                            </div>
                        </div>
                        <div class="dash-stat-card">
                            <div class="dash-stat-icon" style="background: #edfcf2; color: #059669;">
                                <span class="material-icons-round">history_edu</span>
                            </div>
                            <div class="dash-stat-info">
                                <div class="dash-stat-label">Bills Found</div>
                                <div id="pb-total-count" class="dash-stat-value">0</div>
                            </div>
                        </div>
                        <div class="dash-stat-card">
                            <div class="dash-stat-icon" style="background: #fff7ed; color: #ea580c;">
                                <span class="material-icons-round">query_stats</span>
                            </div>
                            <div class="dash-stat-info">
                                <div class="dash-stat-label">Avg Recovery</div>
                                <div id="pb-avg-amount" class="dash-stat-value">Rs. 0</div>
                            </div>
                        </div>
                    </div>

                    <div class="dash-filters">
                        <div class="dash-filter-item">
                            <label>Date From</label>
                            <input type="text" id="pb-date-start" placeholder="Start Date"
                                onchange="PaidBills.render()">
                        </div>
                        <div class="dash-filter-item">
                            <label>Date To</label>
                            <input type="text" id="pb-date-end" placeholder="End Date" onchange="PaidBills.render()">
                        </div>
                        <div class="dash-filter-item">
                            <label>City / Office</label>
                            <select id="pb-city" onchange="PaidBills.render()"></select>
                        </div>
                        <div class="dash-filter-item">
                            <label>Category</label>
                            <select id="pb-type" onchange="PaidBills.render()">
                                <option value="all">All Categories</option>
                            </select>
                        </div>
                        <div class="dash-filter-item">
                            <label>ID Status</label>
                            <select id="pb-id-status" onchange="PaidBills.render()">
                                <option value="all">Global (All IDs)</option>
                                <option value="deleted">Deleted IDs Only</option>
                                <option value="active">Active IDs Only</option>
                            </select>
                        </div>
                        <div class="dash-filter-item" style="flex:0 0 auto;">
                            <!-- Back Button -->
                            <button onclick="ViewSwitcher.exit()" class="gallery-btn"
                                style="width:40px; height:40px; background:white; border-radius:50%; box-shadow:0 4px 12px rgba(0,0,0,0.1); border:1px solid #e2e8f0; color:#334155; display:flex; align-items:center; justify-content:center;">
                                <span class="material-icons-round" style="font-size:20px;">arrow_back</span>
                            </button>
                            <button onclick="PaidBills.render()" class="apply-btn"
                                style="height:42px; background:#16a34a; border:none; box-shadow:0 4px 12px rgba(22,163,74,0.1); padding:0 20px; border-radius:10px; display:flex; align-items:center; gap:8px;">
                                <span class="material-icons-round" style="font-size:20px;">sync</span>
                                <span style="font-weight:700">Refresh</span>
                            </button>
                        </div>
                    </div>

                    <div class="paid-table-container">
                        <table class="paid-table">
                            <thead>
                                <tr>
                                    <th>Sr#</th>
                                    <th>Survey ID</th>
                                    <th>PSID</th>
                                    <th>City</th>
                                    <th>Month</th>
                                    <th>Office</th>
                                    <th>UC</th>
                                    <th>Category</th>
                                    <th>Due Amt</th>
                                    <th>Fine</th>
                                    <th>Channel</th>
                                    <th style="min-width:100px">Paid Date</th>
                                    <th>Paid Amt</th>
                                </tr>
                            </thead>
                            <tbody id="pb-table-body"></tbody>
                        </table>
                    </div>

                    <div class="dash-footer">
                        <div style="display:flex; align-items:center; gap:16px;">
                            <span>Rows: <select id="pb-rows-per-page" class="rows-per-page"
                                    onchange="PaidBills.setRows(this.value)">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select></span>
                            <span id="pb-record-range">Showing 0-0</span>
                        </div>
                        <div class="pagination-controls">
                            <button onclick="PaidBills.changePage(-1)" id="pb-prev" class="pagination-btn"><span
                                    class="material-icons-round">chevron_left</span></button>
                            <div id="pb-page-info" class="pagination-info">Page 1 of 1</div>
                            <button onclick="PaidBills.changePage(1)" id="pb-next" class="pagination-btn"><span
                                    class="material-icons-round">chevron_right</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Universal Search Modal (v6.0) -->
        <div id="modal-search" onclick="if(event.target===this) UniversalSearch.close()">
            <div class="search-container">
                <div class="search-input-wrapper">
                    <span class="material-icons-round" style="color:var(--primary); font-size:28px;">search</span>
                    <input type="text" id="universal-search-input" placeholder="Search across all records..."
                        oninput="UniversalSearch.handleInput(this.value)">
                    <button onclick="UniversalSearch.close()"
                        style="background:#f1f5f9; border:none; border-radius:50%; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                        <span class="material-icons-round" style="font-size:20px;">close</span>
                    </button>
                </div>
                <div class="search-categories"
                    style="display:flex; flex-wrap:wrap; gap:12px; padding:10px 20px; border-bottom:1px solid #f1f5f9; background:#fafafa;">
                    <label
                        style="display:flex; align-items:center; gap:6px; font-size:12px; font-weight:700; color:#64748b; cursor:pointer;"><input
                            type="checkbox" class="search-cat" data-field="id"> ID</label>
                    <label
                        style="display:flex; align-items:center; gap:6px; font-size:12px; font-weight:700; color:#64748b; cursor:pointer;"><input
                            type="checkbox" class="search-cat" data-field="psid"> PSID</label>
                    <label
                        style="display:flex; align-items:center; gap:6px; font-size:12px; font-weight:700; color:#64748b; cursor:pointer;"><input
                            type="checkbox" class="search-cat" data-field="name"> Name</label>
                    <label
                        style="display:flex; align-items:center; gap:6px; font-size:12px; font-weight:700; color:#64748b; cursor:pointer;"><input
                            type="checkbox" class="search-cat" data-field="addr"> Address</label>
                    <label
                        style="display:flex; align-items:center; gap:6px; font-size:12px; font-weight:700; color:#64748b; cursor:pointer;"><input
                            type="checkbox" class="search-cat" data-field="surveyor"> Surveyor</label>
                    <label
                        style="display:flex; align-items:center; gap:6px; font-size:12px; font-weight:700; color:#64748b; cursor:pointer;"><input
                            type="checkbox" class="search-cat" data-field="mcuc"> MC/UC</label>
                    <div style="width:1px; height:16px; background:#e2e8f0; margin:0 4px;"></div>
                    <label
                        style="display:flex; align-items:center; gap:6px; font-size:12px; font-weight:800; color:var(--primary); cursor:pointer;"
                        title="Limit search to currently active sidebar filters">
                        <input type="checkbox" id="search-local-toggle"
                            onchange="State.searchLocalOnly = this.checked; UniversalSearch.performSearch(document.getElementById('universal-search-input').value)">
                        Search within filters
                    </label>
                </div>
                <div class="search-dropdowns"
                    style="padding:15px 24px; display:flex; gap:12px; flex-wrap:wrap; border-bottom:1px solid #f1f5f9; background:#fff;">
                    <div id="search-tehsil" style="flex:1; min-width:140px;"></div>
                    <div id="search-mcuc" style="flex:1; min-width:140px;"></div>
                    <div id="search-surveyor" style="flex:1; min-width:140px;"></div>
                </div>
                <div id="search-results-list" class="search-results">
                    <div style="text-align:center; padding:40px; color:#94a3b8;">
                        <span class="material-icons-round"
                            style="font-size:48px; opacity:0.3; margin-bottom:8px;">manage_search</span>
                        <div>Type to search across all records...</div>
                    </div>
                </div>
                <div
                    style="padding:10px 20px; background:#f8fafc; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div id="search-count" style="font-size:11px; font-weight:700; color:#94a3b8;">0 RECORDS FOUND</div>
                    <div style="font-size:10px; color:#cbd5e1; font-weight:500;">PRESS ESC TO CLOSE</div>
                </div>
            </div>
        </div>

        <div id="modal-log"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:6500; align-items:center; justify-content:center; padding:20px;">
            <div
                style="background:white; border-radius:16px; width:100%; max-width:950px; max-height:90vh; display:flex; flex-direction:column; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
                <div class="modal-header"
                    style="padding:24px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; background: #fafafa; border-radius: 16px 16px 0 0;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span class="material-icons-round"
                            style="color:#8b5cf6; font-size:32px;">assignment_turned_in</span>
                        <div>
                            <h3 style="margin:0; font-size: 20px;">Performance</h3>
                            <div style="display:flex; align-items:center; gap:10px; margin-top:4px;">
                                <small id="log-subtitle" style="color:#64748b; font-weight:600;"></small>
                                <div style="height:12px; width:1px; background:#e2e8f0;"></div>
                                <small id="data-start" style="color:#94a3b8; font-size:11px;"></small>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div
                            style="display:flex; align-items:center; gap:8px; background:#fff; border:1px solid #e2e8f0; padding:4px 12px; border-radius:8px;">
                            <small style="font-weight:700; color:#64748b;">Attendance From:</small>
                            <input type="date" id="att-start-date" onchange="PerformanceLog.updateDate(this.value)"
                                style="border:none; font-family:inherit; font-weight:600; color:var(--primary); outline:none; cursor:pointer;">
                        </div>
                        <button onclick="PerformanceLog.close()"
                            style="background:#f1f5f9; border:none; border-radius: 50%; width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; cursor:pointer;"><span
                                class="material-icons-round">close</span></button>
                    </div>
                </div>
                <div id="log-body" class="stats-table-container" style="flex:1; overflow-y:auto; padding:0;"></div>
            </div>
        </div>

        <!-- QR Scanner Modal -->
        <div id="modal-qr"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:12000; flex-direction:column; align-items:center; justify-content:center;">
            <div style="position:absolute; top:20px; right:20px; z-index:12001;">
                <button onclick="QRScanner.close()"
                    style="background:rgba(255,255,255,0.2); border:none; color:white; width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                    <span class="material-icons-round" style="font-size:32px">close</span>
                </button>
            </div>
            <div style="width:100%; max-width:500px; padding:20px;">
                <div id="qr-reader"
                    style="width:100%; border-radius:16px; overflow:hidden; border:2px solid rgba(255,255,255,0.3);">
                </div>
                <div style="text-align:center; color:white; margin-top:20px; font-weight:600;">Point camera at Survey ID
                    QR Code</div>
            </div>
        </div>

        <div id="gallery" class="gallery-overlay">
            <div class="gal-header"
                style="padding: 20px 30px; display: flex; justify-content: flex-end; align-items: center; gap: 24px;">
                <div id="gal-counter"
                    style="color:white; font-weight:700; background:rgba(255,255,255,0.1); padding:8px 18px; border-radius:30px; font-size:15px; backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    1 / 1</div>
                <button onclick="Gallery.close()"
                    style="background:none; border:none; color:white; cursor:pointer; display:flex; align-items:center; opacity:0.8; transition:opacity 0.2s;"><span
                        class="material-icons-round" style="font-size:42px">close</span></button>
            </div>
            <div class="gal-viewport" id="gal-vp">
                <img id="gal-img" class="gal-img" style="cursor: default;">
            </div>
            <div class="gal-controls">
                <button class="gal-btn" onclick="Gallery.rotate()" title="Rotate (R)"><span
                        class="material-icons-round">rotate_right</span></button>
                <button class="gal-btn" onclick="Gallery.zoomOut()" title="Zoom Out (-)"><span
                        class="material-icons-round">remove</span></button>
                <button class="gal-btn" onclick="Gallery.reset()" title="Reset Screen"><span
                        class="material-icons-round">refresh</span></button>
                <button class="gal-btn" onclick="Gallery.zoomIn()" title="Zoom In (+)"><span
                        class="material-icons-round">add</span></button>
            </div>
        </div>



        <div id="modal-settings" onclick="if(event.target===this) Settings.close()"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:7000; align-items:center; justify-content:center; padding:20px; backdrop-filter: blur(4px);">
            <div
                style="background:white; border-radius:16px; width:100%; max-width:640px; height: 600px; display:flex; flex-direction:column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); overflow: hidden;">
                <div
                    style="padding:20px 24px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; background: #fafafa;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span class="material-icons-round"
                            style="color:#10b981; font-size:28px;">settings_suggest</span>
                        <h3 style="margin:0; font-size: 18px; font-weight: 800; letter-spacing: -0.5px;">Advanced
                            Settings</h3>
                    </div>
                    <button onclick="Settings.close()"
                        style="background:#f1f5f9; border:none; border-radius: 50%; width: 36px; height: 36px; display:flex; align-items:center; justify-content:center; cursor:pointer; color: #64748b;">
                        <span class="material-icons-round" style="font-size: 20px;">close</span>
                    </button>
                </div>
                <div id="settings-layers-container"
                    style="flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative;">
                    <!-- Populated by JS (Stats, Marker Limit, and KML Tabs) -->
                </div>
            </div>
        </div>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

        <script>
            // Global Data Placeholders
            window.RAW_DATA = [];
            window.DATA_CHUNKS_COUNT = 10;
            window.PAID_DATA = [];
            window.HIERARCHY = {};
            window.GEO_LAYERS = {};
            window.ROLES = {};
            window.USER = null;

            // Supabase Config
            const SUPABASE_URL = "https://ipegpbgcektdtbnfvhvc.supabase.co";
            const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZWdwYmdjZWt0ZHRibmZ2aHZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwOTYzNjMsImV4cCI6MjA4MDY3MjM2M30.FHe6qYLmqvvTjRbKQQqHWNpsDbCBCeT9hPMgnAyE2bE";
            window._supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // Simple JWT Decoder
            function parseJwt(token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(jsonPayload);
                } catch (e) { return null; }
            }

            // PII Decoder (v7.6) - Removed Base64 to fix Urdu encoding symbols
            function decodePII(val) {
                if (!val || val === '-') return val;
                return val; // Directly return raw value handled by JSON.parse
            }

            async function handleCredentialResponse(response) {
                const payload = parseJwt(response.credential);
                if (!payload) return showError("Invalid login token.");

                const status = document.getElementById('auth-status');
                status.innerHTML = `<span style="color:#2563eb;">Verifying access for ${payload.email}...</span>`;

                try {
                    // Fetch Roles Database
                    const rolesRes = await fetch('roles.json');
                    if (!rolesRes.ok) throw new Error("Could not load roles database.");
                    const roles = await rolesRes.json();

                    const isAuthorized = roles.admins.includes(payload.email) || roles.field_staff.includes(payload.email);
                    if (!isAuthorized) throw new Error("Unauthorized User Email.");

                    const role = roles.admins.includes(payload.email) ? 'admin' : 'staff';

                    // Success!
                    window.USER = {
                        email: payload.email,
                        role: role,
                        name: payload.given_name || payload.name.split(' ')[0],
                        picture: payload.picture
                    };
                    sessionStorage.setItem('auth_token', response.credential);

                    document.getElementById('login-overlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('login-overlay').style.display = 'none', 500);

                    await loadData();
                    Auth.updateUI();

                } catch (e) {
                    showError(e.message);
                }
            }

            function showError(msg) {
                const status = document.getElementById('auth-status');
                status.innerHTML = `<span style="color:#ef4444;">${msg}</span>`;
            }

            async function checkSession() {
                const token = sessionStorage.getItem('auth_token');
                if (token) {
                    const payload = parseJwt(token);
                    if (payload && payload.exp * 1000 > Date.now()) {
                        handleCredentialResponse({ credential: token });
                        return true;
                    }
                }
                return false;
            }

            const Auth = {
                logout() {
                    if (confirm("Are you sure you want to Logout?")) {
                        sessionStorage.removeItem('auth_token');
                        window.location.reload();
                    }
                },
                toggle() {
                    const badge = document.getElementById('user-session');
                    if (badge) badge.classList.toggle('expanded');
                },
                updateUI() {
                    if (!window.USER) return;
                    const badge = document.getElementById('user-session');
                    const nameEl = document.getElementById('sess-name');
                    const roleEl = document.getElementById('sess-role');
                    const picEl = document.getElementById('sess-pic');
                    const fallbackEl = document.getElementById('sess-avatar-fallback');

                    if (badge) {
                        badge.style.display = 'flex';
                        nameEl.innerText = window.USER.name;
                        roleEl.innerText = window.USER.role;

                        if (window.USER.picture) {
                            picEl.src = window.USER.picture;
                            picEl.style.display = 'block';
                            fallbackEl.style.display = 'none';
                        }
                    }

                    // Apply Role-Based Gating
                    if (window.USER.role === 'staff') {
                        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                    } else {
                        document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
                    }

                    // Device Gating (Desktop Only)
                    if (window.innerWidth <= 768) {
                        document.querySelectorAll('.desc-only').forEach(el => el.style.display = 'none');
                    } else if (window.USER.role === 'admin') {
                        // For Admins on Desktop, show routing panel minimized by default if no active route
                        if (window.SpatialRouter && window.SpatialRouter.sequence.length === 0) {
                            const overlay = document.getElementById('routing-station-overlay');
                            if (overlay && overlay.style.display === 'none') {
                                SpatialRouter.toggleUI(); // This will show it
                                SpatialRouter.toggleSize ? SpatialRouter.toggleSize(true) : null; // Force minimize if method exists
                            }
                        }
                    }
                }
            };

            async function loadData() {
                if (!window.USER) return; // Prevent premature loading

                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'initial-loader';
                loadingOverlay.style.cssText = 'position:fixed; inset:0; background:#fff; z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:sans-serif;';
                loadingOverlay.innerHTML = '<div style="font-size:24px; font-weight:bold; margin-bottom:20px; color:#2563eb;">Loading Map Data...</div><div class="loader" style="width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; animation:spin 1s linear infinite;"></div><div id="loader-status" style="margin-top:20px; color:#64748b;">Initializing...</div><style>@keyframes spin {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}}</style>';
                document.body.appendChild(loadingOverlay);

                const status = document.getElementById('loader-status');

                try {
                    const fetchJSON = async (url, label) => {
                        status.innerText = `Loading ${label}...`;
                        const res = await fetch(url);
                        if (!res.ok) throw new Error(`Failed to load ${label}`);
                        return await res.json();
                    };

                    const chunkCount = window.DATA_CHUNKS_COUNT || 1;
                    const dataPromises = [];
                    for (let i = 1; i <= chunkCount; i++) {
                        dataPromises.push(fetchJSON(`data_part${i}.json`, `Survey Records (Part ${i}/${chunkCount})`));
                    }

                    const [dataChunks, paidData, hierarchyData, geoLayers] = await Promise.all([
                        Promise.all(dataPromises),
                        fetchJSON('paid_data.json', 'Payment Data'),
                        fetchJSON('hierarchy.json', 'Locations'),
                        fetchJSON('geo_layers.json', 'Map Layers')
                    ]);

                    const rawData = [].concat(...dataChunks);

                    // Build O(1) lookup index and decode PII
                    window.SID_MAP = new Map();
                    window.RAW_DATA = rawData.map(r => {
                        r[4] = decodePII(r[4]); // Name
                        r[5] = decodePII(r[5]); // Address
                        r[15] = decodePII(r[15]); // PSID
                        // STRICT STRING KEY GENERATION
                        const key = String(r[0]).trim();
                        window.SID_MAP.set(key, r);
                        return r;
                    });

                    window.PAID_DATA = paidData;
                    window.HIERARCHY = hierarchyData;
                    window.GEO_LAYERS = geoLayers;

                    status.innerText = 'Starting Application...';
                    setTimeout(() => {
                        loadingOverlay.remove();
                        window.APP_DATA_LOADED = true;
                        if (window.App && window.App.init) {
                            window.App.init();
                            Auth.updateUI();
                        } else {
                            console.log("Waiting for App logic to parse...");
                        }
                    }, 500);

                } catch (e) {
                    console.error(e);
                    status.innerText = `Error: ${e.message}`;
                    status.style.color = '#ef4444';
                    status.innerHTML += '<br><button onclick="location.reload()" style="margin-top:10px; padding:8px 16px;">Retry</button>';
                }
            }

            // Start Auth Check
            window.addEventListener('DOMContentLoaded', async () => {
                if (!await checkSession()) {
                    // Show Login
                    document.getElementById('login-overlay').style.display = 'flex';
                }
            });
        </script>


        <script>
            // Safety check for injected data
            if (typeof GEO_LAYERS === 'undefined') window.GEO_LAYERS = {};
            if (typeof RAW_DATA === 'undefined') window.RAW_DATA = [];
            if (typeof PAID_DATA === 'undefined') window.PAID_DATA = [];
            if (typeof HIERARCHY === 'undefined') window.HIERARCHY = {};



            const State = {
                savedRoutes: [{ "name": "MC-19_Route_1", "sequence": [{ "surveyId": "3345938", "lat": 32.0706314, "lng": 72.6524629, "name": "Arshad" }, { "surveyId": "3345941", "lat": 32.0706588, "lng": 72.6524359, "name": "M Abubakar" }, { "surveyId": "3345943", "lat": 32.0706871, "lng": 72.6526133, "name": "Sheikh M Akbar" }, { "surveyId": "3345946", "lat": 32.0707709, "lng": 72.6527936, "name": "M yameen" }, { "surveyId": "3346145", "lat": 32.0707591, "lng": 72.652665, "name": "Qasim" }, { "surveyId": "3346146", "lat": 32.0707407, "lng": 72.6526073, "name": "M Rasheed" }, { "surveyId": "3346147", "lat": 32.0706885, "lng": 72.6527502, "name": "Ahsan" }, { "surveyId": "3347388", "lat": 32.0712426, "lng": 72.6521187, "name": "Waheed" }, { "surveyId": "3347390", "lat": 32.070902, "lng": 72.6522857, "name": "Sah" }, { "surveyId": "3347391", "lat": 32.0714374, "lng": 72.6518701, "name": "Nasreen akhtar" }, { "surveyId": "3347925", "lat": 32.0709523, "lng": 72.6523858, "name": "M Imtiaz" }, { "surveyId": "3347926", "lat": 32.070931, "lng": 72.6523771, "name": "Baga" }, { "surveyId": "3347927", "lat": 32.0708823, "lng": 72.652295, "name": "Mistry Sattar" }, { "surveyId": "3347928", "lat": 32.0708908, "lng": 72.6521914, "name": "Shan Ali" }, { "surveyId": "3347929", "lat": 32.070852, "lng": 72.6522248, "name": "Asghar Ali" }, { "surveyId": "3347930", "lat": 32.0707314, "lng": 72.6521734, "name": "Tasawar" }], "polygon": [[32.07130958163572, 72.65154007997145], [32.07157778007802, 72.65193168248763], [32.070732270455245, 72.65291873540511], [32.07041406588422, 72.65253249730696], [32.07063226342366, 72.65195850457778]], "timestamp": "20/02/2026, 3:01:45 pm" }, { "name": "MC-19_Route_2", "sequence": [{ "surveyId": "3345948", "lat": 32.0708217, "lng": 72.6529338, "name": "Zulfiqar Ali" }, { "surveyId": "3345950", "lat": 32.0708326, "lng": 72.6529122, "name": "Abdul Shakoor" }, { "surveyId": "3345952", "lat": 32.0707276, "lng": 72.6529898, "name": "Shaffique" }, { "surveyId": "3345955", "lat": 32.0706651, "lng": 72.6532228, "name": "M Wahid" }, { "surveyId": "3346136", "lat": 32.0711363, "lng": 72.6531919, "name": "Aftab" }, { "surveyId": "3346137", "lat": 32.0710434, "lng": 72.6530042, "name": "Abid" }, { "surveyId": "3346140", "lat": 32.071018, "lng": 72.6529961, "name": "Asghar" }, { "surveyId": "3346143", "lat": 32.0710614, "lng": 72.653048, "name": "Rana munwar Hussain" }, { "surveyId": "3346144", "lat": 32.0710706, "lng": 72.6530304, "name": "Haji mushraf" }, { "surveyId": "3346148", "lat": 32.0707924, "lng": 72.6530061, "name": "M istkhar" }, { "surveyId": "3346149", "lat": 32.0707217, "lng": 72.6531081, "name": "Waqas" }, { "surveyId": "3346150", "lat": 32.0706768, "lng": 72.6531669, "name": "Zulfqar Ahmed" }, { "surveyId": "3346954", "lat": 32.0712937, "lng": 72.6528286, "name": "Yameen" }, { "surveyId": "3346955", "lat": 32.0710842, "lng": 72.6531524, "name": "Naveed" }, { "surveyId": "3346965", "lat": 32.0712747, "lng": 72.6527331, "name": "Shokat" }, { "surveyId": "3346966", "lat": 32.0710949, "lng": 72.6531694, "name": "Shabeer Ahmed" }, { "surveyId": "3346967", "lat": 32.0710839, "lng": 72.6531812, "name": "M Rafi" }, { "surveyId": "3346968", "lat": 32.0710315, "lng": 72.6532019, "name": "Shoaib" }, { "surveyId": "3346969", "lat": 32.0710008, "lng": 72.6532462, "name": "Tanveer" }, { "surveyId": "3346970", "lat": 32.0710233, "lng": 72.6532339, "name": "Amir" }, { "surveyId": "3347385", "lat": 32.0714542, "lng": 72.6529067, "name": "Irfan Ali" }, { "surveyId": "3347386", "lat": 32.071338, "lng": 72.6528576, "name": "Liaqat" }, { "surveyId": "3347387", "lat": 32.0709329, "lng": 72.6528621, "name": "Zeeshan" }, { "surveyId": "3347923", "lat": 32.0711197, "lng": 72.6526234, "name": "Afzal" }, { "surveyId": "3347924", "lat": 32.0715094, "lng": 72.6526736, "name": "Ghulam Rasool" }], "polygon": [[32.07134594757229, 72.6523232850038], [32.07052771050099, 72.65312794770827], [32.0706595380795, 72.65348736371627], [32.071491411174, 72.65297774400344], [32.0715959629948, 72.65242520894637]], "timestamp": "20/02/2026, 3:02:05 pm" }, { "name": "MC-19_Route_3", "sequence": [{ "surveyId": "3346128", "lat": 32.0713441, "lng": 72.6532456, "name": "Zahid" }, { "surveyId": "3346131", "lat": 32.0712453, "lng": 72.653227, "name": "M Wakeel" }, { "surveyId": "3346133", "lat": 32.0712055, "lng": 72.6532254, "name": "Kashif Maqbool" }, { "surveyId": "3346138", "lat": 32.0712401, "lng": 72.6532235, "name": "Abdul jabar Khan" }, { "surveyId": "3346141", "lat": 32.0712231, "lng": 72.6532037, "name": "M Ali Tahir" }, { "surveyId": "3346956", "lat": 32.0709764, "lng": 72.6533562, "name": "Rafique" }, { "surveyId": "3346957", "lat": 32.0709529, "lng": 72.6533823, "name": "Saleem" }, { "surveyId": "3346958", "lat": 32.0709407, "lng": 72.653399, "name": "Shahid" }, { "surveyId": "3346959", "lat": 32.0709262, "lng": 72.6534361, "name": "Zahid" }, { "surveyId": "3346960", "lat": 32.0709293, "lng": 72.6534176, "name": "M Boota" }, { "surveyId": "3346961", "lat": 32.0708789, "lng": 72.6535245, "name": "Ramzan" }, { "surveyId": "3346962", "lat": 32.070829, "lng": 72.6534968, "name": "M Akbar" }, { "surveyId": "3346963", "lat": 32.0707511, "lng": 72.6536805, "name": "Mazhar Hayat" }, { "surveyId": "3346964", "lat": 32.0707467, "lng": 72.6537327, "name": "Adeel" }, { "surveyId": "3346971", "lat": 32.0709046, "lng": 72.6534403, "name": "Ameer" }, { "surveyId": "3346972", "lat": 32.070807, "lng": 72.6534535, "name": "Arslan" }, { "surveyId": "3346973", "lat": 32.0708941, "lng": 72.6534105, "name": "Billa" }, { "surveyId": "3346974", "lat": 32.0708138, "lng": 72.6536204, "name": "Ali" }, { "surveyId": "3347381", "lat": 32.0716864, "lng": 72.6530125, "name": "M Iqbal" }, { "surveyId": "3347382", "lat": 32.0716999, "lng": 72.6530217, "name": "Haji Nawaz" }, { "surveyId": "3347383", "lat": 32.0716924, "lng": 72.6530124, "name": "Tayyab" }, { "surveyId": "3347384", "lat": 32.0716974, "lng": 72.653017, "name": "Rana Sajjad" }, { "surveyId": "3347916", "lat": 32.0716446, "lng": 72.6532294, "name": "Mukhtar" }, { "surveyId": "3347917", "lat": 32.0716235, "lng": 72.6532072, "name": "Kashif Nazeer" }, { "surveyId": "3347918", "lat": 32.0716037, "lng": 72.6531947, "name": "Mumtaz Tiwana" }, { "surveyId": "3347919", "lat": 32.0716443, "lng": 72.6529991, "name": "M Anwar" }, { "surveyId": "3347920", "lat": 32.071636, "lng": 72.6530552, "name": "Amjad Hussain" }, { "surveyId": "3347921", "lat": 32.0715979, "lng": 72.6530526, "name": "Shafqat Ali" }, { "surveyId": "3347922", "lat": 32.0715818, "lng": 72.6529173, "name": "Ata Muhammad" }], "polygon": [[32.07159141726595, 72.65274170961013], [32.07130958163572, 72.65314940538039], [32.07068681272717, 72.65349809255233], [32.07067317540434, 72.65388433065047], [32.07126866993976, 72.65334252442946], [32.07147777397117, 72.6532406004869], [32.071741426198756, 72.65328351583113], [32.07182324914928, 72.6529348286592]], "timestamp": "20/02/2026, 3:02:24 pm" }, { "name": "MC-19_Route_4", "sequence": [{ "surveyId": "3347915", "lat": 32.0719222, "lng": 72.6534634, "name": "Manzoor" }, { "surveyId": "3347380", "lat": 32.0720408, "lng": 72.6533898, "name": "M akhtar" }, { "surveyId": "3347979", "lat": 32.0719171, "lng": 72.6538394, "name": "Ali raza" }, { "surveyId": "3347909", "lat": 32.0718281, "lng": 72.653867, "name": "Amanat Ali" }, { "surveyId": "3347912", "lat": 32.0718661, "lng": 72.6538575, "name": "M Saeed" }, { "surveyId": "3347976", "lat": 32.0718572, "lng": 72.6538541, "name": "M Ali" }, { "surveyId": "3347914", "lat": 32.0718705, "lng": 72.6538535, "name": "Yaseen" }, { "surveyId": "3347977", "lat": 32.07186, "lng": 72.6538543, "name": "Umair Ali" }], "polygon": [[32.07195184998718, 72.65323698520662], [32.0721700438571, 72.65339791774751], [32.07187457286672, 72.65410065650941], [32.07170638126115, 72.65360176563264]], "timestamp": "20/02/2026, 3:28:00 pm" }, { "name": "MC-19_Route_5", "sequence": [{ "surveyId": "3347906", "lat": 32.0714196, "lng": 72.6540522, "name": "Mueez" }, { "surveyId": "3347907", "lat": 32.0713706, "lng": 72.6540763, "name": "Malik Naveed ul Hassan" }, { "surveyId": "3347970", "lat": 32.0714228, "lng": 72.6542199, "name": "Sheikh tswar" }, { "surveyId": "3347908", "lat": 32.0715047, "lng": 72.6541814, "name": "M aflaq" }, { "surveyId": "3347971", "lat": 32.0715472, "lng": 72.6542099, "name": "Malik gohar Abbas" }, { "surveyId": "3347960", "lat": 32.0715115, "lng": 72.6543546, "name": "Naveed" }, { "surveyId": "3347969", "lat": 32.0715248, "lng": 72.6543518, "name": "Zahid" }, { "surveyId": "3347965", "lat": 32.0714969, "lng": 72.6543902, "name": "Usman" }, { "surveyId": "3347964", "lat": 32.0714664, "lng": 72.6543783, "name": "Usman bhatti" }], "polygon": [[32.071565463731815, 72.65400946140291], [32.0717154727072, 72.65444934368135], [32.071401817296156, 72.65444934368135], [32.07121998757971, 72.65399336814882]], "timestamp": "20/02/2026, 3:28:26 pm" }],
                hideStandardTooltips: false,
                filtered: [],
                availableSurveyors: [],
                surveyorFilter: [],
                markers: L.layerGroup(),
                currentIdx: 0,
                map: null,
                markerLimit: 999999,
                payColorMode: false,
                syncedData: {}, // { surveyId: latestTimestamp }
                driveOnlyFilter: false,
                originView: 'map', // Track origin for navigation (map, dashboard)
                quickFilters: { domestic: true, commercial: true },
                lastHighlightedSurveyor: null,
                history: [], // [{ filtered, idx, label }] for back navigation
                searchLocalOnly: false, // Toggle for searching within current filters
                showTooltips: false, // User Preference for boundary layers
                kmlPane: null,

                // Battery Optimization: Dynamic marker limit based on device and selection
                getEffectiveMarkerLimit() {
                    const isDesktop = window.innerWidth > 768;
                    if (isDesktop) return this.markerLimit; // Unlimited on desktop

                    // Mobile: Check if MC/UC is selected
                    try {
                        const mcs = App.getSelectedMCUC ? App.getSelectedMCUC() : [];
                        if (mcs.length > 0) return this.markerLimit; // Allow all for selected MC/UC
                    } catch (e) { /* App not ready */ }

                    return 1500; // Safe cap for "All Areas" on mobile
                }
            };

            window.KML_META = { "MC1": "<b>MC-01 District</b><br>Primary Industrial Zone", "MC 2": "<b>MC-02 District</b><br>Residential Hub", "MC3": "<b>MC-03 District</b><br>Commercial Core" };

            const App = {
                toggleQuickFilter(key, e) {
                    if (e && e.target.tagName === 'INPUT') return; // Handled by change listener potentially, but better to unify here
                    State.quickFilters[key] = !State.quickFilters[key];
                    const checkbox = document.getElementById(`q-${key}`);
                    if (checkbox) {
                        checkbox.checked = State.quickFilters[key];
                        checkbox.closest('.multi-option').classList.toggle('selected', State.quickFilters[key]);
                    }
                    this.apply();
                },

                updateSidebarStatus() {
                    // Update selection counts (balloons) in filter headers
                    const updates = [
                        { id: 'f-dist', badgeId: 'badge-f-dist' },
                        { id: 'f-tehsil', badgeId: 'badge-f-tehsil' },
                        { id: 'f-mc', badgeId: 'badge-f-mc' },
                        { id: 'f-pay', badgeId: 'badge-f-pay' },
                        { id: 'f-surveyor', badgeId: 'badge-f-surveyor' },
                        { id: 'f-quick', badgeId: 'badge-f-quick' },
                        { id: 'f-drive', badgeId: 'badge-f-drive' }
                    ];

                    updates.forEach(upd => {
                        const badge = document.getElementById(upd.badgeId);
                        if (!badge) return;

                        let selected = 0;
                        let total = 0;

                        if (upd.id === 'f-quick') {
                            selected = Object.values(State.quickFilters).filter(v => v).length;
                            total = Object.values(State.quickFilters).length;
                        } else if (upd.id === 'f-drive') {
                            selected = document.getElementById('f-drive-only').checked ? 1 : 0;
                            total = 1;
                        } else {
                            selected = this.getSelected(upd.id).length;
                            total = this.getMultiSelectItems(upd.id).length;
                        }

                        if (upd.id === 'f-quick') {
                            const active = [];
                            if (State.quickFilters.domestic) active.push('Dom');
                            if (State.quickFilters.commercial) active.push('Com');

                            if (active.length === 2) {
                                badge.innerText = 'All';
                                badge.style.display = 'inline-block';
                            } else if (active.length === 1) {
                                badge.innerText = active[0];
                                badge.style.display = 'inline-block';
                            } else {
                                badge.style.display = 'none';
                            }
                            return;
                        }

                        if (selected > 0 && selected < total) {
                            badge.innerText = selected;
                            badge.style.display = 'inline-flex';
                            badge.style.background = '#eff6ff';
                            badge.style.color = '#2563eb';
                            badge.style.borderColor = '#dbeafe';
                        } else if (selected === total && total > 0) {
                            badge.innerText = 'All';
                            badge.style.display = 'inline-flex';
                            badge.style.background = '#edfcf2';
                            badge.style.color = '#059669';
                            badge.style.borderColor = '#bbf7d0';
                        } else {
                            badge.style.display = 'none';
                        }
                    });

                    // Update Paid History Count
                    const paidBadge = document.getElementById('badge-paid-count');
                    if (paidBadge && typeof PAID_DATA !== 'undefined') {
                        const count = Object.keys(PAID_DATA).length;
                        if (count > 0) {
                            paidBadge.innerText = count;
                            paidBadge.style.display = 'inline-flex';
                        } else {
                            paidBadge.style.display = 'none';
                        }
                    }
                },

                init() {
                    if (window.APP_INITIALIZED) return;
                    window.APP_INITIALIZED = true;
                    console.warn("GSI TROUBLESHOOTING: If you see 403 / Origin Not Allowed, ensure http://localhost:8000 is added as an Authorized JavaScript Origin in GCP console.");
                    State.raw_data = window.RAW_DATA;

                    // PERFORMANCE: Build SID_MAP for O(1) lookups if it doesn't exist
                    if (!window.SID_MAP && window.RAW_DATA) {
                        console.time("SID_MAP_INIT");
                        window.SID_MAP = new Map();
                        window.RAW_DATA.forEach(r => window.SID_MAP.set(String(r[0]), r));
                        console.timeEnd("SID_MAP_INIT");
                    }

                    this.initMap();
                    this.initFilters();
                    Sidebar.init();
                    InfoCard.init();
                    if (window.SpatialRouter) SpatialRouter.init();
                    if (typeof UniversalSearch !== 'undefined') UniversalSearch.init();
                    this.resetFilters();
                    this.apply(true); // Populate default view (Sargodha City) so map isn't empty on load

                    // Live Zoom Updates
                    State.map.on('zoomend', () => {
                        const el = document.getElementById('zoom-level-text');
                        if (el) el.innerText = `Z: ${State.map.getZoom()}`;
                    });
                    // Initial call
                    const el = document.getElementById('zoom-level-text');
                    if (el) el.innerText = `Z: ${State.map.getZoom()}`;

                    // Handle URL Params (QR Code Link)
                    setTimeout(() => this.handleUrlParams(), 1000);

                    // Background Fetch Synced Data
                    setTimeout(() => DriveSync.fetchAllSyncedData(), 2000);
                },

                handleUrlParams() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const sid = urlParams.get('sid');
                    if (sid) {
                        console.log("Found Survey ID in URL:", sid);

                        // FORCE RESET FILTERS TO "ALL"
                        // This ensures we search looking at the entire dataset, not just the default view.

                        // 1. Select All Districts, Tehsils, MCs
                        App.toggleAll('f-dist', true);
                        App.toggleAll('f-tehsil', true);
                        App.toggleAll('f-mc', true);

                        // 2. Clear Date Filters
                        this.clearDates();

                        // 3. Apply to update State.filtered
                        this.apply();

                        // Switch to List View
                        ViewSwitcher.toList();

                        // Wait for List to Populate (now with FULL data)
                        setTimeout(() => {
                            const searchInput = document.getElementById('lv-search-id');
                            if (searchInput) {
                                searchInput.value = sid;
                                ListView.render(); // This filters State.filtered by the search term

                                // Auto-select first result if exact match
                                setTimeout(() => {
                                    if (State.filtered.length > 0) {
                                        // Find record that exactly matches ID if possible
                                        const record = State.filtered.find(r => r[0].toString() === sid) || State.filtered[0];

                                        if (record) {
                                            ViewSwitcher.toMap();
                                            State.map.flyTo([record[1], record[2]], 19);

                                            // Open Popup
                                            setTimeout(() => {
                                                State.markers.eachLayer(layer => {
                                                    if (layer.options.id === sid.toString()) {
                                                        layer.openPopup();
                                                    }
                                                });
                                            }, 800);
                                        }
                                    }
                                }, 200);
                            }
                        }, 800);
                    }
                },

                resetFilters() {
                    State.surveyorFilter = [];
                    if (State.fpStart) State.fpStart.clear();
                    if (State.fpEnd) State.fpEnd.clear();

                    // Uncheck All for Payment status
                    this.toggleAll('f-pay', false);

                    // Reset quick filters to active
                    State.quickFilters = { urban: true, rural: true, domestic: true, commercial: true };
                    ['urban', 'rural', 'domestic', 'commercial'].forEach(key => {
                        const cb = document.getElementById(`q-${key}`);
                        if (cb) {
                            cb.checked = true;
                            cb.parentElement.classList.add('selected');
                        }
                    });

                    // Standard reset: Re-initialize to defaults (Sargodha City / Cantonment)
                    this.initFilters();

                    // NO MARKERS LOADED (as requested)
                    State.markers.clearLayers();
                    // State.filtered = []; // Removed to ensure default filters actually show markers
                    const countEl = document.getElementById('stat-count');
                    if (countEl) countEl.innerText = "0 / " + RAW_DATA.length;

                    // AUTO-ENABLE CANTONOMENT KML (as requested)
                    if (typeof LayerManager !== 'undefined' && typeof GEO_LAYERS !== 'undefined') {
                        const cantonmentKeys = [];
                        for (let city in GEO_LAYERS) {
                            for (let layerName in GEO_LAYERS[city]) {
                                if (layerName.toUpperCase().includes('CANTONMENT')) {
                                    cantonmentKeys.push(`${city}|${layerName}`);
                                }
                            }
                        }
                        if (cantonmentKeys.length > 0) {
                            LayerManager.load(cantonmentKeys);
                        }
                    }
                },

                setToday() {
                    // "Its sole purpose is to show today survey done"
                    // Ensure we clear ALL context to isolate today's records globally
                    this.toggleAll('f-dist', true);
                    this.toggleAll('f-tehsil', true);
                    this.toggleAll('f-mc', true);
                    this.toggleAll('f-pay', false);
                    this.toggleAll('f-drive', false);
                    const input = document.getElementById('lv-search-id');
                    if (input) input.value = '';

                    const now = new Date();
                    const y = now.getFullYear();
                    const m = String(now.getMonth() + 1).padStart(2, '0');
                    const d = String(now.getDate()).padStart(2, '0');
                    const todayStr = `${y}-${m}-${d}`;

                    if (State.fpStart) State.fpStart.setDate(todayStr, false);
                    if (State.fpEnd) State.fpEnd.setDate(todayStr, false);

                    this.apply();
                },

                clearDates() {
                    this.resetFilters();
                    // Re-apply to show default (Sargodha) view
                    this.apply();
                },

                initMap() {
                    State.map = L.map('map', {
                        zoomControl: false,
                        preferCanvas: false,
                        zoomAnimation: true,
                        fadeAnimation: true,
                        markerZoomAnimation: true,
                        inertia: true,
                        inertiaDeceleration: 3000,
                        updateWhenIdle: true
                    }).setView([32.0836, 72.6711], 13);

                    // Create a dedicated pane for KML layers to keep them below markers
                    State.map.createPane('kmlPane');
                    State.map.getPane('kmlPane').style.zIndex = 350;

                    // Create a dedicated pane for Routing polygons
                    State.map.createPane('routingPane');
                    State.map.getPane('routingPane').style.zIndex = 650;

                    // Create a dedicated pane for Routing markers to keep them above polygons
                    State.map.createPane('routingMarkerPane');
                    State.map.getPane('routingMarkerPane').style.zIndex = 660;

                    State.layers = {
                        roads: L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                            maxZoom: 20,
                            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                            keepBuffer: 6,
                            updateWhenIdle: true
                        }),
                        sat: L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                            maxZoom: 20,
                            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                            keepBuffer: 6,
                            updateWhenIdle: true
                        })
                    };

                    State.layers.roads.addTo(State.map);
                    State.activeLayer = 'roads';
                    // REMOVED Ghost Layer: State.markers.addTo(State.map); 
                    // This prevents markers from appearing twice and breaking clustering.
                },

                toggleLayer() {
                    const isRoads = State.activeLayer === 'roads';
                    State.map.removeLayer(State.layers[State.activeLayer]);
                    State.activeLayer = isRoads ? 'sat' : 'roads';
                    State.layers[State.activeLayer].addTo(State.map);

                    document.getElementById('layer-icon').innerText = isRoads ? 'map' : 'satellite_alt';
                },

                toggleControls() {
                    const grp = document.getElementById('extra-ctrls');
                    const btn = document.getElementById('toggle-ctrls').querySelector('.material-icons-round');
                    const isCollapsed = grp.classList.toggle('collapsed');
                    btn.innerText = isCollapsed ? 'keyboard_arrow_up' : 'keyboard_arrow_down';
                },

                toggleFilterGroup(el) {
                    const group = el.closest('.filter-group');
                    const isCollapsing = !group.classList.contains('collapsed');

                    // Accordion: Collapse all others
                    document.querySelectorAll('#sidebar .filter-group').forEach(g => {
                        if (g === group) return;
                        g.classList.add('collapsed');
                        g.classList.remove('active-group');
                    });

                    if (isCollapsing) {
                        group.classList.add('collapsed');
                        group.classList.remove('active-group');
                    } else {
                        group.classList.remove('collapsed');
                        group.classList.add('active-group');
                    }
                },

                initFilters() {
                    const dists = Object.keys(HIERARCHY).sort();
                    this.renderMultiSelect('f-dist', dists.map(d => ({ v: d, l: d })), 'onDistChange');

                    // Initial Load Defaults (Sargodha City + Cantonment)
                    if (HIERARCHY['SARGODHA']) {
                        this.setSelected('f-dist', ['SARGODHA']);
                    } else if (dists.length > 0) {
                        this.setSelected('f-dist', [dists[0]]);
                    }

                    this.onDistChange();

                    if (HIERARCHY['SARGODHA']?.['SARGODHA']) {
                        this.setSelected('f-tehsil', ['SARGODHA']);
                    }
                    this.onTehsilChange();

                    const mItems = this.getMultiSelectItems('f-mc');
                    const targetMC = mItems.find(item =>
                        item.value.toUpperCase().includes('CANTONMENT') ||
                        item.value.toUpperCase().includes('MC-1') ||
                        item.value.toUpperCase().includes('MC 1')
                    );
                    if (targetMC) {
                        this.setSelected('f-mc', [targetMC.value]);
                    }

                    // Init Flatpickr if not already
                    if (!State.fpStart) {
                        const config = {
                            dateFormat: "Y-m-d",
                            allowInput: true,
                            onChange: () => this.apply()
                        };
                        State.fpStart = flatpickr("#f-start", config);
                        State.fpEnd = flatpickr("#f-end", config);
                    }
                    this.updateSidebarStatus();
                },

                renderMultiSelect(id, items, onUpdate) {
                    const container = document.getElementById(id);
                    container.innerHTML = items.map(item => `
                <div class="multi-option" data-value="${item.v}" onclick="App.handleMultiClick(event, '${id}', '${onUpdate}')">
                    <input type="checkbox" ${item.selected ? 'checked' : ''} onchange="App.handleMultiChange(event, '${id}', '${onUpdate}')">
                    <span>${item.l}</span>
                </div>
            `).join('');
                },

                // Dedicated robust MC/UC multi-select using DOM API
                renderMCUCSelect(items) {
                    const container = document.getElementById('f-mc');
                    container.innerHTML = ''; // Clear existing

                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'multi-option';
                        div.setAttribute('data-value', item.v);
                        if (item.selected) div.classList.add('selected');

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = item.selected || false;
                        checkbox.addEventListener('change', function () {
                            div.classList.toggle('selected', this.checked);
                        });

                        const span = document.createElement('span');
                        span.textContent = item.l;

                        div.appendChild(checkbox);
                        div.appendChild(span);

                        checkbox.addEventListener('change', function (e) {
                            e.stopPropagation();
                            div.classList.toggle('selected', this.checked);
                            // Decoupled from App.apply() - Selection Only
                            App.updateSidebarStatus();
                        });

                        // Click on row toggles checkbox
                        div.addEventListener('click', function (e) {
                            if (e.target !== checkbox) {
                                checkbox.checked = !checkbox.checked;
                                div.classList.toggle('selected', checkbox.checked);
                                // Decoupled from App.apply() - Selection Only
                                App.updateSidebarStatus();
                            }
                        });

                        container.appendChild(div);
                    });
                },

                // Get selected MC/UC values
                getSelectedMCUC() {
                    const container = document.getElementById('f-mc');
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
                    return Array.from(checkboxes).map(cb =>
                        cb.closest('.multi-option').getAttribute('data-value')
                    );
                },


                handleMultiClick(e, id, onUpdate) {
                    if (e.target.tagName === 'INPUT') return;
                    const row = e.currentTarget;
                    const cb = row.querySelector('input');
                    cb.checked = !cb.checked;
                    row.classList.toggle('selected', cb.checked);
                    if (onUpdate && App[onUpdate]) App[onUpdate]();
                },

                handleMultiChange(e, id, onUpdate) {
                    const row = e.target.closest('.multi-option');
                    row.classList.toggle('selected', e.target.checked);
                    if (onUpdate && App[onUpdate]) App[onUpdate]();
                },

                toggleAll(id, state) {
                    if (id === 'f-quick') {
                        Object.keys(State.quickFilters).forEach(key => {
                            State.quickFilters[key] = state;
                        });
                        // Sync UI
                        ['urban', 'rural', 'domestic', 'commercial'].forEach(key => {
                            const cb = document.getElementById(`q-${key}`);
                            if (cb) {
                                cb.checked = state;
                                cb.closest('.multi-option').classList.toggle('selected', state);
                            }
                        });
                        this.apply();
                        return;
                    }

                    const container = document.getElementById(id);
                    const checkboxes = container.querySelectorAll('input');
                    checkboxes.forEach(cb => {
                        cb.checked = state;
                        cb.closest('.multi-option').classList.toggle('selected', state);
                    });

                    if (id === 'f-dist') this.onDistChange();
                    else if (id === 'f-tehsil') this.onTehsilChange();
                    else if (id === 'f-pay' || id === 'f-drive' || id === 'f-surveyor') this.apply();

                    this.updateSidebarStatus();
                },

                getSelected(id) {
                    const container = document.getElementById(id);
                    return Array.from(container.querySelectorAll('.multi-option'))
                        .filter(row => row.querySelector('input').checked)
                        .map(row => row.getAttribute('data-value'));
                },

                getMultiSelectItems(id) {
                    const container = document.getElementById(id);
                    return Array.from(container.querySelectorAll('.multi-option')).map(row => ({
                        value: row.getAttribute('data-value')
                    }));
                },

                setSelected(id, values) {
                    const container = document.getElementById(id);
                    container.querySelectorAll('.multi-option').forEach(row => {
                        const val = row.getAttribute('data-value');
                        const checked = values.includes(val);
                        row.querySelector('input').checked = checked;
                        row.classList.toggle('selected', checked);
                    });
                },

                onDistChange() {
                    const selectedDists = this.getSelected('f-dist');
                    let items = [];

                    selectedDists.forEach(d => {
                        const tehsils = Object.keys(HIERARCHY[d] || {}).sort();
                        tehsils.forEach(t => {
                            items.push({ v: t, l: `${d} - ${t}` });
                        });
                    });

                    this.renderMultiSelect('f-tehsil', items, 'onTehsilChange');
                    this.onTehsilChange();
                },
                onTehsilChange() {
                    const items = this.getAvailableMCUCs();
                    const currentlySelected = this.getSelectedMCUC();
                    items.forEach(item => {
                        item.selected = currentlySelected.includes(item.v);
                    });
                    this.renderMCUCSelect(items);
                    this.updateSidebarStatus();
                },

                getAvailableMCUCs() {
                    const selectedDists = this.getSelected('f-dist');
                    const selectedTehsils = this.getSelected('f-tehsil');
                    let items = [];

                    selectedDists.forEach(d => {
                        const distData = HIERARCHY[d] || {};
                        selectedTehsils.forEach(t => {
                            const tehsilData = distData[t] || {};
                            for (let m in tehsilData) {
                                items.push({
                                    v: m,
                                    l: `${t} - ${tehsilData[m].s}`,
                                    short: tehsilData[m].s
                                });
                            }
                        });
                    });

                    items.sort((a, b) => {
                        const aShort = a.short.toUpperCase();
                        const bShort = b.short.toUpperCase();
                        const aIsMC = aShort.startsWith('MC');
                        const bIsMC = bShort.startsWith('MC');
                        if (aIsMC && !bIsMC) return -1;
                        if (!aIsMC && bIsMC) return 1;
                        const aNum = parseInt(aShort.replace(/[^0-9]/g, '')) || 0;
                        const bNum = parseInt(bShort.replace(/[^0-9]/g, '')) || 0;
                        if (aNum !== bNum) return aNum - bNum;
                        return a.l.localeCompare(b.l);
                    });
                    return items;
                },

                updateSurveyors(highlightName = null) {
                    const container = document.getElementById('f-surveyor');
                    if (!container) return;

                    if (highlightName) State.lastHighlightedSurveyor = highlightName;
                    const activeHighlight = highlightName || State.lastHighlightedSurveyor;
                    const currentSelected = this.getSelected('f-surveyor');

                    // Contextual Sorting: 1. Highlighted (Active View), 2. Selected (Checked), 3. Alphabetical
                    const sortedList = [...State.availableSurveyors].sort((a, b) => {
                        if (a === activeHighlight) return -1;
                        if (b === activeHighlight) return 1;
                        const aSel = currentSelected.includes(a);
                        const bSel = currentSelected.includes(b);
                        if (aSel && !bSel) return -1;
                        if (!aSel && bSel) return 1;
                        return a.localeCompare(b);
                    });

                    container.innerHTML = sortedList.map(name => {
                        const isSelected = currentSelected.includes(name);
                        const isHighlighted = name === activeHighlight;
                        return `
                    <div class="multi-option ${isSelected ? 'selected' : ''} ${isHighlighted ? 'active-context' : ''}" 
                         data-value="${name}" onclick="App.handleMultiClick(event, 'f-surveyor', 'apply')">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="App.handleMultiChange(event, 'f-surveyor', 'apply')">
                        <span style="${isHighlighted ? 'font-weight:800; color:var(--primary);' : ''}">${name}</span>
                    </div>
                `;
                    }).join('');
                },

                setSurveyorFilter(selectedValues) {
                    // selectedValues is an array from multi-select
                    State.surveyorFilter = selectedValues.length > 0 ? selectedValues : [];
                    this.apply();
                    // If in list view, re-render implies updating the current view
                    if (document.getElementById('list-view-stage').classList.contains('active')) {
                        State.currentIdx = 0;
                        ListView.render();
                    }
                },

                apply(isInitial = false) {
                    // Routing Persistence: Exit route mode if user changes filters
                    if (State.originalFiltered && !isInitial) {
                        if (window.SpatialRouter) SpatialRouter.clear(true);
                    }

                    // Gather all filter criteria upfront
                    const dists = this.getSelected('f-dist');
                    const tehsils = this.getSelected('f-tehsil');
                    const mcs = this.getSelectedMCUC();
                    const pay = this.getSelected('f-pay');
                    const driveOnly = document.getElementById('f-drive-only')?.checked;
                    const start = document.getElementById('f-start')?.value || '';
                    const end = document.getElementById('f-end')?.value || '';
                    const surv = this.getSelected('f-surveyor');

                    const categories = [];
                    if (State.quickFilters.domestic) categories.push('domestic');
                    if (State.quickFilters.commercial) categories.push('commercial');

                    // PERFORMANCE: Single-pass filtering (was 8 sequential passes)
                    const result = [];
                    const availableSurvSet = new Set();

                    for (let i = 0; i < RAW_DATA.length; i++) {
                        const r = RAW_DATA[i];

                        // 1. Geography
                        if (dists.length && !dists.includes(r[10])) continue;
                        if (tehsils.length && !tehsils.includes(r[11])) continue;
                        if (mcs.length && !mcs.includes(r[12])) continue;

                        // 2. Dates
                        if (start || end) {
                            const dStr = r[7];
                            if (!dStr || dStr === 'NaT' || dStr === '-' || dStr === '0000-00-00') continue;
                            if (start && dStr < start) continue;
                            if (end && dStr > end) continue;
                        }

                        // 3. Payment
                        if (pay.length) {
                            const status = r[16].toLowerCase().replace(' ', '-');
                            if (!pay.includes(status)) continue;
                        }

                        // 4. Drive Sync
                        if (driveOnly && !State.syncedData[r[0]]) continue;

                        // 5. Category
                        if (categories.length > 0) {
                            const isCom = r[3] === 1;
                            const matchCom = isCom && categories.includes('commercial');
                            const matchDom = !isCom && categories.includes('domestic');
                            if (!matchCom && !matchDom) continue;
                        }

                        // Track available surveyors (before surveyor filter)
                        if (r[6]) availableSurvSet.add(r[6]);

                        // 6. Surveyor Filter (applied last)
                        if (surv.length && !surv.includes(r[6])) continue;

                        result.push(r);
                    }

                    State.filtered = result;
                    State.availableSurveyors = Array.from(availableSurvSet).sort();

                    if (!isInitial) State.currentIdx = 0;
                    State.payColorMode = pay.length > 0;

                    this.updateSidebarStatus();
                    this.updateSurveyors();
                    this.render();

                    if (!isInitial) {
                        if (window.innerWidth <= 768 && !document.getElementById('list-view-stage')?.classList.contains('active')) {
                            Sidebar.close();
                        }
                        if (!document.getElementById('list-view-stage')?.classList.contains('active')) {
                            ViewSwitcher.toMap();
                        }
                    }
                },

                render(limit = null) {
                    // 1. Initial Cleanup
                    if (State.markerLayer) {
                        State.map.removeLayer(State.markerLayer);
                    }

                    State.markers.clearLayers();
                    State.markerLayer = L.layerGroup();

                    // 2. Interaction State
                    const isRouterActive = (window.SpatialRouter && SpatialRouter.isRoutingPanelOpen());
                    const isRouting = isRouterActive;

                    State.markerLayer.addTo(State.map);

                    // 3. Statistics & Caps
                    // Priority: Always honor active filter (State.filtered). 
                    // Fallback to originalFiltered only if filtered is empty but we are in a routing session.
                    let dataPool = (State.filtered && State.filtered.length > 0)
                        ? State.filtered
                        : (isRouting && State.originalFiltered ? State.originalFiltered : []);

                    if (isRouting && (!State.originalFiltered || State.originalFiltered.length === 0)) {
                        console.log("[RENDER] Routing active - using current filtered pool.");
                    }

                    const totalCount = dataPool.length;
                    const effectiveLimit = limit || State.getEffectiveMarkerLimit();
                    const displayCount = Math.min(totalCount, effectiveLimit);
                    const data = dataPool.slice(0, effectiveLimit);

                    console.log(`[RENDER] Mode: ${isRouting ? 'Routing' : 'Normal'}, Pool: ${dataPool.length}, Display: ${data.length}`);

                    const countEl = document.getElementById('stat-count');
                    if (countEl) countEl.innerText = `${displayCount} / ${totalCount}`;

                    const labelEl = document.getElementById('stat-label');
                    if (labelEl) {
                        let labelHTML = "Total Survey";
                        const mcs = this.getSelectedMCUC ? this.getSelectedMCUC() : [];
                        const tehsils = this.getSelected ? this.getSelected('f-tehsil') : [];
                        const dists = this.getSelected ? this.getSelected('f-dist') : [];
                        if (mcs.length > 0) labelHTML = `Total Survey <span style="font-size:9px; font-weight:400; opacity:0.8; display:block;">(${mcs.length === 1 ? mcs[0] : mcs.length + ' Areas'})</span>`;
                        else if (tehsils.length > 0) labelHTML = `Total Survey <span style="font-size:9px; font-weight:400; opacity:0.8; display:block;">(${tehsils.length === 1 ? tehsils[0] : tehsils.length + ' Tehsils'})</span>`;
                        else if (dists.length > 0) labelHTML = `Total Survey <span style="font-size:9px; font-weight:400; opacity:0.8; display:block;">(${dists.length === 1 ? dists[0] : dists.length + ' Districts'})</span>`;
                        labelEl.innerHTML = labelHTML;
                    }

                    // 4. Rendering Loop
                    const bounds = L.latLngBounds();
                    let renderErrors = 0;

                    data.forEach((r, idx) => {
                        try {
                            if (!r || !r[1] || !r[2] || isNaN(r[1]) || isNaN(r[2])) return;

                            const status = (r[16] || 'unpaid').toLowerCase().replace(' ', '-');
                            let color = HIERARCHY?.[r[10]]?.[r[11]]?.[r[12]]?.c || '#2563eb';

                            if (State.payColorMode) {
                                if (status === 'paid') color = '#22c55e';
                                else if (status === 'unpaid') color = '#ef4444';
                                else color = '#94a3b8';
                            }

                            const m = L.circleMarker([r[1], r[2]], {
                                radius: 5,
                                fillColor: color,
                                color: 'rgba(0,0,0,0.6)',
                                weight: 1,
                                fillOpacity: 0.6,
                                id: r[0]?.toString()
                            });

                            // Bind Tooltip/Popup safely
                            m.bindTooltip(`${r[0]} | ${r[4] || 'Unknown'}<div class="tooltip-arrow"><div class="tooltip-arrow-stem"></div><div class="tooltip-arrow-tip"></div></div>`, {
                                permanent: false,
                                direction: 'top',
                                offset: [0, -10],
                                className: 'custom-tooltip'
                            });

                            m.bindPopup(() => {
                                let shortMC = 'MC-?';
                                if (r[12]) {
                                    const match = r[12].match(/(MC|UC)[- ]?(\d+)/i);
                                    shortMC = match ? `${match[1].toUpperCase()}-${match[2]}` : r[12].split(' ')[0];
                                }
                                const dateVal = r[7] && r[7] !== '-' ? r[7] : (r[18] && r[18] !== '-' ? r[18] : 'No Date');

                                return `
                            <div class="pop-card compact" style="position:relative; padding: 4px 8px; min-width: 140px; line-height: 1.2;">
                                <div style="display:flex; justify-content:space-between; font-weight:800; font-size:12px; border-bottom:1px solid #f1f5f9; margin-bottom:4px; padding-bottom:2px;">
                                    <a href="javascript:void(0)" onclick="ListView.jumpFromMap('${r[0]}')" style="color:var(--primary); text-decoration:none;">#${r[0]}</a>
                                    <span style="color:#64748b; font-size:10px; font-weight:400;">${r[6] || '--'}</span>
                                </div>
                                <div style="font-size:10px; color:#94a3b8; display:flex; justify-content:space-between; align-items:center;">
                                    <span>${dateVal} | ${r[8] || '--'}</span>
                                    <b style="color:#475569; font-family:monospace;">${shortMC}</b>
                                </div>
                            </div>
                        `;
                            }, { closeButton: false, offset: [0, -48] });

                            m.on('popupopen', () => m.closeTooltip());
                            m.on('popupclose', () => m.closeTooltip());

                            m.on('click', (e) => {
                                // Priority 1: Pickers (Start/End)
                                if (window.SpatialRouter && SpatialRouter.pickingMode) {
                                    L.DomEvent.stopPropagation(e);
                                    SpatialRouter.handleMarkerClick(r[0]);
                                    return;
                                }

                                // If drawing area, markers should NOT be interactive
                                if (window.SpatialRouter && SpatialRouter.isDrawing) return;

                                // If routing panel is open AND actively editing, clicking adds to pool
                                if (window.SpatialRouter && SpatialRouter.isRoutingPanelOpen() && SpatialRouter.isEditing) {
                                    SpatialRouter.addManualID(r[0]);
                                    return;
                                }
                                this.updateSurveyors(r[6]);
                                const sId = r[0]?.toString();
                                const sIdx = State.filtered.findIndex(record => record[0]?.toString() === sId);
                                if (sIdx !== -1) {
                                    State.currentIdx = sIdx;
                                    if (window.MapNavigator) MapNavigator.updateUI();
                                }
                            });

                            State.markers.addLayer(m);
                            m.addTo(State.markerLayer);
                            bounds.extend([r[1], r[2]]);

                        } catch (err) {
                            renderErrors++;
                            if (renderErrors < 5) console.error(`[RENDER ERROR] Record ${idx} (#${r?.[0]}):`, err);
                        }
                    });
                    if (renderErrors > 0) console.warn(`[RENDER] Completed with ${renderErrors} individual failures.`);

                    if (bounds.isValid()) {
                        const currentBounds = State.map.getBounds();
                        if (!currentBounds.contains(bounds.getSouthWest()) || !currentBounds.contains(bounds.getNorthEast())) {
                            State.map.fitBounds(bounds, { padding: [40, 40], maxZoom: 18 });
                        }
                    }
                    if (window.MapNavigator) MapNavigator.updateUI();
                    if (typeof ListView !== 'undefined' && document.getElementById('list-view-stage')?.classList.contains('active')) {
                        ListView.render();
                    }
                },

            };

            const ViewSwitcher = {
                toList(resetIdx = true) {
                    try {
                        document.getElementById('main-stage').classList.add('hide-map-ui');
                        document.getElementById('list-view-stage').classList.add('active');
                        const stage = document.getElementById('paid-dashboard-stage');
                        if (stage) stage.style.display = 'none';

                        // If we didn't come from dashboard, it's a map origin
                        if (State.originView !== 'dashboard') State.originView = 'map';

                        if (resetIdx) State.currentIdx = 0;
                        ListView.render();
                        document.getElementById('map').style.visibility = 'hidden';

                        setTimeout(() => {
                            if (State.map) State.map.invalidateSize();
                        }, 50);
                    } catch (e) { console.error("ViewSwitcher.toList failed:", e); }
                },
                toMap() {
                    document.getElementById('main-stage').classList.remove('hide-map-ui');
                    document.getElementById('list-view-stage').classList.remove('active');
                    document.getElementById('paid-dashboard-stage').style.display = 'none';
                    document.getElementById('map').style.visibility = 'visible';
                    State.originView = 'map';

                    // Immediate resize for responsive layout
                    if (State.map) State.map.invalidateSize();

                    // Delayed resize to ensure transitions are finished
                    setTimeout(() => {
                        if (State.map) State.map.invalidateSize();
                    }, 350);
                },
                toDashboard() {
                    document.getElementById('main-stage').classList.add('hide-map-ui');
                    document.getElementById('paid-dashboard-stage').style.display = 'flex';
                    document.getElementById('list-view-stage').classList.remove('active');
                    document.getElementById('map').style.visibility = 'hidden';
                    State.originView = 'dashboard';

                    // Only auto-close sidebar on mobile
                    if (window.innerWidth <= 768) Sidebar.close();
                },
                exit() {
                    // Aggressive exit: Clear history and go home
                    State.history = []; // Wipe history
                    this.back(); // Use back logic which now defaults to map/dashboard
                },
                back() {
                    // Priority 1: Check History Stack (Multi-level back)
                    if (State.history && State.history.length > 0) {
                        const prev = State.history.pop();
                        State.filtered = prev.filtered;
                        State.currentIdx = prev.idx;

                        // Clear search box on back
                        const input = document.getElementById('lv-search-id');
                        if (input) {
                            input.value = '';
                            ListView.toggleClearBtn ? ListView.toggleClearBtn('') : (document.getElementById('lv-search-clear').style.display = 'none');
                        }

                        // Restore Label
                        const statLabel = document.getElementById('stat-label');
                        if (statLabel && prev.label) statLabel.innerHTML = prev.label;
                        else if (statLabel && State.history.length === 0) statLabel.innerText = "Live Survey Data";

                        App.render();
                        if (window.MapNavigator) MapNavigator.updateUI();
                        return;
                    }

                    // Priority 2: Origin Fallback
                    if (State.originView === 'dashboard') {
                        this.toDashboard();
                    } else {
                        this.toMap();
                    }
                }
            };

            const ListView = {
                render() {
                    if (State.currentIdx >= State.filtered.length && State.filtered.length > 0) {
                        State.currentIdx = 0;
                    }
                    const r = State.filtered[State.currentIdx];
                    if (!r) {
                        document.getElementById('lv-content').innerHTML = `
                    <div style="text-align:center; padding:100px 20px; color:#94a3b8;">
                        <span class="material-icons-round" style="font-size:64px; opacity:0.2; display:block; margin-bottom:16px;">search_off</span>
                        <div style="font-weight:700; font-size:18px;">No Records Found</div>
                        <div style="font-size:14px; margin-top:8px;">Try adjusting your filters or use Global Search.</div>
                        <button onclick="UniversalSearch.open()" style="margin-top:24px; background:var(--primary); color:white; border:none; padding:12px 24px; border-radius:12px; font-weight:700; cursor:pointer;">Open Global Search</button>
                    </div>
                `;
                        return;
                    }

                    // 1. Initialize Search Bar if not present
                    const searchContainer = document.getElementById('lv-search-container');
                    if (searchContainer && !searchContainer.innerHTML) {
                        searchContainer.innerHTML = `
                    <div style="background:white; border-radius:15px; display:flex; align-items:center; padding:5px 15px; box-shadow:0 4px 15px rgba(0,0,0,0.08); border:1px solid #e2e8f0; gap:10px;">
                        <span class="material-icons-round" style="color:var(--primary); font-size:22px;">search</span>
                        <input type="text" id="lv-search-id" placeholder="Go to ID or Search..." 
                            style="flex:1; border:none; padding:10px 0; outline:none; font-weight:700; color:var(--text); font-size:14px;"
                            onkeydown="if(event.key==='Enter') ListView.jumpToID(this.value)"
                            oninput="ListView.toggleClearBtn(this.value)">
                        <button id="lv-search-clear" onclick="ListView.clearSearch()" style="display:none; background:none; border:none; color:#94a3b8; cursor:pointer;" title="Clear Search">
                            <span class="material-icons-round" style="font-size:20px;">cancel</span>
                        </button>
                        <button onclick="UniversalSearch.open()" style="background:none; border:none; color:#64748b; cursor:pointer; display:flex; align-items:center;" title="Global Search">
                            <span class="material-icons-round" style="font-size:22px;">travel_explore</span>
                        </button>
                    </div>
                `;
                    }

                    // Show clear button if input has value
                    setTimeout(() => {
                        const input = document.getElementById('lv-search-id');
                        if (input) ListView.toggleClearBtn(input.value);
                    }, 50);

                    // 2. Clear Label if coming back from restore
                    // Removed redundant label reset to prevent overwriting sidebar filters

                    const el = document.getElementById('lv-content');

                    document.getElementById('lv-idx').innerText = State.currentIdx + 1;
                    document.getElementById('lv-total').innerText = State.filtered.length;

                    // Integrity: Clear pending sync files when switching records
                    DriveSync.files = [];

                    // Surveyors are now unified in the sidebar
                    // No need to clear search container here

                    if (!r) {
                        el.innerHTML = `
                    <div class="card-header" style="display:flex; justify-content:center; align-items:center; height:200px;">
                        <div class="card-title" style="color:#64748b">No records match the current filters.</div>
                    </div>`;
                        return;
                    }

                    // Contextual Naming
                    const dists = App.getSelected('f-dist');
                    const tehsils = App.getSelected('f-tehsil');
                    let displayName = decodePII(r[4]);
                    if (tehsils.length > 1 || dists.length > 1) {
                        displayName += ` (${r[11]})`;
                    }

                    const paidCount = State.filtered.filter(rec => rec[16].toLowerCase() === 'paid').length;
                    const payStatus = r[16].toLowerCase().replace(' ', '-');
                    let totalPayable = r[20] ? r[20].toString().trim() : '0';
                    if (totalPayable.toLowerCase() === 'nan' || !totalPayable) totalPayable = '0';

                    el.innerHTML = `
                <div class="card-header" style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div style="flex:1; min-width:0; padding-right:12px;">
                        <div class="card-title" style="margin:0; line-height:1.1; font-size:18px;">Survey ID #${r[0]}</div>
                        <div style="display:flex; align-items:center; gap:6px; margin-top:2px;">
                            <div style="color:#64748b; font-weight:500; font-size:11px;">${r[6]} | ${r[7]} ${r[8]}</div>
                            ${(() => {
                            const seqIdx = window.SpatialRouter ? SpatialRouter.sequence.findIndex(p => String(p.id) === String(r[0])) : -1;
                            return seqIdx !== -1 ? `<span style="background:#3b82f6; color:white; font-size:9px; font-weight:800; padding:1px 6px; border-radius:10px; text-transform:uppercase;">Pos ${seqIdx + 1}</span>` : '';
                        })()}
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; flex-shrink:0; margin-top:2px; position:relative;">
                         <button onclick="ListView.showOnMap('${r[0]}')" title="Show on Map" style="background:#f1f5f9; color:var(--primary); border:1px solid #e2e8f0; border-radius:8px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s;">
                            <span class="material-icons-round" style="font-size:20px;">my_location</span>
                        </button>
                        <div id="lv-sort-btn-wrapper" style="position:relative;">
                            <button onclick="ListView.toggleSortDropdown()" title="Sort Records" style="background:#f1f5f9; color:var(--primary); border:1px solid #e2e8f0; border-radius:8px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s;">
                                <span class="material-icons-round" style="font-size:20px;">sort</span>
                            </button>
                            <div id="lv-sort-dropdown" style="display:none; position:absolute; right:0; top:42px; background:white; border:1px solid #e2e8f0; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.15); min-width:200px; z-index:1001; overflow:hidden;">
                                <div onclick="ListView.sort('id-desc')" style="padding:12px 16px; font-size:12px; font-weight:600; cursor:pointer; border-bottom:1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">ID (Newest First)</div>
                                <div onclick="ListView.sort('id-asc')" style="padding:12px 16px; font-size:12px; font-weight:600; cursor:pointer; border-bottom:1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">ID (Oldest First)</div>
                                <div onclick="ListView.sort('drive-desc')" style="padding:12px 16px; font-size:12px; font-weight:600; cursor:pointer; border-bottom:1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">Latest Drive Upload</div>
                                <div onclick="ListView.sort('status-paid')" style="padding:12px 16px; font-size:12px; font-weight:600; cursor:pointer; border-bottom:1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">Status (Paid First)</div>
                                <div onclick="ListView.sort('status-unpaid')" style="padding:12px 16px; font-size:12px; font-weight:600; cursor:pointer; border-bottom:1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">Status (Unpaid First)</div>
                                <div onclick="ListView.sort('status-not-billed')" style="padding:12px 16px; font-size:12px; font-weight:600; cursor:pointer;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">Status (Not Billed First)</div>
                            </div>
                        </div>
                        <button onclick="BillVerifier.open('${r[15]}')" title="Verify PSID" style="background:#dcfce7; color:#166534; border:1px solid #bbf7d0; border-radius:6px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                            <span class="material-icons-round" style="font-size:18px;">verified_user</span>
                        </button>
                         <button onclick="Sidebar.toggle()" title="Open Filters" style="background:#f1f5f9; color:var(--primary); border:1px solid #e2e8f0; border-radius:8px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s;">
                            <span class="material-icons-round" style="font-size:20px;">tune</span>
                        </button>
                    </div>
                </div>
                <div class="card-grid">
                    <!-- Row 1: Name, PSID, Status -->
                    <div style="grid-column: span 1;">
                        <div style="color:#2563eb; font-weight:800; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${decodePII(r[4])}">${decodePII(r[4])}</div>
                    </div>
                    <div style="grid-column: span 1;">
                        <div style="color:#2563eb; font-weight:800; font-size:14px;">${decodePII(r[15])}</div>
                    </div>
                    <div style="grid-column: span 1; text-align:right;">
                        <span class="pill ${payStatus}" style="font-size:11px; padding:2px 10px;">${r[16]}</span>
                    </div>

                    <!-- Row 2: UC Type, Consumer Type, Amount -->
                    <div style="grid-column: span 1;">
                        <div style="font-weight:600; font-size:13px; color:var(--text);">${r[14] || 'N/A'}</div>
                    </div>
                    <div style="grid-column: span 1;">
                        <div style="font-weight:600; font-size:13px; color:var(--text);">${r[3] === 1 ? 'Commercial' : 'Domestic'}</div>
                    </div>
                    <div style="grid-column: span 1; text-align:right;">
                        <div style="font-weight:800; font-size:14px; color:#ef4444;">Rs. ${totalPayable}</div>
                    </div>

                    <!-- Row 3: Address (Full Width) -->
                    <div style="grid-column: span 3; border-top:1px solid #f1f5f9; padding-top:8px;">
                        <div style="font-weight:600; font-size:13px; color:var(--text); line-height:1.4;">${decodePII(r[5])}</div>
                    </div>

                    <!-- Row 4: Area (Full Width) -->
                    <div style="grid-column: span 3; border-top:1px dashed #f1f5f9; padding-top:4px;">
                        <div style="font-weight:600; font-size:12px; color:#64748b;">${r[11]} - ${r[12]}</div>
                    </div>
                </div>
                
                <div class="card-gallery" id="gal-${r[0].toString().replace(/[^a-z0-9]/gi, '_')}">
                    ${r[9].map(url => `<img src="${url}" class="gallery-thumb" onclick="Gallery.open('${url}', '${r[0]}')">`).join('')}
                    <div id="synced-gallery-${r[0].toString().replace(/[^a-z0-9]/gi, '_')}" style="display:contents;"></div>
                </div>

                <!-- Modernized Sync Station (v4.2) -->
                <div class="sync-station">
                    <div class="sync-station-header">
                        <div class="sync-station-title">Google Drive Sync</div>
                        <div class="sync-status-badge" id="drive-status-${r[0].toString().replace(/[^a-z0-9]/gi, '_')}">Checking...</div>
                    </div>

                    <div class="sync-select-wrapper">
                        <select id="drive-email" onchange="DriveSync.saveEmail(this.value)">
                            <option value="">Loading Surveyors...</option>
                        </select>
                    </div>

                    <div id="drive-preview" class="sync-preview-strip"></div>

                    <input type="file" id="drive-input-camera" accept="image/*" capture="environment" multiple style="display:none" onchange="DriveSync.handleFiles(this.files)">
                    <input type="file" id="drive-input-gallery" accept="image/*" multiple style="display:none" onchange="DriveSync.handleFiles(this.files)">
                    <input type="file" id="local-cam-input" accept="image/*" capture="environment" style="display:none" onchange="LocalCam.handleCapture(this, '${r[0]}')">
                    
                    <div class="sync-action-grid">
                        <button onclick="document.getElementById('local-cam-input').click()" class="sync-action-btn" style="grid-column:span 2; background:#6366f1; color:white; border:none; box-shadow:0 4px 12px rgba(99,102,241,0.2);">
                            <span class="material-icons-round">camera_enhance</span> Local Camera (Save to Phone)
                        </button>
                        <button onclick="document.getElementById('drive-input-camera').click()" class="sync-action-btn camera">
                            <span class="material-icons-round">photo_camera</span> Camera (Drive)
                        </button>
                        <button onclick="document.getElementById('drive-input-gallery').click()" class="sync-action-btn gallery">
                            <span class="material-icons-round">photo_library</span> Upload Photos
                        </button>
                        <button id="btn-sync-drive" onclick="DriveSync.upload('${r[0]}')" class="sync-action-btn upload">
                            <span class="material-icons-round">cloud_upload</span> Sync Now
                        </button>
                    </div>
                </div>
            `;

                    // Post-render init for DriveSync (Email & Metadata)
                    setTimeout(() => {
                        DriveSync.init();
                        DriveSync.fetchMetadata(r[0]);
                    }, 10);
                },
                next() { if (State.currentIdx < State.filtered.length - 1) { State.currentIdx++; this.render(); } },
                prev() { if (State.currentIdx > 0) { State.currentIdx--; this.render(); } },

                jumpFromMap(id) {
                    ViewSwitcher.toList(false);

                    setTimeout(() => {
                        this.jumpToID(id);
                        const idx = State.filtered.findIndex(r => r[0].toString() === id.toString());
                        if (idx !== -1) {
                            State.currentIdx = idx;
                            if (window.MapNavigator) MapNavigator.updateUI();
                        }
                    }, 150);
                },


                showOnMap(id, isolate = true) {
                    const record = RAW_DATA.find(r => r[0].toString() === id.toString());
                    if (!record) return;

                    if (isolate) {
                        // State Preservation: Push current state to history stack
                        State.history.push({
                            filtered: [...State.filtered],
                            idx: State.currentIdx,
                            label: document.getElementById('stat-label').innerText
                        });

                        // Override Filters to show only this record
                        State.filtered = [record];
                        State.currentIdx = 0;
                        App.render();

                        // Update Label with Restore option
                        const statLabel = document.getElementById('stat-label');
                        if (statLabel) {
                            statLabel.innerHTML = `Isolated Mode <a href="javascript:void(0)" onclick="ViewSwitcher.back()" style="color:var(--primary); margin-left:8px; text-decoration:underline;">[Return]</a>`;
                        }
                    } else {
                        // Synchronization: update currentIdx by searching in the active collection (Route or Filtered)
                        const searchId = id.toString().trim();
                        const idx = State.filtered.findIndex(r => r[0].toString().trim() === searchId);

                        if (idx !== -1) {
                            State.currentIdx = idx;
                            if (window.MapNavigator) MapNavigator.updateUI();
                        }
                    }

                    ViewSwitcher.toMap();
                    State.map.flyTo([record[1], record[2]], 19);

                    setTimeout(() => {
                        // Priority: Routing markers (ensure we open the flag/square if it exists)
                        let opened = false;
                        if (window.SpatialRouter && SpatialRouter.sequenceLayer) {
                            SpatialRouter.sequenceLayer.eachLayer(layer => {
                                if (layer.options.id === id.toString()) {
                                    layer.openPopup();
                                    opened = true;
                                }
                            });
                        }

                        if (!opened) {
                            State.markers.eachLayer(layer => {
                                if (layer.options.id === id.toString()) {
                                    layer.openPopup();
                                }
                            });
                        }

                        // Ensure pager appears when house is shown on map
                        if (window.MapNavigator) MapNavigator.show();
                    }, 1100); // FlyTo completion buffer
                },

                restoreView() {
                    ViewSwitcher.back();
                },

                toggleSortDropdown() {
                    const dd = document.getElementById('lv-sort-dropdown');
                    if (!dd) return;
                    dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
                },

                sort(criteria) {
                    if (criteria === 'id-desc') State.filtered.sort((a, b) => b[0] - a[0]);
                    else if (criteria === 'id-asc') State.filtered.sort((a, b) => a[0] - b[0]);
                    else if (criteria === 'status-paid') {
                        State.filtered.sort((a, b) => {
                            const sA = a[16].toLowerCase(), sB = b[16].toLowerCase();
                            if (sA === 'paid' && sB !== 'paid') return -1;
                            if (sA !== 'paid' && sB === 'paid') return 1;
                            return 0;
                        });
                    } else if (criteria === 'status-unpaid') {
                        State.filtered.sort((a, b) => {
                            const sA = a[16].toLowerCase(), sB = b[16].toLowerCase();
                            if (sA === 'unpaid' && sB !== 'unpaid') return -1;
                            if (sA !== 'unpaid' && sB === 'unpaid') return 1;
                            return 0;
                        });
                    } else if (criteria === 'status-not-billed') {
                        State.filtered.sort((a, b) => {
                            const statusA = a[16].toLowerCase();
                            const statusB = b[16].toLowerCase();
                            if (statusA === 'not billed' && statusB !== 'not billed') return -1;
                            if (statusA !== 'not billed' && statusB === 'not billed') return 1;
                            return 0;
                        });
                    } else if (criteria === 'drive-desc') {
                        State.filtered.sort((a, b) => {
                            const tA = State.syncedData[a[0]] ? new Date(State.syncedData[a[0]]).getTime() : 0;
                            const tB = State.syncedData[b[0]] ? new Date(State.syncedData[b[0]]).getTime() : 0;
                            return tB - tA;
                        });
                    }
                    State.currentIdx = 0;
                    this.render();
                    document.getElementById('lv-sort-dropdown').style.display = 'none';
                },

                jumpToID(id) {
                    if (!id) return;
                    const searchId = id.toString().trim();

                    // Check current list first
                    const idx = State.filtered.findIndex(r => r[0].toString().trim() === searchId);

                    // Always push context before a search jump (even if in same list)
                    State.history.push({
                        filtered: [...State.filtered],
                        idx: State.currentIdx,
                        label: document.getElementById('stat-label').innerText
                    });

                    if (idx !== -1) {
                        State.currentIdx = idx;
                        this.render();
                        const statLabel = document.getElementById('stat-label');
                        if (statLabel) statLabel.innerHTML = `Linked ID Match <a href="javascript:void(0)" onclick="ViewSwitcher.back()" style="color:var(--primary); margin-left:8px; text-decoration:underline; font-size:10px;">[RETURN]</a>`;
                    } else {
                        const record = RAW_DATA.find(r => r[0].toString().trim() === searchId);
                        if (record) {
                            State.filtered = [record];
                            State.currentIdx = 0;
                            this.render();
                            const statLabel = document.getElementById('stat-label');
                            if (statLabel) statLabel.innerHTML = `Search Result <a href="javascript:void(0)" onclick="ViewSwitcher.back()" style="color:var(--primary); margin-left:8px; text-decoration:underline; font-size:10px;">[RETURN]</a>`;
                        } else {
                            // Pop history if search failed so we don't store a "failed jump" state
                            State.history.pop();
                            App.showToast ? App.showToast(`ID #${id} not found.`) : alert(`ID #${id} not found.`);
                        }
                    }
                    this.toggleClearBtn(searchId);
                },

                toggleClearBtn(val) {
                    const btn = document.getElementById('lv-search-clear');
                    if (!btn) return;
                    btn.style.display = (val || State.history.length > 0) ? 'block' : 'none';
                },

                clearSearch() {
                    const input = document.getElementById('lv-search-id');
                    if (input) input.value = '';
                    this.toggleClearBtn('');

                    // If we are in a search result/isolated view, go back
                    if (State.history.length > 0) {
                        ViewSwitcher.back();
                    }
                }
            };

            const Stats = {
                open() {
                    const dataByName = {};
                    State.filtered.forEach(r => {
                        const name = r[6];
                        if (!dataByName[name]) dataByName[name] = [];
                        dataByName[name].push(r);
                    });

                    // Sort staff by count
                    const sorted = Object.entries(dataByName).sort((a, b) => b[1].length - a[1].length);

                    // Dynamic Heading
                    const dists = App.getSelected('f-dist').join(', ') || 'All';
                    const tehsils = App.getSelected('f-tehsil').join(', ') || 'All';
                    document.getElementById('stats-title').innerHTML = `Staff Workflow Leaderboard: ${dists} (${tehsils}) <span style="margin-left:30px; font-size:0.9em; color:#475569;">Total: ${State.filtered.length}</span>`;

                    let html = `<table style="width:100%; border-collapse:collapse; font-size:12px; min-width:650px;">
                <thead style="background:#f8fafc; position:sticky; top:0; z-index:10;">
                    <tr>
                        <th style="padding:8px; text-align:center; width: 80px;">Count</th>
                        <th style="padding:8px; text-align:left;">Staff</th>
                        <th style="padding:8px; text-align:center;">Idle</th>
                        <th style="padding:8px; text-align:center;">First / Last</th>
                        <th style="padding:8px; text-align:center;">Status</th>
                    </tr>
                </thead>
                <tbody>`;

                    sorted.forEach(([name, records], i) => {
                        // Calculate Stats Dynamically for the filtered range
                        const sortedRecs = records.slice().sort((a, b) => a[8].localeCompare(b[8]));
                        const first = sortedRecs[0][8];
                        const last = sortedRecs[sortedRecs.length - 1][8];

                        let warn = 0, idle = 0;
                        const windowStart = "10:00:00";
                        const windowEnd = "17:00:00";
                        const shutdownCutoff = "16:55:00";

                        for (let j = 1; j < sortedRecs.length; j++) {
                            const t1 = sortedRecs[j - 1][8];
                            const t2 = sortedRecs[j][8];
                            if (t1 < windowStart || t1 > windowEnd) continue;

                            const d1 = new Date(`2000-01-01T${t1}`);
                            const d2 = new Date(`2000-01-01T${t2}`);
                            let diff = (d2 - d1) / 60000;

                            const lStart = new Date(`2000-01-01T13:00:00`);
                            const lEnd = new Date(`2000-01-01T14:00:00`);
                            const overlapStart = new Date(Math.max(d1, lStart));
                            const overlapEnd = new Date(Math.min(d2, lEnd));
                            if (overlapEnd > overlapStart) diff -= (overlapEnd - overlapStart) / 60000;

                            if (diff > 60) idle++;
                            else if (diff > 30) warn++;
                        }

                        // Tiered Trophies
                        let trophy = "";
                        if (i === 0) trophy = `<span class="trophy gold"></span>`;
                        else if (i === 1) trophy = `<span class="trophy silver"></span>`;
                        else if (i < 5) trophy = `<span class="trophy bronze"></span>`;

                        let statusMsg = '<span class="status-msg status-ok">Active</span>';
                        if (idle > 0) statusMsg = '<span class="status-msg status-idle">Idle!</span>';
                        else if (warn > 0) statusMsg = '<span class="status-msg status-warn">Delay</span>';

                        const countClass = records.length > 100 ? 'count-high' : '';
                        const idleClass = idle > 0 ? 'idle-danger' : (warn > 0 ? 'idle-warn' : '');
                        const lastClass = last < shutdownCutoff ? 'time-warning' : '';

                        html += `<tr class="rank-row" style="${i === 0 ? 'height: 60px;' : ''}">
                    <td style="padding:8px; text-align:center;">
                        <span class="count-badge ${countClass}">${records.length}</span>
                    </td>
                    <td style="padding:8px; font-weight:700;">${name}${trophy}</td>
                    <td style="padding:8px; text-align:center;" class="${idleClass}">${idle + warn}</td>
                    <td style="padding:8px; text-align:center; font-size:12px; color:#475569;">
                        <b>${first}</b><br><span class="${lastClass}">${last}</span>
                    </td>
                    <td style="padding:8px; text-align:center;">${statusMsg}</td>
                </tr>`;
                    });

                    html += `</tbody></table>`;
                    document.getElementById('stats-body').innerHTML = html;
                    document.getElementById('modal-stats').style.display = 'flex';
                },
                close() { document.getElementById('modal-stats').style.display = 'none'; }
            };

            const Gallery = {
                scale: 1, rot: 0,
                images: [], idx: 0,
                posX: 0, posY: 0,
                isDragging: false,
                startX: 0, startY: 0,

                open(src, surveyId) {
                    const safeId = surveyId.toString().replace(/[^a-z0-9]/gi, '_');
                    const galContainer = document.getElementById(`gal-${safeId}`);
                    if (galContainer) {
                        // Collect ALL images from the gallery container (original and synced)
                        const allThumbs = Array.from(galContainer.querySelectorAll('img'));
                        this.images = allThumbs.map(img => img.src);
                    } else {
                        const record = RAW_DATA.find(r => r[0] == surveyId);
                        this.images = record ? record[9] : [src];
                    }

                    this.idx = this.images.indexOf(src);
                    if (this.idx === -1) this.idx = 0;

                    this.updateImage();
                    document.getElementById('gallery').classList.add('active');

                    // Add Keyboard listeners
                    this._boundKeyHandler = (e) => this.handleKeys(e);
                    window.addEventListener('keydown', this._boundKeyHandler);
                },

                close() {
                    document.getElementById('gallery').classList.remove('active');
                    window.removeEventListener('keydown', this._boundKeyHandler);
                },

                handleKeys(e) {
                    if (e.key === 'ArrowRight') this.next();
                    if (e.key === 'ArrowLeft') this.prev();
                    if (e.key === 'Escape') this.close();
                    if (e.key === '+' || e.key === '=') this.zoomIn();
                    if (e.key === '-' || e.key === '_') this.zoomOut();
                    if (e.key.toLowerCase() === 'r') this.rotate();
                },

                next() { this.idx = (this.idx + 1) % this.images.length; this.updateImage(); },
                prev() { this.idx = (this.idx - 1 + this.images.length) % this.images.length; this.updateImage(); },

                updateImage() {
                    const img = document.getElementById('gal-img');
                    img.src = this.images[this.idx];
                    this.reset();
                    const counter = document.getElementById('gal-counter');
                    if (counter) counter.innerText = `${this.idx + 1} / ${this.images.length}`;
                },

                rotate() { this.rot = (this.rot + 90) % 360; this.updateTransform(); },
                zoomIn() { this.scale = Math.min(5, this.scale + 0.3); this.updateTransform(); },
                zoomOut() { this.scale = Math.max(0.5, this.scale - 0.3); this.updateTransform(); },
                reset() {
                    this.scale = 1; this.rot = 0;
                    this.posX = 0; this.posY = 0;
                    this.updateTransform();
                },

                updateTransform() {
                    const img = document.getElementById('gal-img');
                    if (this.isDragging) img.classList.add('no-transition');
                    else img.classList.remove('no-transition');

                    img.style.transform = `translate(${this.posX}px, ${this.posY}px) rotate(${this.rot}deg) scale(${this.scale})`;

                    // Standard cursor behavior
                    if (this.scale > 1.05) {
                        img.style.cursor = this.isDragging ? 'grabbing' : 'grab';
                    } else {
                        img.style.cursor = 'default';
                    }
                },

                // Interaction state
                onStart(e) {
                    if (!e || (e.target && e.target.closest && e.target.closest('.gal-controls'))) return;

                    if (e.type === 'touchstart' && e.touches) {
                        this.touchstartX = e.touches[0].clientX;
                        this.touchstartY = e.touches[0].clientY;

                        // For 2-finger panning / pinching
                        if (e.touches.length === 2) {
                            this._pinchStartDist = Math.hypot(
                                e.touches[0].clientX - e.touches[1].clientX,
                                e.touches[0].clientY - e.touches[1].clientY
                            );
                            this._pinchStartScale = this.scale;
                            this._pinchStartX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - this.posX;
                            this._pinchStartY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - this.posY;
                            this.isDragging = false;
                        } else {
                            // Start dragging for mobile (if zoomed)
                            if (this.scale > 1.01) {
                                this.isDragging = true;
                                this.startX = e.touches[0].clientX - this.posX;
                                this.startY = e.touches[0].clientY - this.posY;
                            }
                        }
                    } else {
                        // Desktop Mouse Start
                        if (this.scale > 1.01) {
                            this.isDragging = true;
                            this.startX = e.clientX - this.posX;
                            this.startY = e.clientY - this.posY;
                            this.updateTransform();
                        }
                    }
                },

                onMove(e) {
                    // Early return if no valid active state or no event
                    if (!e || (!this.isDragging && !this._pinchStartDist)) return;
                    if (e.preventDefault) e.preventDefault();

                    if (e.type === 'touchmove' && e.touches) {
                        // Mobile Pinch and 2-Finger Pan
                        if (e.touches.length === 2 && this._pinchStartDist) {
                            const dist = Math.hypot(
                                e.touches[1].clientX - e.touches[0].clientX,
                                e.touches[1].clientY - e.touches[0].clientY
                            );
                            const zoomFactor = dist / this._pinchStartDist;
                            this.scale = Math.min(5, Math.max(0.5, this._pinchStartScale * zoomFactor));

                            if (this.scale > 1.01) {
                                const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                                const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                                this.posX = midX - this._pinchStartX;
                                this.posY = midY - this._pinchStartY;
                            }
                            this.updateTransform();
                        }
                        // Mobile Single Touch Pan
                        else if (this.isDragging && this.scale > 1.01) {
                            this.posX = e.touches[0].clientX - this.startX;
                            this.posY = e.touches[0].clientY - this.startY;
                            this.updateTransform();
                        }
                    } else {
                        // Desktop Mouse Move (Strict button check + drag state)
                        if (this.isDragging && this.scale > 1.01 && (e.buttons & 1)) {
                            this.posX = e.clientX - this.startX;
                            this.posY = e.clientY - this.startY;
                            this.updateTransform();
                        } else if (this.isDragging) {
                            // Safety: if mouse is up but listener missed it
                            this.onEnd(e);
                        }
                    }
                },

                onEnd(e) {
                    // Mobile Swipe Detection
                    if (e && e.type === 'touchend' && this.scale <= 1.01 && this.touchstartX !== undefined && e.changedTouches) {
                        const deltaX = e.changedTouches[0].clientX - this.touchstartX;
                        const deltaY = e.changedTouches[0].clientY - this.touchstartY;

                        if (Math.abs(deltaX) > 60 && Math.abs(deltaY) < 100) {
                            if (deltaX < 0) this.next();
                            else this.prev();
                        }
                    }

                    this.isDragging = false;
                    this._pinchStartDist = null;
                    this.touchstartX = undefined;
                    this.updateTransform(); // Refresh cursor state
                },

                onWheel(e) {
                    e.preventDefault();
                    const zoomSpeed = 0.2;
                    const prevScale = this.scale;

                    // Calculate new scale
                    if (e.deltaY < 0) this.scale = Math.min(5, this.scale + zoomSpeed);
                    else this.scale = Math.max(0.5, this.scale - zoomSpeed);

                    // Zoom towards cursor (Standard Pro behavior)
                    if (this.scale !== prevScale) {
                        const rect = document.getElementById('gal-vp').getBoundingClientRect();
                        const mouseX = e.clientX - (rect.left + rect.width / 2);
                        const mouseY = e.clientY - (rect.top + rect.height / 2);

                        const ratio = (this.scale / prevScale) - 1;
                        this.posX -= (mouseX - this.posX) * ratio;
                        this.posY -= (mouseY - this.posY) * ratio;
                    }

                    this.updateTransform();
                },

                clickNav(e) {
                    // Only navigate if NOT dragging significantly and NOT clicking image when zoomed
                    if (this.scale > 1.2 && e.target.tagName === 'IMG') return;
                    if (e.target.closest('.gal-controls')) return;

                    const width = document.getElementById('gal-vp').clientWidth;
                    const rect = document.getElementById('gal-vp').getBoundingClientRect();
                    const clickX = e.clientX - rect.left;

                    // Threshold for navigation
                    if (clickX > width * 0.7) this.next();
                    else if (clickX < width * 0.3) this.prev();
                }
            };

            const LocalCam = {
                async handleCapture(input, surveyId) {
                    if (input.files && input.files[0]) {
                        const file = input.files[0];
                        const timestamp = Math.floor(Date.now() / 1000);

                        try {
                            // Use DriveSync's compressor for consistency (WebP < 300KB)
                            const compressedFile = await DriveSync.compressImage(file);

                            // Create Filename
                            const filename = `${surveyId}_img_${timestamp}.webp`;

                            // Create Blob URL from compressed file
                            const blobUrl = URL.createObjectURL(compressedFile);

                            // Trigger Download
                            const link = document.createElement('a');
                            link.href = blobUrl;
                            link.download = filename;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);

                            // Cleanup - Increased timeout to 5s for mobile reliability
                            setTimeout(() => URL.revokeObjectURL(blobUrl), 5000);

                            if (window.App && App.showToast) App.showToast("Image Saved: " + filename);
                            else alert("Image Saved: " + filename);

                        } catch (e) {
                            console.error("Compression failed", e);
                            alert("Error saving image: " + e.message);
                        }

                        // Reset input
                        input.value = '';
                    }
                }
            };

            const QRScanner = {
                html5QrCode: null,

                open() {
                    document.getElementById('modal-qr').style.display = 'flex';

                    if (typeof Html5Qrcode === 'undefined') {
                        alert("QR Scanner Library failed to load. Please refresh.");
                        return;
                    }

                    this.html5QrCode = new Html5Qrcode("qr-reader");

                    // High Performance Config
                    const config = {
                        fps: 30, // Increased for fluid tracking
                        qrbox: (viewfinderWidth, viewfinderHeight) => {
                            const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                            const size = Math.floor(minEdge * 0.85); // 85% width
                            return { width: size, height: size };
                        },
                        aspectRatio: 1.0
                    };

                    // Prefer back camera with HD resolution
                    this.html5QrCode.start(
                        { facingMode: "environment" },
                        config,
                        (decodedText) => this.onScanSuccess(decodedText),
                        (errorMessage) => { /* ignore per-frame errors */ }
                    ).catch(err => {
                        console.error("Camera start failed", err);
                        alert("Could not start camera: " + err);
                        this.close();
                    });
                },

                onScanSuccess(decodedText) {
                    console.log(`Scan matched: ${decodedText}`);
                    this.close();

                    // Handle URL or simple ID
                    // URLs might be like: https://mkka7944.github.io/billing-dept/scanner.html?sid=12345
                    let id = decodedText;

                    if (decodedText.includes('sid=')) {
                        try {
                            const url = new URL(decodedText);
                            id = url.searchParams.get('sid');
                        } catch (e) {
                            // Fallback regex if URL parsing fails
                            const match = decodedText.match(/sid=([^&]+)/);
                            if (match) id = match[1];
                        }
                    }

                    if (id) {
                        // Remove any non-alphanumeric except underscore/hyphen if needed, 
                        // but survey IDs are usually numbers.
                        ListView.jumpFromMap(id);
                    } else {
                        alert("Could not parse Survey ID from: " + decodedText);
                    }
                },

                close() {
                    if (this.html5QrCode && this.html5QrCode.isScanning) {
                        this.html5QrCode.stop().then(() => {
                            this.html5QrCode.clear();
                            document.getElementById('modal-qr').style.display = 'none';
                        }).catch(err => {
                            document.getElementById('modal-qr').style.display = 'none';
                        });
                    } else {
                        document.getElementById('modal-qr').style.display = 'none';
                    }
                }
            };

            const DriveSync = {
                files: [],
                MAX: 999, // Effectively Unlimited
                APP_URL: 'https://script.google.com/macros/s/AKfycbxKdvyJf00rvveSyqPVMvk1iNSq_gbmFAHKkk51utr0Ptaoetqwyu_ftwritA-W06VmLw/exec',
                whitelist: null,
                currentDriveCount: 0,

                _safeId(id) { return id.toString().replace(/[^a-z0-9]/gi, '_'); },

                saveEmail(email) {
                    localStorage.setItem('surveyor_email', email);
                },

                getEmail() {
                    return localStorage.getItem('surveyor_email') || '';
                },

                init() {
                    if (this.whitelist) {
                        this.renderWhitelist(this.whitelist);
                    } else {
                        this.fetchWhitelist();
                    }
                },

                async fetchWhitelist() {
                    if (!this.APP_URL) return;
                    this.APP_URL = this.APP_URL.trim();
                    console.log("Checking connection to:", this.APP_URL);

                    try {
                        const resp = await fetch(`${this.APP_URL}?action=get_whitelist`, {
                            mode: 'cors',
                            cache: 'no-cache'
                        });

                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

                        const res = await resp.json();
                        if (res.status === 'success' && res.data) {
                            this.whitelist = res.data;
                            this.renderWhitelist(res.data);
                        } else {
                            throw new Error(res.message || "Invalid Response");
                        }
                    } catch (e) {
                        console.error("Whitelist fetch error:", e);
                        const select = document.getElementById('drive-email');
                        if (select) {
                            select.innerHTML = `<option value=""> Connection Failed: ${e.message}</option>`;
                            select.style.borderColor = 'var(--danger)';
                        }
                    }
                },

                renderWhitelist(emails) {
                    const select = document.getElementById('drive-email');
                    if (!select) return;

                    const savedEmail = this.getEmail();
                    const currentUserEmail = (window.USER && window.USER.email) ? window.USER.email.toLowerCase() : '';

                    let html = '<option value="">Select Surveyor Email</option>';
                    emails.forEach(email => {
                        const isMe = email.toLowerCase() === currentUserEmail;
                        const isSelected = email.toLowerCase() === savedEmail.toLowerCase();

                        // Use symbols to visually distinguish
                        const prefix = isMe ? ' ' : ' ';
                        const label = prefix + email + (isMe ? ' (You)' : '');

                        html += `<option value="${email}" ${isSelected ? 'selected' : ''} style="${!isMe ? 'color:#94a3b8;' : 'font-weight:bold;'}">${label}</option>`;
                    });
                    select.innerHTML = html;

                    // Apply visual dimming to the select element itself if an inactive email is selected
                    select.onchange = (e) => {
                        const val = e.target.value;
                        this.saveEmail(val);
                        if (val && val.toLowerCase() !== currentUserEmail) {
                            select.style.opacity = '0.6';
                            select.style.fontStyle = 'italic';
                        } else {
                            select.style.opacity = '1';
                            select.style.fontStyle = 'normal';
                        }
                    };
                    // Initial style check
                    if (savedEmail && savedEmail.toLowerCase() !== currentUserEmail) {
                        select.style.opacity = '0.6';
                        select.style.fontStyle = 'italic';
                    }
                },

                async fetchAllSyncedData() {
                    if (!this.APP_URL) return;
                    console.log("Fetching all synced IDs...");
                    try {
                        const resp = await fetch(`${this.APP_URL}?action=get_all_synced_ids`);
                        const res = await resp.json();
                        if (res.status === 'success' && res.data) {
                            // Expecting res.data to be { surveyId: timestamp, ... }
                            State.syncedData = res.data;
                            console.log("Synced data loaded:", Object.keys(State.syncedData).length, "records");
                            // Re-apply filters if the filter was already enabled or just to update status
                            if (State.driveOnlyFilter) App.apply();
                        }
                    } catch (e) {
                        console.error("Error fetching all synced data:", e);
                    }
                },

                async fetchMetadata(surveyId) {
                    if (!this.APP_URL) return;
                    const sid = this._safeId(surveyId);
                    const statusEl = document.getElementById(`drive-status-${sid}`);
                    try {
                        const resp = await fetch(`${this.APP_URL}?surveyId=${encodeURIComponent(surveyId)}`);
                        const res = await resp.json();
                        if (res.status === 'success') {
                            this.currentDriveCount = res.totalCount || 0;
                            this.renderSyncedImages(surveyId, res.data || []);
                            this.updateStatus(surveyId);
                        } else {
                            this.updateStatus(surveyId);
                        }
                    } catch (e) {
                        console.error("Metadata fetch error:", e);
                        this.updateStatus(surveyId);
                    }
                },

                renderSyncedImages(surveyId, images) {
                    const sid = this._safeId(surveyId);
                    const gal = document.getElementById(`synced-gallery-${sid}`);
                    if (!gal) return;

                    gal.innerHTML = images.map(img => {
                        // Use the thumbnail endpoint for better direct embedding support
                        const url = `https://drive.google.com/thumbnail?id=${img.id}&sz=w1000`;
                        const date = new Date(img.timestamp).toLocaleString();
                        const meta = `Uploaded by: ${img.uploader}\nTime: ${date}`;
                        console.log("Rendering synced image:", img.name, url);
                        return `
                    <div class="gallery-thumb synced" onclick="Gallery.open('${url}', '${surveyId}')" title="${meta}" style="position:relative; border:2px solid #10b981; overflow:hidden; background:#f8fafc;">
                        <img src="${url}" style="width:100%; height:100%; object-fit:cover;" onerror="this.onerror=null; this.src='https://placehold.co/100x100?text=Private+Image'; console.warn('Image private or missing');">
                        <div style="position:absolute; bottom:0; left:0; right:0; background:rgba(16,185,129,0.9); color:white; font-size:9px; padding:2px 4px; font-weight:800; text-align:center; transform:translateY(0); transition:transform 0.2s;">
                            SYNCED
                        </div>
                    </div>
                `;
                    }).join('');
                },

                updateStatus(surveyId) {
                    const sid = this._safeId(surveyId);
                    const statusBadge = document.getElementById(`drive-status-${sid}`);
                    const syncBtn = document.getElementById('btn-sync-drive');
                    const actionBtns = document.querySelectorAll('.sync-action-btn:not(.upload)');

                    if (!statusBadge) return;

                    const syncedTotal = this.currentDriveCount;
                    const pendingTotal = this.files.length;

                    if (syncedTotal > 0 || pendingTotal > 0) {
                        statusBadge.innerText = `${syncedTotal} Synced${pendingTotal > 0 ? ` + ${pendingTotal} Pending` : ''}`;
                        statusBadge.style.color = "var(--primary)";
                        statusBadge.style.background = "#eff6ff";
                        statusBadge.style.borderColor = "#dbeafe";
                    } else {
                        statusBadge.innerText = "No Images Synced";
                        statusBadge.style.color = "#64748b";
                        statusBadge.style.background = "#f8fafc";
                        statusBadge.style.borderColor = "#e2e8f0";
                    }

                    if (syncBtn) syncBtn.disabled = (this.files.length === 0);
                    actionBtns.forEach(btn => btn.disabled = false);
                },

                // Legacy compatibility: ensure background calls don't crash
                updateHub() { this.updateStatus(State.filtered[State.currentIdx][0]); },

                handleFiles(fileList) {
                    const newFiles = Array.from(fileList);
                    this.files = [...this.files, ...newFiles];
                    this.renderPreview();
                    this.updateStatus(State.filtered[State.currentIdx][0]);
                },

                renderPreview() {
                    const container = document.getElementById('drive-preview');
                    const syncBtn = document.getElementById('btn-sync-drive');
                    if (!container) return;

                    if (this.files.length === 0) {
                        container.style.display = 'none';
                        if (syncBtn) syncBtn.disabled = true;
                        return;
                    }

                    container.style.display = 'flex';
                    if (syncBtn) syncBtn.disabled = false;

                    container.innerHTML = this.files.map((f, i) => `
                <div class="preview-item">
                    <img src="${URL.createObjectURL(f)}">
                    <button class="remove-btn" onclick="DriveSync.remove(${i})">
                        <span class="material-icons-round" style="font-size:12px;">close</span>
                    </button>
                </div>
            `).join('');
                },

                remove(idx) {
                    this.files.splice(idx, 1);
                    this.renderPreview();
                    this.updateStatus(State.filtered[State.currentIdx][0]);
                },

                compressImage(file, maxWidth = 1024, quality = 0.6) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (e) => {
                            const img = new Image();
                            img.src = e.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let { width, height } = img;
                                if (width > maxWidth) {
                                    height = Math.round((height * maxWidth) / width);
                                    width = maxWidth;
                                }
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                canvas.toBlob((blob) => {
                                    resolve(new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".webp", { type: 'image/webp' }));
                                }, 'image/webp', quality);
                            };
                            img.onerror = reject;
                        };
                        reader.onerror = reject;
                    });
                },

                async upload(surveyId) {
                    const email = this.getEmail();
                    const btn = document.getElementById('btn-sync-drive');
                    const originalHtml = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<span class="material-icons-round rotate">sync</span> Processing...';

                    try {
                        // Parallelized Compression & Upload
                        const uploadPromises = this.files.map(async (file, i) => {
                            const compressed = await this.compressImage(file);
                            const base64 = await this.toBase64(compressed);
                            const name = `${surveyId}_img${this.currentDriveCount + i + 1}.webp`;

                            const response = await fetch(this.APP_URL, {
                                method: 'POST',
                                mode: 'cors',
                                headers: { 'Content-Type': 'text/plain' },
                                body: JSON.stringify({ name, data: base64, surveyId, email, timestamp: new Date().toISOString() })
                            });

                            if (!response.ok) throw new Error(`HTTP ${response.status}`);
                            const result = await response.json();
                            if (result.status === "error") throw new Error(result.message);
                            return result;
                        });

                        await Promise.all(uploadPromises);

                        alert(`Successfully synced ${this.files.length} images to Google Drive!`);
                        this.files = [];
                        this.renderPreview();
                        this.fetchMetadata(surveyId);
                    } catch (e) {
                        console.error("Upload error:", e);
                        let msg = e.message;
                        if (msg === "Failed to fetch") msg = "Check Connection or Blockers";
                        alert("Sync failed: " + msg);
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalHtml;
                    }
                },

                toBase64(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = error => reject(error);
                    });
                }
            };


            const LayerManager = {
                activeLayers: [],
                pendingSelections: new Set(),
                activeTab: null,

                _getFeatureColor(feature, palette) {
                    // Robust hashing using ID or Name
                    const idStr = (feature.properties.fid || feature.properties.name || 'Unnamed').toString();
                    let hash = 0;
                    for (let i = 0; i < idStr.length; i++) {
                        hash = idStr.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    return palette[Math.abs(hash) % palette.length];
                },

                load(keysToLoad) {
                    this.clear();
                    const palette = [
                        '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                        '#8b5cf6', '#ec4899', '#06b6d4', '#f97316',
                        '#14b8a6', '#6366f1'
                    ];

                    keysToLoad.forEach((key, index) => {
                        const [city, layerName] = key.split('|');
                        if (GEO_LAYERS[city] && GEO_LAYERS[city][layerName]) {
                            const layerColor = palette[index % palette.length];
                            const lowerLayer = layerName.toLowerCase();
                            const isWardLayer = lowerLayer.includes('urban_ward') || lowerLayer.includes('urban_uc');
                            const isCantonment = lowerLayer.includes('cantonment');

                            const layer = L.geoJSON(GEO_LAYERS[city][layerName], {
                                layerKey: key,
                                interactive: true,
                                pane: 'kmlPane',
                                style: (feature) => {
                                    let color = layerColor;
                                    let weight = 0.8;
                                    let dashArray = '5, 5';

                                    if (isCantonment) {
                                        color = '#ef4444'; // Permanent Red for Cantonment
                                        weight = 1.5;
                                        dashArray = null;
                                    } else if (isWardLayer && feature.properties) {
                                        color = this._getFeatureColor(feature, palette);
                                    }

                                    // Solid borders for MC layers
                                    if (layerName.match(/MC\s?\d+/i)) {
                                        weight = 1.5;
                                        dashArray = null;
                                    }

                                    return {
                                        color: color, weight: weight, opacity: 0.6, dashArray: dashArray,
                                        fillColor: color, fillOpacity: 0.08
                                    };
                                },
                                onEachFeature: (feature, layer) => {
                                    if (State.showTooltips) {
                                        const isMc = layerName.match(/MC\s?\d+/i);
                                        let content = '';

                                        if (isMc) {
                                            content = `<div style="font-family:Inter, sans-serif; padding:2px 4px; font-size:12px; font-weight:700; color:#1e293b;">${layerName}</div>`;
                                        } else {
                                            const customMeta = (window.KML_META && window.KML_META[layerName]) ? window.KML_META[layerName] : '';
                                            content = `
                                        <div style="font-family:Inter, sans-serif; padding:4px;">
                                            <div style="font-size:10px; font-weight:800; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:2px;">Boundary Layer</div>
                                            <div style="font-size:13px; font-weight:700; color:#1e293b;">${layerName}</div>
                                            ${customMeta ? `<div style="margin-top:6px; padding-top:6px; border-top:1px solid #f1f5f9; font-size:11px; color:#2563eb; font-weight:600;">${customMeta}</div>` : ''}
                                            <div style="font-size:10px; color:#94a3b8; margin-top:4px;">${feature.properties.name || 'Zone Feature'}</div>
                                        </div>
                                     `;
                                        }
                                        layer.bindTooltip(content, { sticky: true, opacity: 0.9 });
                                    }
                                }
                            }).addTo(State.map);
                            this.activeLayers.push(layer);
                        }
                    });
                },

                clear() {
                    this.activeLayers.forEach(l => State.map.removeLayer(l));
                    this.activeLayers = [];
                },

                initPendingState() {
                    this.pendingSelections = new Set();
                    this.activeLayers.forEach(l => {
                        if (l.options.layerKey) this.pendingSelections.add(l.options.layerKey);
                    });
                },

                showToast(msg) {
                    const toast = document.createElement('div');
                    toast.className = 'toast-msg';
                    toast.innerText = msg;
                    document.body.appendChild(toast);
                    setTimeout(() => { toast.classList.add('show'); }, 10);
                    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
                },


                switchTab(city) {
                    this.activeTab = city;
                    this.renderSettingsUI();
                },

                toggleSelection(key) {
                    if (this.pendingSelections.has(key)) {
                        this.pendingSelections.delete(key);
                    } else {
                        this.pendingSelections.add(key);
                    }
                    this.renderSettingsUI();
                },

                toggleAll(city, shouldSelect) {
                    let cityName = city;
                    let mcOnly = this.activeTab === ' SARGODHA MC';

                    const layers = GEO_LAYERS[cityName] || {};
                    Object.keys(layers).forEach(layerName => {
                        const isMc = layerName.match(/MC\s?\d+/i);
                        if (mcOnly && !isMc) return;
                        if (!mcOnly && cityName === 'SARGODHA' && isMc) return;

                        const key = `${cityName}|${layerName}`;
                        if (shouldSelect) this.pendingSelections.add(key);
                        else this.pendingSelections.delete(key);
                    });
                    this.renderSettingsUI();
                },

                toggleTooltips() {
                    State.showTooltips = !State.showTooltips;

                    // Immediate Update on Map
                    this.activeLayers.forEach(layer => {
                        // Check if it's a boundary layer (GeoJSON)
                        if (layer.feature) {
                            if (State.showTooltips) {
                                const layerName = layer.options.layerKey ? layer.options.layerKey.split('|')[1] : null;
                                if (layerName) {
                                    const customMeta = (window.KML_META && window.KML_META[layerName]) ? window.KML_META[layerName] : '';
                                    const content = `
                                <div style="font-family:Inter, sans-serif; padding:4px;">
                                    <div style="font-size:10px; font-weight:800; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:2px;">Boundary</div>
                                    <div style="font-size:13px; font-weight:700; color:#1e293b;">${layerName}</div>
                                    ${customMeta ? `<div style="margin-top:6px; padding-top:6px; border-top:1px solid #f1f5f9; font-size:11px; color:#2563eb; font-weight:600;">${customMeta}</div>` : ''}
                                </div>
                             `;
                                    layer.bindTooltip(content, { sticky: true, opacity: 0.95 });
                                }
                            } else {
                                layer.unbindTooltip();
                            }
                        }
                    });

                    this.renderSettingsUI();
                    this.showToast(`Tooltips ${State.showTooltips ? 'Enabled' : 'Disabled'}`);
                },

                applySettings() {
                    // Convert Set to Array and Load
                    const keys = Array.from(this.pendingSelections);
                    this.load(keys);

                    // Close Settings Modal
                    document.getElementById('modal-settings').style.display = 'none';
                    this.showToast(`Active Layers: ${keys.length}`);
                },

                clearCity() {
                    const city = this.activeTab;
                    for (let key of this.pendingSelections) {
                        if (key.startsWith(city + '|')) {
                            this.pendingSelections.delete(key);
                        }
                    }
                    this.renderSettingsUI();
                },

                // Natural Sort Helper
                naturalSort(a, b) {
                    return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
                },

                renderSettingsUI() {
                    const container = document.getElementById('settings-layers-container');
                    if (!container) return;

                    // Save scroll position
                    const scrollEl = container.querySelector('.settings-scroll-area');
                    const lastScroll = scrollEl ? scrollEl.scrollTop : 0;

                    let allCityNames = Object.keys(GEO_LAYERS);

                    // Reordering Tabs: Stats, Marker Limit, Sargodha MC (if exists), then others
                    let tabs = [' Stats', ' Marker Limit'];

                    const hasSargodha = allCityNames.includes('SARGODHA');
                    if (hasSargodha) {
                        tabs.push(' SARGODHA MC');
                    }

                    // Filter out 'SARGODHA' from the main list if ' SARGODHA MC' is added,
                    // as 'SARGODHA' will be handled separately in the content rendering.
                    let otherCityNames = allCityNames.filter(city => city !== 'SARGODHA');
                    otherCityNames.sort(this.naturalSort); // Apply natural sort to other cities

                    tabs = tabs.concat(otherCityNames);

                    // If 'SARGODHA' exists and was not added as ' SARGODHA MC', add it now.
                    // This ensures 'SARGODHA' tab appears after ' SARGODHA MC' if both are present.
                    // However, the current logic for `isMcTab` and `cityName === 'SARGODHA'` in the content
                    // implies that 'SARGODHA' tab should *not* contain MC layers.
                    // The instruction is to place ' SARGODHA MC' at index 2.
                    // The original code adds all cityNames after the fixed tabs.
                    // Let's re-evaluate the tab construction to match the instruction and existing logic.

                    // Corrected tab construction for explicit index 2 and natural sort:
                    let baseTabs = [' Stats', ' Marker Limit'];
                    let dynamicTabs = Object.keys(GEO_LAYERS).sort(this.naturalSort);

                    // Remove 'SARGODHA' from dynamicTabs if ' SARGODHA MC' is to be a separate tab
                    const sargodhaIndex = dynamicTabs.indexOf('SARGODHA');
                    if (sargodhaIndex > -1) {
                        dynamicTabs.splice(sargodhaIndex, 1); // Remove 'SARGODHA' for now
                        baseTabs.push(' SARGODHA MC'); // Add MC tab at index 2 (after , )
                        baseTabs.push('SARGODHA'); // Add main SARGODHA tab after MC tab
                    }

                    tabs = baseTabs.concat(dynamicTabs); // Combine fixed and naturally sorted dynamic tabs

                    if (!this.activeTab) this.activeTab = ' Stats';

                    let tabsHtml = `<div class="settings-tabs-row">`;
                    tabs.forEach(tab => {
                        const isActive = this.activeTab === tab;
                        tabsHtml += `
                    <button onclick="LayerManager.switchTab('${tab}')" class="settings-tab-btn ${isActive ? 'active' : ''}">
                        ${tab}
                    </button>`;
                    });
                    tabsHtml += `</div>`;

                    let contentHtml = '<div class="settings-scroll-area" style="flex:1; overflow-y:auto; padding:24px; padding-bottom:100px;">';

                    if (this.activeTab === ' Stats') {
                        contentHtml += `
                    <div style="background:#eff6ff; border-radius:16px; padding:20px; border:1px solid #dbeafe; box-shadow: 0 4px 12px rgba(37,99,235,0.05);">
                         <h4 style="margin:0 0 16px 0; color:#1e40af; font-size:12px; font-weight:800; text-transform:uppercase; letter-spacing:1px;">Data Coverage Overview</h4>
                         <div style="grid-template-columns:1fr 1fr; display:grid; gap:12px;">
                             <div style="background:white; padding:16px; border-radius:12px; text-align:center; grid-column:span 2; border:1px solid #dbeafe;">
                                 <div style="font-size:10px; color:#64748b; font-weight:800; letter-spacing:1px;">TOTAL SURVEYS</div>
                                 <div id="set-total-surveys" style="font-size:28px; font-weight:900; color:#1e293b; margin-top:4px;">0</div>
                             </div>
                             <div style="background:white; padding:12px; border-radius:12px; text-align:center; border:1px solid #dcfce7;">
                                 <div style="font-size:9px; color:#16a34a; font-weight:800; letter-spacing:0.5px;">DOMESTIC</div>
                                 <div id="set-total-domestic" style="font-size:20px; font-weight:900; color:#16a34a;">0</div>
                             </div>
                             <div style="background:white; padding:12px; border-radius:12px; text-align:center; border:1px solid #fef3c7;">
                                 <div style="font-size:9px; color:#d97706; font-weight:800; letter-spacing:0.5px;">COMMERCIAL</div>
                                 <div id="set-total-commercial" style="font-size:20px; font-weight:900; color:#d97706;">0</div>
                             </div>
                         </div>
                    </div>
                    
                    <div style="margin-top:20px; background:white; border-radius:16px; border:1px solid #f1f5f9; padding:4px;">
                        <button onclick="LayerManager.toggleTooltips()" class="secondary-btn" style="width:100%; margin:0; justify-content:space-between; padding:16px; border:none; border-radius:12px;">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <div style="width:36px; height:36px; border-radius:10px; background:${State.showTooltips ? '#f0fdf4' : '#f8fafc'}; color:${State.showTooltips ? '#16a34a' : '#64748b'}; display:flex; align-items:center; justify-content:center;">
                                    <span class="material-icons-round">${State.showTooltips ? 'comment' : 'comments_disabled'}</span>
                                </div>
                                <div style="text-align:left;">
                                    <div style="font-size:12px; font-weight:800; color:#1e293b;">Layer Tooltips</div>
                                    <div style="font-size:10px; color:#94a3b8; font-weight:600;">Show names on map hover/tap</div>
                                </div>
                            </div>
                            <div class="toggle-switch ${State.showTooltips ? 'active' : ''}"></div>
                        </button>
                    </div>

                    <div style="margin-top:16px; padding:16px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:16px; font-size:11px; color:#64748b; line-height:1.6; font-weight:600;">
                        This dashboard provides real-time statistics of the survey database. Use the  <b>Marker Limit</b> tab if you need to adjust performance for large datasets.
                    </div>`;
                        setTimeout(() => typeof Settings !== 'undefined' && Settings.updateStats(), 50);
                    }
                    else if (this.activeTab === ' Marker Limit') {
                        const limit = State.markerLimit >= 999999 ? 'No Limit' : State.markerLimit.toLocaleString();
                        contentHtml += `
                    <div style="padding:4px;">
                        <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:20px; background: #fff; padding:16px; border-radius:16px; border:1px solid #f1f5f9;">
                            <div>
                                <label style="font-weight:800; font-size:11px; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Current Map Limit</label>
                                <span style="font-weight:900; font-size:28px; color:var(--primary);">${limit === 'No Limit' ? '' : limit}</span>
                            </div>
                            <span class="material-icons-round" style="font-size:40px; color:#dbeafe;">speed</span>
                        </div>
                        <div style="font-size:12px; color:#64748b; margin-bottom:20px; line-height:1.5;">Higher limits allow visualizing more data but may impact performance on older mobile devices.</div>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                            <button onclick="Settings.setMarkerLimit(5000)" class="secondary-btn" style="margin:0; justify-content:center;">5,000</button>
                            <button onclick="Settings.setMarkerLimit(10000)" class="secondary-btn" style="margin:0; justify-content:center;">10,000</button>
                            <button onclick="Settings.setMarkerLimit(20000)" class="secondary-btn" style="margin:0; justify-content:center;">20,000</button>
                            <button onclick="Settings.setMarkerLimit(50000)" class="secondary-btn" style="margin:0; justify-content:center;">50,000</button>
                            <button onclick="Settings.setMarkerLimit(999999)" class="secondary-btn" style="margin:0; justify-content:center; grid-column: span 2; background:#f0f7ff; border-color:#dbeafe; color:#2563eb;">Show All Records</button>
                        </div>
                        
                        <div style="display:flex; gap:10px;">
                            <button onclick="Settings.incrementMarkerLimit(-5000)" style="flex:1; padding:14px; border-radius:12px; border:1px solid #e2e8f0; background:white; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; color:#64748b;">
                                <span class="material-icons-round" style="font-size:18px;">remove_circle_outline</span> -5K
                            </button>
                            <button onclick="Settings.incrementMarkerLimit(5000)" style="flex:1; padding:14px; border-radius:12px; border:1px solid #e2e8f0; background:white; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; color:#2563eb;">
                                <span class="material-icons-round" style="font-size:18px;">add_circle_outline</span> +5K
                            </button>
                        </div>
                    </div>`;
                    }
                    else {
                        // KML Cities Sections
                        let cityName = this.activeTab;
                        let isMcTab = cityName === ' SARGODHA MC';
                        if (isMcTab) cityName = 'SARGODHA';

                        const allCityLayers = GEO_LAYERS[cityName] || {};
                        let filteredKeys = Object.keys(allCityLayers);

                        if (isMcTab) {
                            filteredKeys = filteredKeys.filter(k => k.match(/MC\s?\d+/i));
                        } else if (cityName === 'SARGODHA') {
                            // Remove MC layers from main Sargodha tab to avoid duplication
                            filteredKeys = filteredKeys.filter(k => !k.match(/MC\s?\d+/i));
                        }

                        const sortedLayers = filteredKeys.sort(this.naturalSort);

                        if (sortedLayers.length === 0) {
                            contentHtml += '<div style="padding:60px 20px; text-align:center; color:#94a3b8;">' +
                                '<span class="material-icons-round" style="font-size:48px; display:block; margin-bottom:12px; opacity:0.3;">layers_clear</span>' +
                                'No matching layers for this section.</div>';
                        } else {
                            const allSelected = sortedLayers.every(layerName => this.pendingSelections.has(`${cityName}|${layerName}`));

                            contentHtml += `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <div style="font-size:11px; font-weight:800; color:#94a3b8; text-transform:uppercase; letter-spacing:1px;">${this.activeTab} LAYERS</div>
                            <button onclick="LayerManager.toggleAll('${cityName}', ${!allSelected})" style="background:#f0f7ff; color:#2563eb; border:none; padding:6px 14px; border-radius:8px; font-size:10px; font-weight:800; cursor:pointer;">
                                ${allSelected ? 'UNSELECT ALL' : 'SELECT ALL'}
                            </button>
                        </div>
                        <div class="kml-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">`;

                            sortedLayers.forEach(layerName => {
                                const key = `${cityName}|${layerName}`;
                                const isChecked = this.pendingSelections.has(key);
                                contentHtml += `
                            <div class="multi-option ${isChecked ? 'selected' : ''}" onclick="LayerManager.toggleSelection('${key}')" 
                                 style="padding:12px; margin:0; border:1px solid ${isChecked ? '#bfdbfe' : '#f1f5f9'}; border-radius:12px; 
                                 display:flex; align-items:center; gap:10px; cursor:pointer; background:${isChecked ? '#eff6ff' : 'white'}; transition:all 0.2s;">
                                <div style="width:20px; height:20px; border:1.5px solid ${isChecked ? '#2563eb' : '#cbd5e1'}; border-radius:6px; 
                                            display:flex; align-items:center; justify-content:center; background:${isChecked ? '#2563eb' : 'transparent'};">
                                    ${isChecked ? '<span class="material-icons-round" style="font-size:14px; color:white;">check</span>' : ''}
                                </div>
                                <span style="font-size:11px; font-weight:700; color:${isChecked ? '#1e40af' : '#64748b'}; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${layerName}</span>
                            </div>`;
                            });
                            contentHtml += `</div>`;

                            contentHtml += `
                        <div style="margin-top:24px; display:flex; gap:12px;">
                            <button onclick="LayerManager.clearCity()" style="flex:1; padding:10px; font-size:11px; color:#64748b; font-weight:700; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                                <span class="material-icons-round" style="font-size:16px;">clear_all</span> Uncheck Tab
                            </button>
                            <button onclick="LayerManager.clear()" style="flex:1; padding:10px; font-size:11px; color:#ef4444; font-weight:700; background:#fef2f2; border:1px solid #fee2e2; border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                                <span class="material-icons-round" style="font-size:16px;">delete_sweep</span> Clear Map
                            </button>
                        </div>`;
                        }
                    }
                    contentHtml += '</div>';

                    // Re-Styled Footer
                    const isKmlTab = tabs.indexOf(this.activeTab) > 1;
                    const footerHtml = isKmlTab ? `
                <div class="settings-footer">
                     <button onclick="Settings.close()" style="flex:0.4; padding:12px; border-radius:12px; border:1px solid #e2e8f0; background:white; color:#64748b; font-weight:700; cursor:pointer;">Cancel</button>
                     <button onclick="LayerManager.applySettings()" class="btn-primary" 
                        style="flex:1; border-radius:12px; padding:12px; display:flex; justify-content:center; gap:10px; align-items:center; background:#2563eb; color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer; box-shadow: 0 4px 12px rgba(37,99,235,0.2);">
                        <span class="material-icons-round" style="font-size:20px;">task_alt</span> Apply Changes
                     </button>
                </div>` : `
                <div class="settings-footer" style="padding:12px 24px;">
                    <div style="font-size:11px; color:#94a3b8; font-weight:600;">v6.2 Build  Robust Core</div>
                    <button onclick="Settings.close()" style="margin-left:auto; padding:8px 20px; border-radius:20px; border:1px solid #e2e8f0; background:white; font-weight:700; font-size:12px; cursor:pointer;">Close</button>
                </div>`;

                    container.innerHTML = tabsHtml + contentHtml + footerHtml;

                    // Restore scroll
                    if (lastScroll) {
                        const newScrollEl = container.querySelector('.settings-scroll-area');
                        if (newScrollEl) newScrollEl.scrollTop = lastScroll;
                    }
                },
            };

            // Attach Gallery Events
            const galVp = document.getElementById('gal-vp');
            galVp.addEventListener('mousedown', e => Gallery.onStart(e));
            galVp.addEventListener('mousemove', e => Gallery.onMove(e));
            galVp.addEventListener('touchstart', e => Gallery.onStart(e), { passive: false });
            galVp.addEventListener('touchmove', e => Gallery.onMove(e), { passive: false });
            galVp.addEventListener('wheel', e => Gallery.onWheel(e), { passive: false });
            galVp.addEventListener('click', e => Gallery.clickNav(e));
            galVp.addEventListener('dblclick', () => Gallery.reset());

            // Window level listeners to catch drag releases outside the viewport
            window.addEventListener('mouseup', (e) => Gallery.onEnd(e));
            window.addEventListener('touchend', (e) => Gallery.onEnd(e));
            window.addEventListener('mouseleave', (e) => Gallery.onEnd(e));



            const Sidebar = {
                init() {
                    // Auto-close on map click for mobile
                    const mapC = document.getElementById('main-stage');
                    if (mapC) {
                        mapC.addEventListener('click', (e) => {
                            // Only if clicking map directly (not controls) and on mobile
                            if (window.innerWidth <= 768 &&
                                document.getElementById('sidebar').classList.contains('open') &&
                                !e.target.closest('.map-controls') &&
                                !e.target.closest('.float-btn') &&
                                !e.target.closest('.gal-btn')) {
                                this.close();
                            }
                        });
                    }
                },
                toggle() {
                    const sb = document.getElementById('sidebar');
                    const btn = document.getElementById('sidebar-toggle');

                    if (window.innerWidth <= 768) {
                        sb.classList.toggle('open');
                        sb.classList.remove('collapsed');

                        // Toggle Info Card visibility
                        const card = document.getElementById('info-card');
                        if (card) {
                            if (sb.classList.contains('open')) card.classList.add('hidden');
                            else card.classList.remove('hidden');
                        }
                    } else {
                        sb.classList.toggle('collapsed');
                        sb.classList.remove('open');
                        if (btn) btn.classList.toggle('collapsed-toggle');

                        // Refresh map size after transition
                        setTimeout(() => {
                            if (State.map) State.map.invalidateSize({ animate: true });
                            // Sync routing overlay position
                            this.syncRoutingOverlay();
                        }, 450);
                    }
                },
                syncRoutingOverlay() {
                    const overlay = document.getElementById('routing-station-overlay');
                    if (!overlay) return;

                    // Only sync if it hasn't been manually dragged yet
                    if (overlay.dataset.dragged === "true") return;

                    const sb = document.getElementById('sidebar');
                    const isCollapsed = sb.classList.contains('collapsed');
                    overlay.style.left = isCollapsed ? '24px' : 'calc(320px + 24px)';
                },
                toggleDesktop() { this.toggle(); }, // Keep for compatibility
                close() {
                    const sb = document.getElementById('sidebar');
                    sb.classList.remove('open');
                    if (window.innerWidth > 768) sb.classList.add('collapsed');

                    const card = document.getElementById('info-card');
                    if (card) card.classList.remove('hidden');
                    this.syncRoutingOverlay();
                }
            };

            const InfoCard = {
                init() {
                    if (typeof RAW_DATA === 'undefined') return;

                    // 1. Calculate Stats
                    const total = RAW_DATA.length;
                    const byTehsil = {};

                    RAW_DATA.forEach(r => {
                        const tehsil = r[11]; // Tehsil Name
                        const type = r[3];    // 1=Com, 0=Dom

                        if (!byTehsil[tehsil]) byTehsil[tehsil] = { t: 0, d: 0, c: 0 };
                        byTehsil[tehsil].t++;
                        if (type === 1) byTehsil[tehsil].c++;
                        else byTehsil[tehsil].d++;
                    });

                    // 2. Build HTML
                    const isMin = document.getElementById('info-card').classList.contains('minimized');
                    const toggleIcon = isMin ? 'expand_more' : 'expand_less';
                    const headerStyle = isMin
                        ? 'display:flex; justify-content:space-between; align-items:center;'
                        : 'padding-bottom:12px; border-bottom:1px solid #f1f5f9; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;';

                    let html = `
                <div style="${headerStyle}">
                    <div>
                        <div style="font-size:10px; color:#64748b; font-weight:800; letter-spacing:1px; text-transform:uppercase; margin-bottom:4px;">${isMin ? '' : 'Total Surveys'}</div>
                        <div style="font-size:24px; font-weight:800; color:var(--primary); line-height:1;">${total.toLocaleString()}</div>
                    </div>
                    <button onclick="InfoCard.toggle()" style="background:none; border:none; cursor:pointer; color:#94a3b8; padding:4px;">
                        <span class="material-icons-round">${toggleIcon}</span>
                    </button>
                </div>
                <div id="info-content" style="flex:1; overflow-y:auto; padding-right:4px; display:${isMin ? 'none' : 'block'}">
            `;

                    // Sort Tehsils by count
                    const sorted = Object.entries(byTehsil).sort((a, b) => b[1].t - a[1].t);

                    sorted.forEach(([name, data]) => {
                        html += `
                    <div class="info-stat-row">
                        <div class="info-label">${name}</div>
                        <div class="info-val">
                           <span class="pill dom" title="Domestic">Dom: ${data.d}</span>
                           <span class="pill com" title="Commercial">Com: ${data.c}</span>
                           <span style="min-width:30px; text-align:right;">${data.t}</span>
                        </div>
                    </div>
                `;
                    });

                    html += `</div>`;
                    document.getElementById('info-card').innerHTML = html;
                },

                toggle() {
                    const card = document.getElementById('info-card');
                    card.classList.toggle('minimized');
                    this.init(); // Re-render to update icon/content
                }
            };

            const Settings = {
                open() {
                    try {
                        if (typeof LayerManager !== 'undefined') {
                            LayerManager.initPendingState();
                            LayerManager.renderSettingsUI();
                        }
                    } catch (e) { console.error("LayerManager error:", e); }
                    document.getElementById('modal-settings').style.display = 'flex';
                },

                updateStats() {
                    if (typeof RAW_DATA === 'undefined') return;
                    const total = RAW_DATA.length;
                    // Type 1 = Commercial, Others = Domestic
                    const comm = RAW_DATA.filter(r => r[3] === 1).length;
                    const dom = total - comm;

                    const elTotal = document.getElementById('set-total-surveys');
                    const elDom = document.getElementById('set-total-domestic');
                    const elComm = document.getElementById('set-total-commercial');

                    if (elTotal) elTotal.innerText = total.toLocaleString();
                    if (elDom) elDom.innerText = dom.toLocaleString();
                    if (elComm) elComm.innerText = comm.toLocaleString();
                },

                close() {
                    document.getElementById('modal-settings').style.display = 'none';
                },

                setMarkerLimit(limit) {
                    State.markerLimit = limit;
                    LayerManager.renderSettingsUI();
                    App.render();
                },

                incrementMarkerLimit(amount) {
                    State.markerLimit = Math.max(5000, State.markerLimit + amount);
                    LayerManager.renderSettingsUI();
                    App.render();
                }
            };

            // Keyboard support for List View
            window.addEventListener('keydown', e => {
                if (!document.getElementById('list-view-stage').classList.contains('active')) return;
                // Block List View navigation if Gallery is active
                if (document.getElementById('gallery').classList.contains('active')) return;

                if (e.key === 'ArrowRight') ListView.next();
                if (e.key === 'ArrowLeft') ListView.prev();
            });

            // Touch support for List View
            let touchStartX = 0;
            let touchStartY = 0;
            document.getElementById('lv-content').addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            document.getElementById('lv-content').addEventListener('touchend', e => {
                const deltaX = touchStartX - e.changedTouches[0].screenX;
                const deltaY = touchStartY - e.changedTouches[0].screenY;

                // Threshold check (increase to 100px) and Axis check (ensure horizontal dominance)
                if (Math.abs(deltaX) > 100 && Math.abs(deltaX) > Math.abs(deltaY) * 1.5) {
                    deltaX > 0 ? ListView.next() : ListView.prev();
                }
            }, { passive: true });

            const PerformanceLog = {
                customStartDate: null,

                updateDate(val) {
                    this.customStartDate = val;
                    this.open();
                },

                open() {
                    // 1. Setup Dates
                    const now = new Date();
                    const todayStr = now.toISOString().split('T')[0];

                    // Default to 1st of current month if not set
                    if (!this.customStartDate) {
                        this.customStartDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-01`;
                    }

                    // Update input if exists
                    const dateInput = document.getElementById('att-start-date');
                    if (dateInput) dateInput.value = this.customStartDate;

                    const startStr = this.customStartDate;
                    const monthName = new Date(startStr).toLocaleString('default', { month: 'long', year: 'numeric' });

                    // 2. Aggregate Data by Staff -> Date
                    const staffData = {};

                    RAW_DATA.forEach(r => {
                        const staff = r[6], d = r[7];
                        if (d < startStr || d > todayStr) return;

                        if (!staffData[staff]) staffData[staff] = {};
                        if (!staffData[staff][d]) staffData[staff][d] = [];
                        staffData[staff][d].push(r);
                    });

                    // 3. Process Monthly Stats per Staff
                    const summary = [];

                    Object.keys(staffData).forEach(name => {
                        const dates = Object.keys(staffData[name]).sort();
                        let daysActive = dates.length;
                        let targetMet = 0;
                        let pmMet = 0;
                        let workflowMet = 0;
                        let absents = 0;

                        dates.forEach(d => {
                            const recs = staffData[name][d].sort((a, b) => a[8].localeCompare(b[8]));
                            const total = recs.length;

                            // PM Count (14:00 - 16:55)
                            const pmCount = recs.filter(r => r[8] >= "14:00:00" && r[8] <= "16:55:00").length;

                            // Idle Count
                            let idleCount = 0;
                            const winStart = "10:00:00", winEnd = "16:55:00";
                            for (let i = 1; i < recs.length; i++) {
                                const t1 = recs[i - 1][8], t2 = recs[i][8];
                                if (t1 < winStart || t1 > winEnd) continue;

                                const d1 = new Date(`2000-01-01T${t1}`), d2 = new Date(`2000-01-01T${t2}`);
                                let diff = (d2 - d1) / 60000;

                                // Lunch correction
                                const lS = new Date(`2000-01-01T13:00:00`), lE = new Date(`2000-01-01T14:00:00`);
                                const oS = new Date(Math.max(d1, lS)), oE = new Date(Math.min(d2, lE));
                                if (oE > oS) diff -= (oE - oS) / 60000;

                                if (diff > 30) idleCount++;
                            }

                            // Check Rules
                            const ruleTarget = total >= 100;
                            const rulePM = pmCount >= 30;
                            const ruleIdle = idleCount <= 3;

                            if (ruleTarget) targetMet++;
                            if (rulePM) pmMet++;
                            if (ruleIdle) workflowMet++;

                            // If Fails ALL 3 -> Absent
                            if (!ruleTarget && !rulePM && !ruleIdle) absents++;
                        });

                        summary.push({ name, daysActive, targetMet, pmMet, workflowMet, absents });
                    });

                    // Sort by Absents (desc) then Name
                    summary.sort((a, b) => b.absents - a.absents || a.name.localeCompare(b.name));

                    // 4. Render HTML
                    if (document.getElementById('log-subtitle')) {
                        document.getElementById('log-subtitle').innerText = `Summary  ${startStr} to Present`;
                    }

                    let html = `
                <div class="guide-box">
                    <h4>Performance Summary</h4>
                    <div style="font-size:12px; color:#64748b; margin-bottom:8px;">
                        Showing stats from <b>${startStr}</b> to <b>${todayStr}</b>.
                        <br><b>Absence</b> = Days failing all 3 rules (Target < 100, PM < 30, Idle > 3).
                    </div>
                </div>
                <table class="perf-table" style="width:100%; border-collapse:collapse; font-size:13px; min-width:600px;">
                <thead style="background:#f8fafc; position:sticky; top:0; z-index:20;">
                    <tr>
                        <th style="padding:12px; text-align:left;">Staff Name</th>
                        <th style="padding:12px; text-align:center;">Days Active</th>
                        <th style="padding:12px; text-align:center;">Target Met (Days)</th>
                        <th style="padding:12px; text-align:center;">PM Rule Met (Days)</th>
                        <th style="padding:12px; text-align:center;">Workflow Met (Days)</th>
                        <th style="padding:12px; text-align:center;">Total Absents</th>
                    </tr>
                </thead>
                <tbody>`;

                    summary.forEach(r => {
                        const absDisplay = r.absents > 0
                            ? `<span style="color:var(--danger); font-weight:800; font-size:15px;">-${r.absents} Days</span>`
                            : '<span style="color:#cbd5e1">-</span>';

                        html += `<tr class="rank-row">
                    <td style="padding:12px;">
                        <div style="font-weight:700">${r.name}</div>
                    </td>
                    <td style="padding:12px; text-align:center;">
                        <b>${r.daysActive}</b>
                    </td>
                    <td style="padding:12px; text-align:center;">
                        <span style="color:${r.targetMet === r.daysActive ? 'var(--primary)' : 'var(--text)'}">${r.targetMet}</span>
                        <span style="color:#94a3b8; font-size:10px;">/ ${r.daysActive}</span>
                    </td>
                    <td style="padding:12px; text-align:center;">
                        <span style="color:${r.pmMet === r.daysActive ? 'var(--primary)' : 'var(--text)'}">${r.pmMet}</span>
                        <span style="color:#94a3b8; font-size:10px;">/ ${r.daysActive}</span>
                    </td>
                    <td style="padding:12px; text-align:center;">
                        <span style="color:${r.workflowMet === r.daysActive ? 'var(--primary)' : 'var(--text)'}">${r.workflowMet}</span>
                        <span style="color:#94a3b8; font-size:10px;">/ ${r.daysActive}</span>
                    </td>
                    <td style="padding:12px; text-align:center;">
                        ${absDisplay}
                    </td>
                </tr>`;
                    });

                    html += `</tbody></table>`;
                    document.getElementById('log-body').innerHTML = html;
                    document.getElementById('modal-log').style.display = 'flex';
                },
                close() { document.getElementById('modal-log').style.display = 'none'; }
            };



            const BillVerifier = {
                URL: 'https://suthra.punjab.gov.pk/verify-bill',
                open(psid = '') {
                    const modal = document.getElementById('modal-verify-bill');
                    const iframe = document.getElementById('verify-iframe');
                    const loader = document.getElementById('verify-loader');
                    const label = document.getElementById('verify-psid-label');

                    label.innerText = psid ? `VERIFYING PSID: ${psid}` : 'EXTERNAL: SUTHRA PUNJAB';
                    loader.style.display = 'flex';
                    iframe.src = this.URL;
                    modal.style.display = 'flex';

                    if (psid) {
                        console.log("Tip: Copy PSID", psid, "to verify on the portal.");

                        const copySuccess = () => {
                            App.showToast ? App.showToast("PSID Copied! Click portal & Paste (Ctrl+V)") : console.log("PSID Copied");
                        };

                        if (navigator.clipboard && window.isSecureContext) {
                            navigator.clipboard.writeText(psid).then(copySuccess).catch(() => {
                                // If clipboard API fails, try fallback
                                this.fallbackCopy(psid);
                                copySuccess();
                            });
                        } else {
                            this.fallbackCopy(psid);
                            copySuccess();
                        }
                    }
                },
                fallbackCopy(text) {
                    try {
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        textArea.style.position = "fixed";  // Avoid scrolling to bottom
                        textArea.style.left = "-999999px";
                        textArea.style.top = "-999999px";
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        return successful;
                    } catch (err) {
                        console.error('Fallback copy failed', err);
                        return false;
                    }
                },
                close() {
                    const modal = document.getElementById('modal-verify-bill');
                    const iframe = document.getElementById('verify-iframe');
                    iframe.src = ''; // Clear src to stop loading
                    modal.style.display = 'none';
                    // Return to origin if applicable
                    if (State.originView === 'dashboard') ViewSwitcher.toDashboard();
                }
            };
            const PaidBills = {
                data: [],
                filtered: [],
                currentPage: 1,
                rowsPerPage: 10,
                activeType: 'all',
                idStatus: 'all',
                _fpStart: null,
                _fpEnd: null,

                setType(type) {
                    this.activeType = (this.activeType === type) ? 'all' : type;
                    this.currentPage = 1;
                    this.render();
                },

                init() {
                    const selector = document.getElementById('pb-city');
                    const typeSelector = document.getElementById('pb-type');
                    if (!selector) return;

                    // 1. Clear and Populate selectors
                    selector.innerHTML = '<option value="all">All Cities</option>';
                    typeSelector.innerHTML = '<option value="all">All Categories</option>';

                    const cities = new Set();
                    const categories = new Set();
                    PAID_DATA.forEach(r => {
                        if (r[3] && r[3] !== '-') cities.add(r[3]);
                        if (r[7] && r[7] !== '-') categories.add(r[7]);
                    });
                    Array.from(cities).sort().forEach(city => {
                        const opt = document.createElement('option');
                        opt.value = city; opt.innerText = city;
                        selector.appendChild(opt);
                    });
                    Array.from(categories).sort().forEach(cat => {
                        const opt = document.createElement('option');
                        opt.value = cat; opt.innerText = cat;
                        selector.appendChild(opt);
                    });
                    selector.value = 'all';
                    typeSelector.value = 'all';

                    // 2. Initialize Flatpickr
                    const commonCfg = {
                        dateFormat: "Y-m-d",
                        onChange: () => this.render(),
                        disableMobile: false
                    };
                    this._fpStart = flatpickr("#pb-date-start", commonCfg);
                    this._fpEnd = flatpickr("#pb-date-end", commonCfg);
                },

                open() {
                    if (!this._fpStart) this.init();

                    if (!document.getElementById('pb-date-start').value) {
                        const now = new Date();
                        const today = now.toISOString().split('T')[0];
                        this._fpStart.setDate(today);
                        this._fpEnd.setDate(today);
                    }

                    this.currentPage = 1;
                    this.render();
                    ViewSwitcher.toDashboard();
                },

                render() {
                    const start = document.getElementById('pb-date-start').value;
                    const end = document.getElementById('pb-date-end').value;
                    const city = document.getElementById('pb-city').value;
                    const category = document.getElementById('pb-type').value;
                    const idStatus = document.getElementById('pb-id-status')?.value || 'all';
                    const tbody = document.getElementById('pb-table-body');

                    // 1. Filter PAID_DATA
                    this.filtered = PAID_DATA.filter(r => {
                        const rSID = r[1];
                        const rDate = r[11]; // Paid Date
                        const rCity = r[3];
                        const rCat = r[7];

                        if (start && rDate < start) return false;
                        if (end && rDate > end) return false;
                        if (city !== 'all' && rCity !== city) return false;
                        if (category !== 'all' && rCat !== category) return false;

                        // ID Status Filter
                        if (idStatus === 'deleted' && rSID !== 'Deleted ID') return false;
                        if (idStatus === 'active' && rSID === 'Deleted ID') return false;

                        // Type Quick Filters (Domestic / Commercial)
                        if (this.activeType === 'domestic' && !rCat.toUpperCase().includes('DOMESTIC')) return false;
                        if (this.activeType === 'commercial' && !rCat.toUpperCase().includes('COMMERCIAL')) return false;

                        return true;
                    });

                    // 2. Filtered Stats (Reflect CURRENT results)
                    let filteredAmount = 0;
                    this.filtered.forEach(r => filteredAmount += parseFloat(r[12]) || 0);

                    document.getElementById('pb-total-amount').innerText = `Rs. ${filteredAmount.toLocaleString()}`;
                    document.getElementById('pb-total-count').innerText = this.filtered.length.toLocaleString();
                    document.getElementById('pb-avg-amount').innerText = this.filtered.length ? `Rs. ${Math.round(filteredAmount / this.filtered.length).toLocaleString()}` : 'Rs. 0';

                    // 3. Pagination Slicing
                    const totalRecords = this.filtered.length;
                    const totalPages = Math.ceil(totalRecords / this.rowsPerPage) || 1;
                    if (this.currentPage > totalPages) this.currentPage = totalPages;
                    if (this.currentPage < 1) this.currentPage = 1;

                    const startIdx = (this.currentPage - 1) * this.rowsPerPage;
                    const pageData = this.filtered.slice(startIdx, startIdx + parseInt(this.rowsPerPage));

                    // 4. Render Table Rows
                    if (pageData.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="13" style="text-align:center; padding:60px; color:#94a3b8;">
                    <span class="material-icons-round" style="font-size:48px; opacity:0.2; display:block; margin-bottom:10px;">search_off</span>
                    No records found for the selected criteria.
                    <br><small>Global Registry contains ${PAID_DATA.length} records.</small>
                </td></tr>`;
                    } else {
                        tbody.innerHTML = pageData.map(r => {
                            const sid = r[1];
                            const sidDisplay = sid === "Deleted ID" ? `<span class="paid-deleted-id">Deleted ID</span>` : `<span class="paid-id-link">#${sid}</span>`;

                            return `
                        <tr onclick="PaidBills.jumpToRecord('${sid}')">
                            <td data-label="Sr#">${r[0]}</td>
                            <td data-label="Survey ID">${sidDisplay}</td>
                            <td data-label="PSID" style="font-family:monospace; font-weight:700; color:#475569;">${r[2]}</td>
                            <td data-label="City">${r[3]}</td>
                            <td data-label="Month">${r[4]}</td>
                            <td data-label="Office">${r[5]}</td>
                            <td data-label="Area">${r[6]}</td>
                            <td data-label="Category" style="font-size:11px; font-weight:700; color:#64748b;">${r[7]}</td>
                            <td data-label="Due Amount">Rs. ${parseFloat(r[8]).toLocaleString()}</td>
                            <td data-label="Fine">Rs. ${parseFloat(r[9]).toLocaleString()}</td>
                            <td data-label="Channel" style="font-size:11px; font-weight:700; color:#64748b;">${r[10]}</td>
                            <td data-label="Paid Date" style="font-weight:600;">${r[11]}</td>
                            <td data-label="Paid Amount" style="font-weight:800; color:#16a34a;">Rs. ${parseFloat(r[12]).toLocaleString()}</td>
                        </tr>
                    `;
                        }).join('');
                    }

                    // 5. Update Footer
                    const endIdx = Math.min(startIdx + parseInt(this.rowsPerPage), totalRecords);
                    document.getElementById('pb-record-range').innerText = totalRecords ? `Showing ${startIdx + 1}-${endIdx} of ${totalRecords}` : 'Showing 0-0';
                    document.getElementById('pb-page-info').innerText = `Page ${this.currentPage} of ${totalPages}`;
                    document.getElementById('pb-prev').disabled = this.currentPage <= 1;
                    document.getElementById('pb-next').disabled = this.currentPage >= totalPages;

                    // 5.5 Update Button Visual States
                    document.querySelectorAll('.dash-type-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.getAttribute('data-type') === this.activeType);
                    });
                    const allBtn = document.getElementById('pb-all-records-btn');
                    if (allBtn) allBtn.classList.toggle('active', this.activeType === 'all');

                    // 6. Sidebar Analytics (UC and Category breakdown)
                    this.renderAnalyticPanels();
                },

                renderAnalyticPanels() {
                    // UC Breakdown (Left)
                    const ucMap = {}; // { UC: { amount, count } }
                    this.filtered.forEach(r => {
                        const uc = r[6] || 'Unassigned';
                        if (!ucMap[uc]) ucMap[uc] = { amt: 0, count: 0 };
                        ucMap[uc].amt += parseFloat(r[12]) || 0;
                        ucMap[uc].count++;
                    });

                    const ucSorted = Object.entries(ucMap).sort((a, b) => b[1].amt - a[1].amt);
                    const ucList = document.getElementById('pb-uc-summary');
                    ucList.innerHTML = ucSorted.map(([name, data], idx) => {
                        const isTop5 = idx < 5;
                        const badge = isTop5 ? `<span class="top-5-badge">#${idx + 1} TOP PERFORMANCE</span>` : "";
                        return `
                    <div class="analytics-item">
                        <div style="flex:1">
                            <div class="name">${name}</div>
                            ${badge}
                        </div>
                        <div class="value">
                            <div>Rs. ${Math.round(data.amt).toLocaleString()}</div>
                            <div class="sub">${data.count} Bills</div>
                        </div>
                    </div>
                `;
                    }).join('');

                    // Category Breakdown (Right)
                    const catMap = {};
                    this.filtered.forEach(r => {
                        const cat = r[7] || 'Other';
                        if (!catMap[cat]) catMap[cat] = { amt: 0, count: 0 };
                        catMap[cat].amt += parseFloat(r[12]) || 0;
                        catMap[cat].count++;
                    });

                    const catSorted = Object.entries(catMap).sort((a, b) => b[1].amt - a[1].amt);
                    const catList = document.getElementById('pb-category-summary');
                    catList.innerHTML = catSorted.map(([name, data]) => `
                <div class="analytics-item">
                    <div class="name" style="font-size:11px">${name}</div>
                    <div class="value">
                        <div style="color:var(--primary)">Rs. ${Math.round(data.amt).toLocaleString()}</div>
                        <div class="sub">${data.count} Bills</div>
                    </div>
                </div>
            `).join('');
                },

                setRows(val) {
                    this.rowsPerPage = parseInt(val);
                    this.currentPage = 1;
                    this.render();
                },

                changePage(delta) {
                    this.currentPage += delta;
                    this.render();
                    document.querySelector('.paid-table-container').scrollTop = 0;
                },

                jumpToRecord(id) {
                    if (id === "Deleted ID" || !id) {
                        App.showToast ? App.showToast("Record not available.") : alert("Record missing");
                        return;
                    }
                    // IMMEDIATE V7.3.5 FIX: FORCE HIDE STAGE
                    const stage = document.getElementById('paid-dashboard-stage');
                    if (stage) stage.style.display = 'none';

                    State.originView = 'dashboard';
                    ListView.jumpFromMap(id);
                },

                toggleSidebar() {
                    const layout = document.getElementById('dash-layout');
                    const sidebar = document.getElementById('dash-sidebar');
                    layout.classList.toggle('sidebar-collapsed');
                    sidebar.classList.toggle('active');
                },

                reset() {
                    document.getElementById('pb-city').value = 'all';
                    document.getElementById('pb-type').value = 'all';
                    const statusEl = document.getElementById('pb-id-status');
                    if (statusEl) statusEl.value = 'all';
                    this.activeType = 'all';

                    if (this._fpStart) this._fpStart.clear();
                    if (this._fpEnd) this._fpEnd.clear();
                    this.currentPage = 1;
                    this.render();
                },

                close() {
                    ViewSwitcher.toMap();
                    Sidebar.close();
                }
            };
            const PremiumSelect = {
                init(id, options, defaultLabel, onChange) {
                    const container = document.getElementById(id);
                    if (!container) return;

                    container.innerHTML = `
                <div class="custom-select-wrapper" id="${id}-wrapper">
                    <div class="custom-select-trigger">
                        <span class="trigger-text">${defaultLabel}</span>
                        <span class="material-icons-round">expand_more</span>
                    </div>
                    <div class="custom-select-options">
                        <div class="option-item active" data-value="all">${defaultLabel}</div>
                        ${options.map(opt => `<div class="option-item" data-value="${opt}">${opt}</div>`).join('')}
                    </div>
                </div>
            `;

                    const wrapper = container.querySelector('.custom-select-wrapper');
                    const trigger = wrapper.querySelector('.custom-select-trigger');

                    trigger.onclick = (e) => {
                        e.stopPropagation();
                        const isOpen = wrapper.classList.contains('open');
                        document.querySelectorAll('.custom-select-wrapper').forEach(el => el.classList.remove('open'));
                        if (!isOpen) wrapper.classList.add('open');
                    };

                    wrapper.querySelectorAll('.option-item').forEach(item => {
                        item.onclick = (e) => {
                            e.stopPropagation();
                            const val = item.getAttribute('data-value');
                            wrapper.querySelector('.trigger-text').innerText = item.innerText;
                            wrapper.classList.remove('open');

                            wrapper.querySelectorAll('.option-item').forEach(i => i.classList.remove('active'));
                            item.classList.add('active');

                            if (onChange) onChange(val);
                        };
                    });

                    if (!window._psGlobal) {
                        document.addEventListener('click', () => {
                            document.querySelectorAll('.custom-select-wrapper').forEach(el => el.classList.remove('open'));
                        });
                        window._psGlobal = true;
                    }
                },
                getValue(id) {
                    const wrapper = document.getElementById(`${id}-wrapper`);
                    if (!wrapper) return 'all';
                    const active = wrapper.querySelector('.option-item.active');
                    return active ? active.getAttribute('data-value') : 'all';
                }
            };
            const UniversalSearch = {
                _timeout: null,
                _initDone: false,
                _tehsils: [],
                _mcucs: [],
                _surveyors: [],

                init(force = false) {
                    if (this._initDone && !force) return;
                    if (typeof RAW_DATA === 'undefined' || !RAW_DATA.length) return;

                    this._tehsils = [...new Set(RAW_DATA.map(r => r[11]))].filter(x => x).sort();
                    this._mcucs = [...new Set(RAW_DATA.map(r => r[12]))].filter(x => x).sort();
                    this._surveyors = [...new Set(RAW_DATA.map(r => r[6]))].filter(x => x).sort();

                    this.renderCustomSelects();
                    this._initDone = true;
                },
                renderCustomSelects() {
                    PremiumSelect.init('search-tehsil', this._tehsils, 'All Tehsils', (v) => this.onTehsilChange(v));
                    PremiumSelect.init('search-mcuc', this._mcucs, 'All Areas', () => this.performSearch(document.getElementById('universal-search-input').value));
                    PremiumSelect.init('search-surveyor', this._surveyors, 'All Surveyors', () => this.performSearch(document.getElementById('universal-search-input').value));
                },
                onTehsilChange(tehsil) {
                    if (tehsil === 'all') {
                        PremiumSelect.init('search-mcuc', this._mcucs, 'All Areas', () => this.performSearch(document.getElementById('universal-search-input').value));
                    } else {
                        const filteredMCs = [...new Set(RAW_DATA.filter(r => r[11] === tehsil).map(r => r[12]))].sort();
                        PremiumSelect.init('search-mcuc', filteredMCs, `Areas in ${tehsil}`, () => this.performSearch(document.getElementById('universal-search-input').value));
                    }
                    this.performSearch(document.getElementById('universal-search-input').value);
                },
                open() {
                    const modal = document.getElementById('modal-search');
                    modal.style.display = 'flex';
                    const input = document.getElementById('universal-search-input');
                    if (!this._initDone) this.init();
                    input.value = '';
                    input.focus();
                    this.renderResults([]);
                },
                close() {
                    document.getElementById('modal-search').style.display = 'none';
                },
                handleInput(val) {
                    if (this._timeout) clearTimeout(this._timeout);
                    this._timeout = setTimeout(() => this.performSearch(val), 200);
                },
                performSearch(query) {
                    const q = query.trim().toLowerCase();
                    const tehsilSub = PremiumSelect.getValue('search-tehsil');
                    const mcucSub = PremiumSelect.getValue('search-mcuc');
                    const surveyorSub = PremiumSelect.getValue('search-surveyor');

                    if (!q && tehsilSub === 'all' && mcucSub === 'all' && surveyorSub === 'all') {
                        this.renderResults([]);
                        return;
                    }

                    const selectedCats = Array.from(document.querySelectorAll('.search-cat:checked')).map(cb => cb.getAttribute('data-field'));
                    const isGlobal = selectedCats.length === 0;

                    const dataSource = State.searchLocalOnly ? State.filtered : RAW_DATA;

                    const results = dataSource.filter(r => {
                        const name = decodePII(r[4]);
                        const addr = decodePII(r[5]);
                        const psid = decodePII(r[15]);

                        // Region filters in the modal are additional constraints
                        if (tehsilSub !== 'all' && r[11] !== tehsilSub) return false;
                        if (mcucSub !== 'all' && r[12] !== mcucSub) return false;
                        if (surveyorSub !== 'all' && r[6] !== surveyorSub) return false;

                        if (!q) return true;

                        if (isGlobal) {
                            return (r[0] && r[0].toString().toLowerCase().includes(q)) ||
                                (psid && psid.toString().toLowerCase().includes(q)) ||
                                (name && name.toLowerCase().includes(q)) ||
                                (addr && addr.toLowerCase().includes(q)) ||
                                (r[12] && r[12].toLowerCase().includes(q)) ||
                                (r[6] && r[6].toLowerCase().includes(q));
                        } else {
                            if (selectedCats.includes('id') && r[0] && r[0].toString().toLowerCase().includes(q)) return true;
                            if (selectedCats.includes('psid') && psid && psid.toString().toLowerCase().includes(q)) return true;
                            if (selectedCats.includes('name') && name && name.toLowerCase().includes(q)) return true;
                            if (selectedCats.includes('addr') && addr && addr.toLowerCase().includes(q)) return true;
                            if (selectedCats.includes('surveyor') && r[6] && r[6].toLowerCase().includes(q)) return true;
                            if (selectedCats.includes('mcuc') && r[12] && r[12].toLowerCase().includes(q)) return true;
                            return false;
                        }
                    });

                    this.renderResults(results);
                },
                renderResults(results) {
                    const container = document.getElementById('search-results-list');
                    document.getElementById('search-count').innerText = `${results.length} RECORDS FOUND`;

                    if (results.length === 0) {
                        container.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#94a3b8;">
                        <span class="material-icons-round" style="font-size:48px; opacity:0.3; margin-bottom:8px;">search_off</span>
                        <div>No matching records found.</div>
                    </div>
                `;
                        return;
                    }

                    container.innerHTML = results.map(r => `
                <div class="search-item" onclick="UniversalSearch.jump('${r[0]}', 'list')">
                    <div class="search-item-main" style="flex:1; min-width:0;">
                        <div class="search-item-title">#${r[0]} | ${decodePII(r[4])}</div>
                        <div class="search-item-sub">${decodePII(r[15])} | ${decodePII(r[5])}</div>
                        <span class="search-item-meta">${r[11]} - ${r[12]}</span>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end; flex-shrink:0;">
                         <div style="display:flex; gap:6px;">
                            <button class="float-btn" onclick="event.stopPropagation(); UniversalSearch.jump('${r[0]}', 'map')" title="Marker" style="width:75px; height:32px; border-radius:10px; background:#eff6ff; color:#2563eb; border:1.5px solid #dbeafe; display:flex; gap:6px; font-size:10px; font-weight:800; align-items:center; justify-content:center;">
                                <span class="material-icons-round" style="font-size:16px;">place</span> MARKER
                            </button>
                            <button class="float-btn" onclick="event.stopPropagation(); UniversalSearch.jump('${r[0]}', 'list')" title="List" style="width:65px; height:32px; border-radius:10px; background:#f0fdf4; color:#16a34a; border:1.5px solid #dcfce7; display:flex; gap:6px; font-size:10px; font-weight:800; align-items:center; justify-content:center;">
                                <span class="material-icons-round" style="font-size:16px;">list_alt</span> LIST
                            </button>
                         </div>
                         <div class="search-badge">${r[6]}</div>
                    </div>
                </div>
            `).join('');
                },
                jump(id, mode) {
                    this.close();
                    // Synchronize context
                    const idx = State.filtered.findIndex(r => r[0].toString() === id.toString());
                    if (idx !== -1) {
                        State.currentIdx = idx;
                        if (window.MapNavigator) MapNavigator.updateUI();
                    }

                    if (mode === 'map') {
                        ListView.showOnMap(id);
                    } else {
                        ListView.jumpFromMap(id);
                    }
                }
            };



            // Expose Globals explicitly for inline event handlers and external access (Moved to bottom)
            const SpatialRouter = {
                isDrawing: false,
                isLocked: false,
                points: [],
                capturedIDs: [],
                sequence: [],
                startId: null,
                endId: null,
                undoStack: [],
                redoStack: [],
                backgroundLayers: [],
                drawnPolygons: [],
                currentDrawLayer: null,
                activeTab: 'editor',
                isEditing: false,
                pickingMode: null,
                activePolygon: null, // Track currently selected polygon
                activeDisplayRoutes: [], // Array of route names currently on map
                batchRouteSequences: [], // NEW: Store separate sequences for batch display rendering
                batchRoutePolygons: [], // NEW: Store separate polygons for batch display

                saveSnapshot() {
                    this.undoStack.push({
                        sequence: JSON.parse(JSON.stringify(this.sequence)),
                        capturedIDs: [...this.capturedIDs],
                        startId: this.startId,
                        endId: this.endId
                    });
                    if (this.undoStack.length > 20) this.undoStack.shift();
                    this.redoStack = [];
                },
                undo() {
                    if (!this.undoStack.length) { if (App.showToast) App.showToast('Nothing to undo.'); return; }
                    this.redoStack.push({
                        sequence: JSON.parse(JSON.stringify(this.sequence)),
                        capturedIDs: [...this.capturedIDs],
                        startId: this.startId,
                        endId: this.endId
                    });
                    const snap = this.undoStack.pop();
                    this.sequence = snap.sequence;
                    this.capturedIDs = snap.capturedIDs;
                    this.startId = snap.startId;
                    this.endId = snap.endId;
                    this.syncState();
                    this.renderRoute();
                },
                redo() {
                    if (!this.redoStack.length) { if (App.showToast) App.showToast('Nothing to redo.'); return; }
                    this.undoStack.push({
                        sequence: JSON.parse(JSON.stringify(this.sequence)),
                        capturedIDs: [...this.capturedIDs],
                        startId: this.startId,
                        endId: this.endId
                    });
                    const snap = this.redoStack.pop();
                    this.sequence = snap.sequence;
                    this.capturedIDs = snap.capturedIDs;
                    this.startId = snap.startId;
                    this.endId = snap.endId;
                    this.syncState();
                    this.renderRoute();
                },

                init() {
                    console.log("SpatialRouter.init starting...");
                    this.backgroundLayers = [];
                    this.drawnPolygons = [];
                    this.isEditing = false;

                    if ((!State.savedRoutes || State.savedRoutes.length === 0) && window.RAW_ROUTES) {
                        State.savedRoutes = window.RAW_ROUTES;
                    }
                    if (!State.savedRoutes) State.savedRoutes = [];

                    this.renderSavedList();
                    this.renderRouteManager();
                    this.activeTab = 'editor';
                    this.activeDisplayRoutes = []; // Array of route names currently on map
                    this.setEditMode(false);

                    // Fix: Catch potential errors in loadRoutes to prevent init crash
                    this.loadRoutes(null, true).catch(err => console.warn("Initial loadRoutes failed:", err));

                    setInterval(() => this.checkServerHealth(), 5000);

                    // Bind dummy handlers placeholders (Will be properly assigned during startDrawing)
                    this.onClick = () => { };
                    this.onContext = () => { };

                    // Setup Draw Control logic
                    if (State.map && L.Control.Draw) {
                        const drawControl = new L.Control.Draw({
                            draw: {
                                polygon: { shapeOptions: { color: '#3b82f6', weight: 2 } },
                                polyline: false, circle: false, rectangle: false, marker: false, circlemarker: false
                            },
                            edit: false
                        });
                        State.map.addControl(drawControl);
                        State.map.on(L.Draw.Event.CREATED, (e) => {
                            if (e.layerType === 'polygon') {
                                const layer = e.layer;
                                if (!this.drawnPolygons) this.drawnPolygons = [];
                                this.drawnPolygons.push(layer);
                                State.map.addLayer(layer);
                                const latlngs = layer.getLatLngs()[0];
                                const polyPts = latlngs.map(p => ({ lat: p.lat, lng: p.lng }));
                                this.harvest(polyPts);
                            }
                        });
                    }
                    console.log("SpatialRouter.init complete.");
                },

                setEditMode(val) {
                    this.isEditing = val;
                    const toolbar = document.getElementById('routing-toolbar-row');
                    if (toolbar) toolbar.style.display = (this.activeTab === 'editor' && val) ? 'flex' : (this.activeTab === 'editor' ? 'flex' : 'none');
                },

                _applyRoutes(data) {
                    if (data && Array.isArray(data)) {
                        window.RAW_ROUTES = data;
                        State.savedRoutes = data;
                        if (this.renderSavedList) this.renderSavedList();
                        if (this.renderRouteManager) this.renderRouteManager();
                    }
                },

                async loadRoutes(filename = null, isInitial = false) {
                    try {
                        const { data, error } = await window._supabase
                            .from('saved_routes')
                            .select('*')
                            .order('created_at', { ascending: true });

                        if (error) throw error;

                        const formattedData = data.map(item => ({
                            ...item.route_data,
                            id: item.id,
                            name: item.route_name || item.route_data.name
                        }));

                        this._applyRoutes(formattedData);
                        if (!isInitial && App.showToast) App.showToast("Cloud routes synced.");
                    } catch (e) {
                        console.warn("LoadRoutes error:", e);
                        if (isInitial && window.RAW_ROUTES) this._applyRoutes(window.RAW_ROUTES);
                    }
                },

                syncState() {
                    if (!State.originalFiltered || State.originalFiltered.length === 0) {
                        State.originalFiltered = [...(State.filtered || [])];
                    }
                    this.updateStats();
                },

                dumpDiagnostics() {
                    console.group("SpatialRouter Diagnostics");
                    console.log("Pool Size:", this.capturedIDs.length);
                    console.log("Seq Size:", this.sequence.length);
                    console.groupEnd();
                },

                async checkServerHealth() {
                    const badge = document.getElementById('sync-server-badge');
                    if (!badge) return;
                    try {
                        const { error } = await window._supabase
                            .from('saved_routes')
                            .select('id', { count: 'exact', head: true });
                        if (error) throw error;
                        badge.innerHTML = '<span style="font-size:8px;"> CLOUD</span>';
                        badge.style.background = '#ecfdf5';
                        badge.style.color = '#10b981';
                        badge.style.borderColor = '#a7f3d0';
                    } catch (e) {
                        badge.innerHTML = '<span style="font-size:8px;"> NO CLOUD</span>';
                        badge.style.background = '#fef2f2';
                        badge.style.color = '#ef4444';
                        badge.style.borderColor = '#fecaca';
                    }
                },

                toggleUI() {
                    const overlay = document.getElementById('routing-station-overlay');
                    if (!overlay) return;
                    const isHidden = overlay.style.display === 'none';
                    overlay.style.display = isHidden ? 'flex' : 'none';
                    if (isHidden) {
                        // DO NOT setEditMode(true) automatically. Wait for user instruction.
                        this.renderRoute();
                    } else {
                        this.finishDrawing();
                        this.clearActiveRoute(); // Clear markers and selections
                        this.setEditMode(false); // Turn off routing interaction
                    }
                },

                clear() {
                    this.resetCurrentRoute();
                },

                clearMapDisplay() {
                    // Clear persistent display layer
                    if (this._displayLayer) { State.map.removeLayer(this._displayLayer); this._displayLayer = null; }
                    this.activeDisplayRoutes = [];
                    // Also clear editor state
                    this.isBatchMode = false;
                    this.batchRouteSequences = [];
                    this.batchRoutePolygons = [];
                    this.sequence = [];
                    this.capturedIDs = [];
                    if (this.sequenceLayer) { this.sequenceLayer.clearLayers(); }
                    if (this.routeLayer) { State.map.removeLayer(this.routeLayer); this.routeLayer = null; }
                    // Uncheck all display checkboxes
                    document.querySelectorAll('.display-selector').forEach(cb => cb.checked = false);
                    this.renderRoute();
                    if (App.showToast) App.showToast('Map cleared.');
                },

                switchTab(tab) {
                    this.activeTab = tab;
                    const pEditor = document.getElementById('routing-editor-panel');
                    const pManager = document.getElementById('routing-manager-panel');
                    const tEditor = document.getElementById('tab-editor');
                    const tManager = document.getElementById('tab-manager');
                    const toolbar = document.getElementById('routing-toolbar-row');

                    if (pEditor) pEditor.style.display = tab === 'editor' ? 'flex' : 'none';
                    if (pManager) pManager.style.display = tab === 'manager' ? 'flex' : 'none';
                    if (tEditor) tEditor.classList.toggle('active', tab === 'editor');
                    if (tManager) tManager.classList.toggle('active', tab === 'manager');
                    if (toolbar) toolbar.style.display = tab === 'editor' ? 'flex' : 'none';

                    // Handle Active Routes Info Display
                    const info = document.getElementById('active-routes-info');
                    if (info) info.style.display = (tab === 'editor' && this.activeDisplayRoutes.length > 0) ? 'flex' : 'none';

                    if (tab === 'editor') this.renderRoute();
                    else this.renderRouteManager();
                },

                renderRouteManager() {
                    const list = document.getElementById('route-manager-list');
                    if (!list) return;

                    list.innerHTML = '';
                    if (!State.savedRoutes || !State.savedRoutes.length) {
                        list.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8;">No saved routes found.</div>';
                        return;
                    }
                    State.savedRoutes.forEach((route, idx) => {
                        const item = document.createElement('div');
                        item.className = 'v6-card';
                        item.style.padding = '8px';
                        item.innerHTML = `
                    <div style="display:flex; align-items:center; gap:8px;" onclick="event.stopPropagation()">
                        <!-- Export Select -->
                        <div style="display:flex; flex-direction:column; align-items:center; gap:2px;" title="Select for Export" onclick="event.stopPropagation()">
                            <span class="material-icons-round" style="font-size:12px; color:#94a3b8;">file_download</span>
                            <input type="checkbox" class="route-selector" value="${idx}" onclick="event.stopPropagation()" />
                        </div>
                        <div class="v6-badge" style="flex:0 0 24px;">${idx + 1}</div>
                        <div class="v6-card-body" style="min-width: 0; padding:0 4px;" onclick="event.stopPropagation()">
                            <div class="v6-card-title" style="font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${route.name || 'Untitled Route'}">${route.name || 'Untitled Route'}</div>
                            <div class="v6-card-sub" style="font-size: 9px;">${route.sequence ? route.sequence.length : 0} pts | ${route.timestamp || ''}</div>
                        </div>
                        <!-- Display Select -->
                        <div style="display:flex; flex-direction:column; align-items:center; gap:2px;" title="Select for Map Display" onclick="event.stopPropagation()">
                            <span class="material-icons-round" style="font-size:12px; color:#16a34a;">visibility</span>
                            <input type="checkbox" class="display-selector" value="${idx}" onclick="event.stopPropagation()" />
                        </div>
                        <button onclick="event.stopPropagation(); SpatialRouter.loadRoute(${idx})" class="v6-action-btn" style="color:var(--primary)" title="Load this single route">
                            <span class="material-icons-round" style="font-size:18px;">file_open</span>
                        </button>
                        <button onclick="event.stopPropagation(); SpatialRouter.deleteRouteServer(${idx})" class="v6-action-btn" style="color:#ef4444" title="Delete Permanent">
                            <span class="material-icons-round" style="font-size:18px;">delete</span>
                        </button>
                    </div>
                `;
                        list.appendChild(item);
                    });
                },

                toggleSelectAllRoutes(checked, type = 'export') {
                    const selector = type === 'export' ? '.route-selector' : '.display-selector';
                    document.querySelectorAll(selector).forEach(cb => cb.checked = checked);
                },

                loadRoute(idx) {
                    const r = State.savedRoutes[idx];
                    if (!r || !r.sequence) return;
                    this.isBatchMode = false;
                    this.batchRouteSequences = [];
                    this.batchRoutePolygons = [];
                    this.resetCurrentRoute();
                    this.editingRouteIdx = idx;
                    this.editingRouteId = r.id; // Store Supabase ID for updates
                    this.editingRouteName = r.name || `Route ${idx + 1}`;
                    this.capturedIDs = r.sequence.map(p => String(p.surveyId || p.id));
                    this.sequence = r.sequence.map(p => ({ id: String(p.surveyId || p.id), lat: p.lat, lng: p.lng, name: p.name }));
                    this.activeDisplayRoutes = [this.editingRouteName];
                    if (r.polygon) {
                        this.activePolygon = L.polygon(r.polygon, { color: '#3b82f6', fillOpacity: 0.1, weight: 2 });
                    }
                    this.setEditMode(true); // Enable map marker connection for this loaded route
                    this.renderRoute();
                    if (App.showToast) App.showToast(`Editing: ${this.editingRouteName}`);
                },

                batchLoadDisplay() {
                    const selected = Array.from(document.querySelectorAll('.display-selector:checked'));

                    // Clear previous display layer
                    if (this._displayLayer) { State.map.removeLayer(this._displayLayer); this._displayLayer = null; }
                    this.activeDisplayRoutes = [];

                    if (selected.length === 0) {
                        // Update info bar
                        const info = document.getElementById('active-routes-info');
                        if (info) info.style.display = 'none';
                        if (App.showToast) App.showToast("Display routes cleared.");
                        return;
                    }

                    // Build persistent display layer (independent of editor)
                    this._displayLayer = L.layerGroup().addTo(State.map);
                    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'];

                    selected.forEach((cb, rIdx) => {
                        const idx = parseInt(cb.value);
                        const r = State.savedRoutes[idx];
                        if (!r || !r.sequence) return;

                        this.activeDisplayRoutes.push(r.name || `Route ${idx + 1}`);
                        const color = colors[rIdx % colors.length];
                        const pts = [];

                        r.sequence.forEach((p, sIdx) => {
                            const lat = p.lat, lng = p.lng;
                            pts.push([lat, lng]);
                            const m = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'route-marker-square',
                                    html: sIdx + 1
                                }),
                                pane: 'routingMarkerPane'
                            }).addTo(this._displayLayer);
                            m.bindTooltip(`#${p.surveyId || p.id}`, { permanent: false, direction: 'top', offset: [0, -10] });
                            m.on('click', (e) => {
                                L.DomEvent.stopPropagation(e);
                                this.highlightMarker(String(p.surveyId || p.id), lat, lng);
                            });
                        });

                        if (pts.length > 1) {
                            L.polyline(pts, { color: color, weight: 3, opacity: 0.7, dashArray: '6,4' }).addTo(this._displayLayer);
                        }
                        if (r.polygon) {
                            L.polygon(r.polygon, { color: '#94a3b8', fillOpacity: 0.08, weight: 1.5, dashArray: '5,5', interactive: false }).addTo(this._displayLayer);
                        }
                    });

                    // Update info bar
                    const info = document.getElementById('active-routes-info');
                    if (info && this.activeTab === 'editor') info.style.display = this.activeDisplayRoutes.length > 0 ? 'flex' : 'none';

                    if (App.showToast) App.showToast(`Displaying ${selected.length} routes (background).`);
                },

                async deleteRouteServer(idx) {
                    const r = State.savedRoutes[idx];
                    if (!r || !confirm(`Delete "${r.name}" permanently from Cloud?`)) return;

                    try {
                        const { error } = await window._supabase
                            .from('saved_routes')
                            .delete()
                            .eq('id', r.id);

                        if (error) throw error;

                        State.savedRoutes.splice(idx, 1);
                        this.renderRouteManager();
                        if (App.showToast) App.showToast("Route deleted from Cloud.");
                    } catch (e) {
                        console.error("Supabase error during delete:", e);
                        if (App.showToast) App.showToast("Failed to delete from Cloud.");
                    }
                },


                batchExport() {
                    const selected = Array.from(document.querySelectorAll('.route-selector:checked')).map(cb => parseInt(cb.value));
                    if (selected.length === 0) { if (App.showToast) App.showToast("No routes selected."); return; }

                    let csv = "Global Seq,Route Seq,Route Name,Survey ID,Name,Lat,Lng\n";
                    let globalSeq = 1;

                    selected.forEach(idx => {
                        const r = State.savedRoutes[idx];
                        if (r && r.sequence) {
                            r.sequence.forEach((p, i) => {
                                csv += `${globalSeq},${i + 1},"${r.name || 'Untitled'}","${p.surveyId || p.id}","${p.name}",${p.lat},${p.lng}\n`;
                                globalSeq++;
                            });
                        }
                    });

                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Batch_Routes_Export_${new Date().toISOString().slice(0, 10)}.csv`;
                    a.click();
                    if (App.showToast) App.showToast(`Exported ${selected.length} routes.`);
                },

                importRouteFile(input) {
                    const file = input.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            if (Array.isArray(json)) {
                                State.savedRoutes = [...(State.savedRoutes || []), ...json];
                            } else if (json.sequence) {
                                State.savedRoutes.push(json);
                            }
                            this.renderRouteManager();
                            if (App.showToast) App.showToast("Route imported successfully.");
                        } catch (err) {
                            console.error(err);
                            if (App.showToast) App.showToast("Invalid route file.");
                        }
                    };
                    reader.readAsText(file);
                },

                isRoutingPanelOpen() {
                    const overlay = document.getElementById('routing-station-overlay');
                    return overlay && overlay.style.display !== 'none';
                },

                clearArea() {
                    if (this.selectionLayer) this.selectionLayer.clearLayers();
                    this.points = [];
                },

                autoNumber() {
                    if (this.capturedIDs.length === 0) return;
                    if (this.isLocked) { if (App.showToast) App.showToast("Sequence is locked."); return; }
                    this.saveSnapshot();
                    const sortedIDs = [...this.capturedIDs].sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true }));
                    this.sequence = sortedIDs.map(id => {
                        const row = window.RAW_DATA.find(r => String(r[0]) === String(id));
                        return row ? { id: String(id), lat: parseFloat(row[1]), lng: parseFloat(row[2]), name: decodePII(row[4]) } : null;
                    }).filter(Boolean);
                    this.renderRoute();
                },

                toggleLock() {
                    this.isLocked = !this.isLocked;
                    const btn = document.getElementById('btn-lock-seq');
                    if (btn) {
                        btn.innerHTML = `<span class="material-icons-round">${this.isLocked ? 'lock' : 'lock_open'}</span>`;
                        btn.style.color = this.isLocked ? '#ef4444' : '#64748b';
                    }
                    if (App.showToast) App.showToast(this.isLocked ? "Sequence Locked" : "Sequence Unlocked");
                },

                sortBySequenceNumber() {
                    if (this.sequence.length === 0) return;
                    this.saveSnapshot();
                    // Re-order capturedIDs to match sequence order
                    // IDs in sequence first, then IDs not in sequence (pool)
                    const seqIds = this.sequence.map(p => p.id);
                    const poolIds = this.capturedIDs.filter(id => !seqIds.includes(String(id)));
                    this.capturedIDs = [...seqIds, ...poolIds];
                    this.renderRoute();
                    if (App.showToast) App.showToast("Sorted list by sequence.");
                },

                setStart(id) {
                    if (this.isLocked) return;
                    this.saveSnapshot();
                    const sid = String(id);
                    this.startId = sid;
                    const seqIdx = this.sequence.findIndex(p => String(p.id) === sid);
                    let item = null;
                    if (seqIdx !== -1) item = this.sequence.splice(seqIdx, 1)[0];
                    else {
                        const row = window.RAW_DATA.find(r => String(r[0]) === sid);
                        if (row) item = { id: sid, lat: parseFloat(row[1]), lng: parseFloat(row[2]), name: decodePII(row[4]) };
                    }
                    if (item) {
                        this.sequence.unshift(item);
                        if (!this.capturedIDs.includes(sid)) this.capturedIDs.push(sid);
                    }
                    this.renderRoute();
                },

                setEnd(id) {
                    if (this.isLocked) return;
                    this.saveSnapshot();
                    const sid = String(id);
                    this.endId = sid;
                    const seqIdx = this.sequence.findIndex(p => String(p.id) === sid);
                    let item = null;
                    if (seqIdx !== -1) item = this.sequence.splice(seqIdx, 1)[0];
                    else {
                        const row = window.RAW_DATA.find(r => String(r[0]) === sid);
                        if (row) item = { id: sid, lat: parseFloat(row[1]), lng: parseFloat(row[2]), name: decodePII(row[4]) };
                    }
                    if (item) {
                        this.sequence.push(item);
                        if (!this.capturedIDs.includes(sid)) this.capturedIDs.push(sid);
                    }
                    this.renderRoute();
                },

                sortByID(direction = 'asc') {
                    this.saveSnapshot();
                    const cmp = (a, b) => direction === 'asc' ? String(a).localeCompare(String(b), undefined, { numeric: true }) : String(b).localeCompare(String(a), undefined, { numeric: true });
                    this.capturedIDs.sort(cmp);
                    this.sequence.sort((a, b) => cmp(a.id, b.id));
                    this.renderRoute();
                },


                isPointInPoly(pt, polyPts) {
                    const x = pt[0], y = pt[1];
                    let inside = false;
                    for (let i = 0, j = polyPts.length - 1; i < polyPts.length; j = i++) {
                        const xi = polyPts[i].lat, yi = polyPts[i].lng;
                        const xj = polyPts[j].lat, yj = polyPts[j].lng;

                        // Harden: Avoid vertical segment division errors and range checks
                        const intersect = ((yi > y) !== (yj > y)) &&
                            (x < (xj - xi) * (y - yi) / (yj - yi + 0.0000000001) + xi);
                        if (intersect) inside = !inside;
                    }
                    return inside;
                },

                harvest(polyPts = null) {
                    const searchPool = State.filtered || [];
                    const pts = polyPts || this.points;
                    if (!pts || pts.length < 3) return [];

                    this.saveSnapshot();
                    let added = 0;
                    const newIds = [];
                    searchPool.forEach(row => {
                        const lat = parseFloat(row[1]);
                        const lng = parseFloat(row[2]);
                        if (this.isPointInPoly([lat, lng], pts)) {
                            const sid = String(row[0]);
                            newIds.push(sid);
                            if (!this.capturedIDs.includes(sid)) {
                                this.capturedIDs.push(sid);
                                added++;
                            }
                        }
                    });

                    if (this.drawnPolygons) {
                        this.drawnPolygons.forEach(p => p.setStyle({ color: '#94a3b8', fillOpacity: 0.1, weight: 1.5 }));
                    }

                    if (added > 0) {
                        if (App.showToast) App.showToast(`Found ${added} items.`);
                        this.renderRoute();
                    }
                    return newIds;
                },

                setPickingMode(type) {
                    this.pickingMode = type;
                    document.body.classList.add('picking-point');
                    if (App.showToast) App.showToast(`Click a marker to set ${type.toUpperCase()}`);
                },
                pickStart() { this.setPickingMode('start'); },
                pickEnd() { this.setPickingMode('end'); },

                addManualPoint(row) {
                    if (this.isLocked) return;
                    this.saveSnapshot();
                    const sid = String(row[0]);
                    if (this.sequence.find(p => String(p.id) === sid)) return;
                    if (!this.capturedIDs.includes(sid)) this.capturedIDs.push(sid);
                    this.sequence.push({ id: sid, lat: parseFloat(row[1]), lng: parseFloat(row[2]), name: decodePII(row[4]) });
                    this.renderRoute();
                },

                addManualID(id) {
                    const row = window.RAW_DATA.find(r => String(r[0]) === String(id));
                    if (row) this.addManualPoint(row);
                },

                updateSequenceManual(sid, newPos) {
                    let pos = parseInt(newPos);
                    if (isNaN(pos) || pos < 1) { this.renderRoute(); return; }

                    this.saveSnapshot();
                    const sidStr = String(sid);
                    const idx = this.sequence.findIndex(p => String(p.id) === sidStr);

                    if (idx === -1) {
                        // If not in sequence, find in RAW_DATA and add it at the requested position
                        const row = window.RAW_DATA.find(r => String(r[0]) === sidStr);
                        if (row) {
                            const item = { id: sidStr, lat: parseFloat(row[1]), lng: parseFloat(row[2]), name: decodePII(row[4]) };
                            this.sequence.splice(pos - 1, 0, item);
                            if (!this.capturedIDs.includes(sidStr)) this.capturedIDs.push(sidStr);
                        }
                    } else {
                        // Move existing item to new position
                        const item = this.sequence.splice(idx, 1)[0];
                        this.sequence.splice(pos - 1, 0, item);
                    }

                    // Sync capturedIDs order with sequence
                    const seqIds = this.sequence.map(p => p.id);
                    const poolIds = this.capturedIDs.filter(id => !seqIds.includes(String(id)));
                    this.capturedIDs = [...seqIds, ...poolIds];

                    this.renderRoute();
                    this.syncState();
                    if (App.showToast) App.showToast(`Moved #${sid} to position ${pos}`);
                },

                removeFromSequence(id) {
                    this.saveSnapshot();
                    const sid = String(id);
                    this.sequence = this.sequence.filter(p => String(p.id) !== sid);
                    this.capturedIDs = this.capturedIDs.filter(cid => String(cid) !== sid);
                    this.renderRoute();
                },

                assignToSequence(id, pos) {
                    this.saveSnapshot();
                    const sid = String(id);
                    if (this.sequence.find(p => String(p.id) === sid)) return;
                    const row = window.RAW_DATA.find(r => String(r[0]) === sid);
                    if (!row) return;
                    const idx = Math.max(0, Math.min((pos || this.sequence.length + 1) - 1, this.sequence.length));
                    this.sequence.splice(idx, 0, { id: sid, lat: parseFloat(row[1]), lng: parseFloat(row[2]), name: decodePII(row[4]) });
                    this.renderRoute();
                },

                removeFromSequenceOnly(id) {
                    this.saveSnapshot();
                    this.sequence = this.sequence.filter(p => String(p.id) !== String(id));
                    this.renderRoute();
                },

                handleMarkerClick(id) {
                    if (this.pickingMode) {
                        if (this.pickingMode === 'start') this.setStart(id);
                        else if (this.pickingMode === 'end') this.setEnd(id);
                        this.pickingMode = null;
                        document.body.classList.remove('picking-point');
                        return true;
                    }
                    return false;
                },

                updateStats() {
                    const countEl = document.getElementById('route-count');
                    const statsEl = document.getElementById('route-stats');
                    const navText = document.getElementById('route-nav-text');

                    const hasData = this.capturedIDs.length > 0;
                    if (statsEl) statsEl.style.display = hasData ? 'flex' : 'none';
                    if (countEl) countEl.innerText = `${this.sequence.length} / ${this.capturedIDs.length}`;
                    if (navText) navText.innerText = `${this.sequence.length} Seq`;
                },

                toggleSize(forceMinimize = false) {
                    const body = document.getElementById('routing-body');
                    const overlay = document.getElementById('routing-station-overlay');
                    if (!body || !overlay) return;
                    const isMinimized = body.style.display === 'none';
                    const shouldHide = forceMinimize || !isMinimized;
                    body.style.display = shouldHide ? 'none' : 'flex';
                    overlay.style.height = shouldHide ? 'auto' : (overlay.dataset.prevHeight || '60vh');
                    if (!shouldHide) overlay.dataset.prevHeight = overlay.style.height;
                },

                simpleOptimize() {
                    if (this.capturedIDs.length < 2) return;
                    this.saveSnapshot();
                    const pool = this.capturedIDs.map(id => {
                        const row = window.RAW_DATA.find(r => String(r[0]) === String(id));
                        return { id: String(id), lat: parseFloat(row[1]), lng: parseFloat(row[2]), name: decodePII(row[4]) };
                    });
                    const optimized = [];
                    let current = pool.shift();
                    optimized.push(current);
                    while (pool.length > 0) {
                        let bestIdx = 0, minDist = Infinity;
                        for (let i = 0; i < pool.length; i++) {
                            const d = Math.sqrt(Math.pow(current.lat - pool[i].lat, 2) + Math.pow(current.lng - pool[i].lng, 2));
                            if (d < minDist) { minDist = d; bestIdx = i; }
                        }
                        current = pool.splice(bestIdx, 1)[0];
                        optimized.push(current);
                    }
                    this.sequence = optimized;
                    this.renderRoute();
                },

                resetCurrentRoute() {
                    if (this.sequence.length > 0 || this.capturedIDs.length > 0) {
                        if (this.activePolygon) {
                            this.saveStateToPolygon(this.activePolygon);
                            this.activePolygon.setStyle({ color: '#94a3b8', weight: 1.5 });
                            this.activePolygon = null;
                        }
                    }

                    this.saveSnapshot();
                    this.isBatchMode = false;
                    this.editingRouteIdx = null;
                    this.editingRouteName = null;
                    this.sequence = [];
                    this.capturedIDs = [];
                    this.startId = null;
                    this.endId = null;
                    this.activeDisplayRoutes = [];
                    this.batchRouteSequences = [];
                    this.batchRoutePolygons = [];
                    this.renderRoute();
                    if (App.showToast) App.showToast("Starting new area...");
                },

                reverseSequence() {
                    this.saveSnapshot();
                    this.sequence.reverse();
                    this.renderRoute();
                },

                moveInSequence(dir) {
                    if (this.sequence.length === 0) return;
                    this._seqNavIdx = ((this._seqNavIdx || 0) + dir + this.sequence.length) % this.sequence.length;
                    const p = this.sequence[this._seqNavIdx];
                    if (p && State.map) {
                        State.map.panTo([p.lat, p.lng]);
                        this.highlightMarker(p.id);
                        this.highlightListItem(p.id);
                        const navText = document.getElementById('route-nav-text');
                        if (navText) navText.innerText = `${this._seqNavIdx + 1}/${this.sequence.length}`;
                    }
                },

                renderSavedList() {
                    const side = document.getElementById('side-route-list');
                    if (!side) return;
                    side.innerHTML = '';
                    (State.savedRoutes || []).forEach((r, i) => {
                        const div = document.createElement('div');
                        div.innerHTML = `<b>${r.name}</b>`;
                        div.onclick = () => this.load(r);
                        side.appendChild(div);
                    });
                },

                load(route) {
                    this.clearDrawingOnly();
                    this.capturedIDs = route.sequence.map(s => s.surveyId);
                    this.sequence = route.sequence.map(s => ({ id: s.surveyId, lat: s.lat, lng: s.lng, name: s.name }));
                    this.renderRoute();
                },

                renderRoute() {
                    const list = document.getElementById('route-list');
                    const init = document.getElementById('route-initial-state');
                    if (!list) return;

                    // BATCH MODE: grouped per-route sections
                    if (this.isBatchMode && this.batchRouteSequences.length > 0) {
                        list.innerHTML = '';
                        if (init) init.style.display = 'none';
                        const fragment = document.createDocumentFragment();

                        this.batchRouteSequences.forEach((seq, rIdx) => {
                            const header = document.createElement('div');
                            header.style.cssText = 'padding:6px 8px; font-size:10px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; background:#f8fafc; border-radius:6px; margin-top:' + (rIdx > 0 ? '8px' : '0') + '; display:flex; align-items:center; gap:6px;';
                            header.innerHTML = `<span class="material-icons-round" style="font-size:14px; color:var(--primary)">route</span> ${this.activeDisplayRoutes[rIdx] || 'Route ' + (rIdx + 1)} <span style="margin-left:auto; color:#94a3b8;">${seq.length} pts</span>`;
                            fragment.appendChild(header);

                            seq.forEach((p, sIdx) => {
                                const item = document.createElement('div');
                                item.className = 'v6-card';
                                item.setAttribute('data-sid', p.id);
                                const isStart = sIdx === 0;
                                const isEnd = sIdx === seq.length - 1;
                                item.innerHTML = `
                            <div class="v6-badge" style="background:${isStart ? '#10b981' : isEnd ? '#ef4444' : '#eff6ff'}; color:${isStart || isEnd ? 'white' : 'var(--primary)'}; font-size:10px;">${sIdx + 1}</div>
                            <div class="v6-card-body">
                                <div class="v6-card-title">#${p.id}</div>
                                <div class="v6-card-sub">${p.name || ''} | ${isStart ? 'Start' : isEnd ? 'End' : 'Seq'}</div>
                            </div>
                            <button onclick="event.stopPropagation(); ListView.jumpFromMap('${p.id}')" class="v6-action-btn" style="color:#64748b; margin-right:4px;" title="View Details">
                                <span class="material-icons-round" style="font-size:16px;">visibility</span>
                            </button>
                        `;
                                item.onclick = (e) => {
                                    e.stopPropagation();
                                    State.map.panTo([p.lat, p.lng]);
                                    this.highlightMarker(p.id, p.lat, p.lng);
                                };
                                fragment.appendChild(item);
                            });
                        });

                        list.appendChild(fragment);
                        this.refreshMapMarkers();
                        this.updateStats();
                        return;
                    }

                    // SINGLE MODE
                    list.innerHTML = '';
                    const count = this.capturedIDs.length;

                    if (count === 0) {
                        if (init) init.style.display = 'flex';
                        this.refreshMapMarkers();
                        this.updateStats();
                        return;
                    }
                    if (init) init.style.display = 'none';

                    const fragment = document.createDocumentFragment();
                    const seqMap = new Map();
                    this.sequence.forEach((p, i) => seqMap.set(String(p.id), { index: i, entry: p }));
                    const isMapReady = window.SID_MAP instanceof Map;

                    this.capturedIDs.forEach(sid => {
                        const sidStr = String(sid);
                        const row = isMapReady ? window.SID_MAP.get(sidStr) : null;
                        const seqData = seqMap.get(sidStr);
                        const seqEntry = seqData ? seqData.entry : null;
                        const lat = row ? parseFloat(row[1]) : (seqEntry ? seqEntry.lat : null);
                        const lng = row ? parseFloat(row[2]) : (seqEntry ? seqEntry.lng : null);
                        const name = row ? decodePII(row[4]) : (seqEntry ? seqEntry.name : '');
                        if (lat === null) return;

                        const seqIdx = seqData ? seqData.index : -1;
                        const isStart = seqIdx === 0;
                        const isEnd = seqIdx !== -1 && seqIdx === this.sequence.length - 1;

                        let area = row ? (row[12] || 'Area').replace(/Municipal Committee/gi, 'MC').replace(/Union Council/gi, 'UC') : '';
                        if (area) area = area.replace(/\s*(Bhalwal|Sargodha|Mianwali|Khushab|Tehsil)\s*/gi, '').trim();

                        const item = document.createElement('div');
                        item.className = 'v6-card';
                        item.setAttribute('data-sid', sid);

                        item.innerHTML = `
                    <div class="v6-badge" style="background:${isStart ? '#10b981' : isEnd ? '#ef4444' : ''}; padding:0; overflow:hidden; width:26px; height:24px;">
                        <input type="number" min="1" max="${this.sequence.length + 1}" value="${seqIdx === -1 ? '' : seqIdx + 1}" placeholder="-"
                               style="width:100%; height:100%; border:none; background:transparent; color:${(isStart || isEnd) ? 'white' : 'var(--primary)'}; text-align:center; font-size:10px; font-weight:800; outline:none; padding:0;"
                               onchange="SpatialRouter.updateSequenceManual('${sid}', this.value)"
                               onclick="event.stopPropagation()">
                    </div>
                    <div class="v6-card-body">
                        <div class="v6-card-title">#${sid}</div>
                        <div class="v6-card-sub">${area || name || ''} | ${seqIdx === -1 ? 'Pool' : (isStart ? 'Start' : isEnd ? 'End' : 'Sequenced')}</div>
                    </div>
                    <button onclick="event.stopPropagation(); ListView.jumpFromMap('${sid}')" class="v6-action-btn" style="color:#64748b; margin-right:4px;" title="View Details">
                        <span class="material-icons-round" style="font-size:16px;">visibility</span>
                    </button>
                    <button onclick="event.stopPropagation(); SpatialRouter.${seqIdx === -1 ? 'addToSequence' : 'removeFromSequence'}('${sid}')" class="v6-action-btn" style="color:${seqIdx === -1 ? '#10b981' : '#ef4444'}" title="${seqIdx === -1 ? 'Add to Route' : 'Remove from Route'}">
                        <span class="material-icons-round" style="font-size:18px;">${seqIdx === -1 ? 'library_add' : 'remove_circle'}</span>
                    </button>
                `;
                        item.onclick = (e) => {
                            e.stopPropagation();
                            State.map.panTo([lat, lng]);
                            this.highlightMarker(sid, lat, lng);
                        };
                        fragment.appendChild(item);
                    });

                    list.appendChild(fragment);
                    this.refreshMapMarkers();
                    this.updateStats();
                },

                refreshMapMarkers() {
                    if (!this.sequenceLayer) this.sequenceLayer = L.layerGroup().addTo(State.map);
                    this.sequenceLayer.clearLayers();

                    if (this.routeLayer) State.map.removeLayer(this.routeLayer);
                    this.routeLayer = L.layerGroup().addTo(State.map);

                    // BATCH MODE: per-route markers + separate polylines
                    if (this.isBatchMode && this.batchRouteSequences.length > 0) {
                        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'];

                        this.batchRouteSequences.forEach((seq, rIdx) => {
                            const color = colors[rIdx % colors.length];
                            const pts = [];

                            seq.forEach((p, sIdx) => {
                                pts.push([p.lat, p.lng]);
                                const m = L.marker([p.lat, p.lng], {
                                    icon: L.divIcon({
                                        className: 'route-marker-square',
                                        html: sIdx + 1
                                    }),
                                    pane: 'routingMarkerPane'
                                }).addTo(this.sequenceLayer);

                                m.on('click', (e) => {
                                    L.DomEvent.stopPropagation(e);
                                    this.highlightMarker(p.id, p.lat, p.lng);
                                    this.highlightListItem(p.id);
                                });
                                m.bindTooltip(`#${p.id}`, { permanent: false, direction: 'top', offset: [0, -10] });
                            });

                            if (pts.length > 1) {
                                L.polyline(pts, { color: color, weight: 3, opacity: 0.7, dashArray: '6,4' }).addTo(this.routeLayer);
                            }
                        });

                        (this.batchRoutePolygons || []).forEach(p => {
                            L.polygon(p, { color: '#94a3b8', fillOpacity: 0.08, weight: 1.5, dashArray: '5,5', interactive: false }).addTo(this.routeLayer);
                        });
                        return;
                    }

                    // SINGLE MODE
                    const seqMap = new Map();
                    this.sequence.forEach((p, i) => seqMap.set(String(p.id), { index: i, entry: p }));
                    const isMapReady = window.SID_MAP instanceof Map;

                    this.capturedIDs.forEach(sid => {
                        const sidStr = String(sid);
                        const row = isMapReady ? window.SID_MAP.get(sidStr) : null;
                        const seqData = seqMap.get(sidStr);
                        const seqEntry = seqData ? seqData.entry : null;
                        const lat = row ? parseFloat(row[1]) : (seqEntry ? seqEntry.lat : null);
                        const lng = row ? parseFloat(row[2]) : (seqEntry ? seqEntry.lng : null);
                        if (lat === null) return;
                        const idx = seqData ? seqData.index : -1;

                        const m = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: idx === -1 ? 'route-marker-pool-dot' : 'route-marker-square',
                                html: idx === -1 ? '' : (idx + 1)
                            }),
                            pane: 'routingMarkerPane'
                        }).addTo(this.sequenceLayer);

                        m.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            const currentIdx = this.sequence.findIndex(p => String(p.id) === sidStr);
                            if (currentIdx === -1) this.addToSequence(sidStr);
                            else this.removeFromSequence(sidStr);
                            this.highlightMarker(sidStr, lat, lng);
                            this.highlightListItem(sidStr);
                        });

                        // Option 1: Right-Click to jump to ListView
                        m.on('contextmenu', (e) => {
                            L.DomEvent.stopPropagation(e);
                            if (window.ListView && ListView.jumpFromMap) {
                                ListView.jumpFromMap(sid);
                            }
                        });

                        m.bindTooltip(`#${sid}`, { permanent: false, direction: 'top', offset: [0, -10] });

                        if (!this._markerMap) this._markerMap = {};
                        this._markerMap[sid] = m;
                    });

                    if (this.activePolygon && this.activePolygon._latlngs) {
                        const polyCoords = this.activePolygon.getLatLngs()[0];
                        L.polygon(polyCoords, { color: '#94a3b8', fillOpacity: 0.08, weight: 1.5, dashArray: '5,5', interactive: false }).addTo(this.routeLayer);
                    }

                    if (this.sequence && this.sequence.length > 1) {
                        const pts = this.sequence.map(p => [p.lat, p.lng]);
                        L.polyline(pts, { color: '#3b82f6', weight: 4, opacity: 0.8 }).addTo(this.routeLayer);
                    }
                },

                highlightListItem(sid) {
                    const list = document.getElementById('route-list');
                    if (!list) return;
                    const target = list.querySelector(`[data-sid="${sid}"]`);
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        target.style.transition = 'background 0.3s';
                        target.style.background = '#e0f2fe'; // Highlight color
                        setTimeout(() => target.style.background = 'white', 1500);
                    }
                    this.highlightMarker(sid);
                },

                highlightMarker(sid, optLat, optLng) {
                    let lat = optLat, lng = optLng;
                    if (lat === undefined || lng === undefined) {
                        const isMapReady = window.SID_MAP instanceof Map;
                        const row = isMapReady ? window.SID_MAP.get(String(sid)) : null;
                        if (!row) return;
                        lat = parseFloat(row[1]);
                        lng = parseFloat(row[2]);
                    }

                    const pulse = L.circleMarker([lat, lng], {
                        radius: 28,
                        color: '#3b82f6',
                        fillColor: '#3b82f6',
                        fillOpacity: 0.35,
                        weight: 3,
                        pane: 'routingMarkerPane'
                    }).addTo(State.map);

                    let op = 0.35;
                    const timer = setInterval(() => {
                        op -= 0.025;
                        if (op <= 0) {
                            clearInterval(timer);
                            State.map.removeLayer(pulse);
                        } else {
                            pulse.setStyle({ fillOpacity: op, opacity: op * 2 });
                        }
                    }, 40);
                },



                clearActiveRoute() {
                    if (this.activePolygon) {
                        State.map.removeLayer(this.activePolygon);
                        this.activePolygon = null;
                    }
                    if (this.drawnPolygons) {
                        this.drawnPolygons.forEach(p => State.map.removeLayer(p));
                        this.drawnPolygons = [];
                    }
                    if (this.routeLayer) this.routeLayer.clearLayers();
                    if (this.sequenceLayer) this.sequenceLayer.clearLayers();

                    this.capturedIDs = [];
                    this.sequence = [];
                    this.batchRouteSequences = [];
                    this.batchRoutePolygons = [];
                    this.isBatchMode = false;
                    this.resetCurrentRoute();
                    this.setEditMode(false); // Turn off marker connection mode
                    this.renderRoute();
                },

                startDrawing(mode = 'append') {
                    if (this.isDrawing) return this.finishDrawing();
                    if (mode === 'new') this.clearActiveRoute();

                    this.setEditMode(true);
                    this.isDrawing = true;
                    this.points = [];
                    State.map.getContainer().style.cursor = 'crosshair';
                    this.currentDrawLayer = L.layerGroup().addTo(State.map);

                    // Show Done/Cancel buttons
                    const btnDone = document.getElementById('btn-finish-draw');
                    const btnCancel = document.getElementById('btn-cancel-draw');
                    if (btnDone) btnDone.style.display = 'flex';
                    if (btnCancel) btnCancel.style.display = 'flex';

                    this._boundClick = (e) => {
                        this.points.push(e.latlng);
                        this.currentDrawLayer.clearLayers();
                        const poly = L.polygon(this.points, { color: '#3b82f6', fillOpacity: 0.1, weight: 2 }).addTo(this.currentDrawLayer);

                        // Shadow Markers Preview
                        if (this.points.length > 2) {
                            const polyPts = this.points.map(p => ({ lat: p.lat, lng: p.lng }));
                            const searchPool = State.filtered || [];
                            searchPool.forEach(row => {
                                if (this.isPointInPoly([parseFloat(row[1]), parseFloat(row[2])], polyPts)) {
                                    L.circleMarker([row[1], row[2]], { radius: 2, color: '#94a3b8', fillOpacity: 0.5, stroke: false, pane: 'routingPane' }).addTo(this.currentDrawLayer);
                                }
                            });
                        }
                        L.circleMarker(e.latlng, { radius: 3, color: '#3b82f6' }).addTo(this.currentDrawLayer);
                    };
                    this._boundContext = (e) => {
                        e.originalEvent.preventDefault();
                        this.finishDrawing();
                    };

                    State.map.on('click', this._boundClick);
                    State.map.on('contextmenu', this._boundContext);
                    if (App.showToast) App.showToast("Drawing: Click to add points, Click Done to capture.");
                },

                saveStateToPolygon(poly) {
                    if (!poly) return;
                    poly._routeState = {
                        sequence: JSON.parse(JSON.stringify(this.sequence)), // Deep copy
                        capturedIDs: [...this.capturedIDs],
                        startId: this.startId,
                        endId: this.endId
                    };
                },

                restoreStateFromPolygon(poly) {
                    if (!poly || !poly._routeState) return;
                    const s = poly._routeState;
                    this.sequence = JSON.parse(JSON.stringify(s.sequence));
                    this.capturedIDs = [...s.capturedIDs];
                    this.startId = s.startId;
                    this.endId = s.endId;
                    this.renderRoute();
                },

                finishDrawing() {
                    if (!this.isDrawing) return;

                    // Hide Done/Cancel buttons
                    const btnDone = document.getElementById('btn-finish-draw');
                    const btnCancel = document.getElementById('btn-cancel-draw');
                    if (btnDone) btnDone.style.display = 'none';
                    if (btnCancel) btnCancel.style.display = 'none';

                    State.map.off('click', this._boundClick);
                    State.map.off('contextmenu', this._boundContext);
                    State.map.getContainer().style.cursor = '';

                    if (this.points.length > 2) {
                        if (!this.drawnPolygons) this.drawnPolygons = [];
                        const polyPts = this.points.map(p => ({ lat: p.lat, lng: p.lng }));

                        // If there was a previous active polygon, save its state and deactivate it
                        if (this.activePolygon) {
                            this.saveStateToPolygon(this.activePolygon);
                            this.activePolygon.setStyle({ color: '#94a3b8', weight: 1.5 });
                        }

                        // Harvest new IDs
                        const ids = this.harvest(polyPts);

                        // Exit batch mode
                        this.isBatchMode = false;
                        this.batchRouteSequences = [];
                        this.batchRoutePolygons = [];
                        this.activeDisplayRoutes = [];

                        // Create interactive polygon
                        const poly = L.polygon(this.points, {
                            color: '#3b82f6',
                            fillOpacity: 0.1,
                            weight: 3,
                            interactive: false,
                            pane: 'routingPane'
                        }).addTo(State.map);

                        // Initialize state for new polygon
                        poly._routeState = {
                            sequence: [],
                            capturedIDs: ids,
                            startId: null,
                            endId: null
                        };

                        // Set as active
                        this.activePolygon = poly;
                        this.capturedIDs = ids; // Load initial harvest
                        this.sequence = [];     // Start with empty sequence
                        this.startId = null;
                        this.endId = null;
                        this.renderRoute(); // Show new items

                        poly.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);

                            // If clicking the ALREADY ACTIVE polygon, do nothing
                            if (this.activePolygon === poly) return;

                            // Save state of current active polygon before switching
                            if (this.activePolygon) {
                                this.saveStateToPolygon(this.activePolygon);
                                this.activePolygon.setStyle({ color: '#94a3b8', weight: 1.5 });
                            }

                            // Activate clicked polygon and restore state
                            this.activePolygon = poly;
                            poly.setStyle({ color: '#3b82f6', weight: 3 });
                            this.restoreStateFromPolygon(poly);

                            if (App.showToast) App.showToast(`Switched to area: ${this.capturedIDs.length} items.`);
                        });

                        this.drawnPolygons.push(poly);
                        State.map.removeLayer(this.currentDrawLayer);
                    } else if (this.currentDrawLayer) {
                        State.map.removeLayer(this.currentDrawLayer);
                    }
                    this.isDrawing = false;
                },

                cancelDrawing() {
                    this.finishDrawing();
                    if (this.currentDrawLayer) State.map.removeLayer(this.currentDrawLayer);
                },

                selectAll() { this.autoNumber(); },
                deselectAll() { this.sequence = []; this.renderRoute(); },

                save() { this.saveRoute(); },
                async saveRoute(forceDownload = false) {
                    if (this.sequence.length === 0) return;

                    let defaultName;
                    if (this.editingRouteIdx !== null && this.editingRouteIdx !== undefined && this.editingRouteName) {
                        defaultName = this.editingRouteName;
                    } else {
                        let shortMC = 'Unnamed';
                        const firstSid = this.sequence[0].id;
                        const firstRow = window.RAW_DATA ? window.RAW_DATA.find(r => String(r[0]) === String(firstSid)) : null;
                        if (firstRow && firstRow[12]) {
                            const match = String(firstRow[12]).match(/(MC|UC)[- ]?(\d+)/i);
                            shortMC = match ? `${match[1].toUpperCase()}-${match[2]}` : String(firstRow[12]).split(' ')[0].replace(/[\/\\]/g, '-');
                        }
                        let routeNum = 1;
                        if (State.savedRoutes && State.savedRoutes.length > 0) {
                            const prefix = `${shortMC}_Route_`;
                            const existingForMC = State.savedRoutes.filter(r => r && r.name && r.name.startsWith(prefix));
                            routeNum = existingForMC.length + 1;
                        }
                        defaultName = `${shortMC}_Route_${routeNum}`;
                    }

                    const isEditing = this.editingRouteIdx !== null && this.editingRouteIdx !== undefined;
                    const promptMsg = isEditing ? `Update route name (or keep same):` : `Enter a name for this route:`;
                    const finalName = prompt(promptMsg, defaultName);
                    if (finalName === null || finalName.trim() === "") {
                        if (App.showToast) App.showToast("Save cancelled.");
                        return;
                    }

                    const routeObj = {
                        name: finalName.trim(),
                        sequence: this.sequence.map((p, i) => ({ surveyId: p.id, lat: p.lat, lng: p.lng, name: p.name })),
                        polygon: this.activePolygon ? this.activePolygon.getLatLngs()[0].map(ll => [ll.lat, ll.lng]) : null,
                        timestamp: new Date().toLocaleString()
                    };

                    let savedToServer = false;

                    if (!forceDownload) {
                        try {
                            const payload = {
                                route_name: routeObj.name,
                                route_data: routeObj,
                                created_by: window.USER ? window.USER.email : 'anonymous'
                            };

                            let result;
                            if (isEditing && this.editingRouteId) {
                                result = await window._supabase
                                    .from('saved_routes')
                                    .update(payload)
                                    .eq('id', this.editingRouteId);
                            } else {
                                result = await window._supabase
                                    .from('saved_routes')
                                    .insert([payload]);
                            }

                            if (result.error) throw result.error;

                            if (App.showToast) App.showToast(isEditing ? "Route updated in Cloud." : "Route saved to Cloud.");
                            savedToServer = true;
                            this.editingRouteIdx = null;
                            this.editingRouteName = null;
                            this.editingRouteId = null;
                            this.loadRoutes();
                        } catch (e) {
                            console.warn("Cloud sync failed, fallback to local:", e);
                        }
                    }

                    if (forceDownload || !savedToServer) {
                        const blob = new Blob([JSON.stringify(routeObj, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${routeObj.name}.json`;
                        a.click();
                        if (App.showToast && forceDownload) App.showToast("Route saved to disk.");
                    }
                    this.renderSavedList();
                },

                updateSpecificRouteItem(sid) {
                    if (this.isBatchMode) {
                        this.renderRoute();
                        return;
                    }

                    // 1. Update Marker on Map
                    const m = this._markerMap ? this._markerMap[sid] : null;
                    if (m) {
                        const idx = this.sequence.findIndex(p => String(p.id) === String(sid));
                        m.setIcon(L.divIcon({
                            className: idx === -1 ? 'route-marker-pool-dot' : 'route-marker-square',
                            html: idx === -1 ? '' : (idx + 1)
                        }));
                        // Update click handler to either add or remove depending on new state
                        m.off('click');
                        m.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            const sidStr = String(sid);
                            const currentIdx = this.sequence.findIndex(p => String(p.id) === sidStr);
                            if (currentIdx === -1) this.addToSequence(sidStr);
                            else this.removeFromSequence(sidStr);

                            const isMapReady = window.SID_MAP instanceof Map;
                            const row = isMapReady ? window.SID_MAP.get(sidStr) : null;
                            const seqEntry = currentIdx !== -1 ? this.sequence[currentIdx] : null;
                            const lat = row ? parseFloat(row[1]) : (seqEntry ? seqEntry.lat : null);
                            const lng = row ? parseFloat(row[2]) : (seqEntry ? seqEntry.lng : null);
                            this.highlightMarker(sidStr, lat, lng);
                            this.highlightListItem(sidStr);
                        });
                    }

                    // 2. Update Polylines over route
                    if (this.routeLayer) {
                        this.routeLayer.clearLayers();
                        if (this.activePolygon && this.activePolygon._latlngs) {
                            const polyCoords = this.activePolygon.getLatLngs()[0];
                            L.polygon(polyCoords, { color: '#94a3b8', fillOpacity: 0.08, weight: 1.5, dashArray: '5,5', interactive: false }).addTo(this.routeLayer);
                        }
                        if (this.sequence && this.sequence.length > 1) {
                            const pts = this.sequence.map(p => [p.lat, p.lng]);
                            L.polyline(pts, { color: '#3b82f6', weight: 4, opacity: 0.8 }).addTo(this.routeLayer);
                        }
                    }

                    // 3. Update DOM List Card
                    const list = document.getElementById('route-list');
                    if (list) {
                        const card = list.querySelector(`[data-sid="${sid}"]`);
                        if (card) {
                            const sidStr = String(sid);
                            const seqIdx = this.sequence.findIndex(p => String(p.id) === sidStr);
                            const isStart = seqIdx === 0;
                            const isEnd = seqIdx !== -1 && seqIdx === this.sequence.length - 1;

                            const isMapReady = window.SID_MAP instanceof Map;
                            const row = isMapReady ? window.SID_MAP.get(sidStr) : null;
                            const seqEntry = seqIdx !== -1 ? this.sequence[seqIdx] : null;
                            const name = row ? decodePII(row[4]) : (seqEntry ? seqEntry.name : '');
                            let area = row ? (row[12] || 'Area').replace(/Municipal Committee/gi, 'MC').replace(/Union Council/gi, 'UC') : '';
                            if (area) area = area.replace(/\s*(Bhalwal|Sargodha|Mianwali|Khushab|Tehsil)\s*/gi, '').trim();

                            card.innerHTML = `
                                <div class="v6-badge" style="background:${isStart ? '#10b981' : isEnd ? '#ef4444' : ''}; padding:0; overflow:hidden; width:26px; height:24px;">
                                    <input type="number" min="1" max="${this.sequence.length + 1}" value="${seqIdx === -1 ? '' : seqIdx + 1}" placeholder="-"
                                           style="width:100%; height:100%; border:none; background:transparent; color:${(isStart || isEnd) ? 'white' : 'var(--primary)'}; text-align:center; font-size:10px; font-weight:800; outline:none; padding:0;"
                                           onchange="SpatialRouter.updateSequenceManual('${sid}', this.value)"
                                           onclick="event.stopPropagation()">
                                </div>
                                <div class="v6-card-body">
                                    <div class="v6-card-title">#${sid}</div>
                                    <div class="v6-card-sub">${area || name || ''} | ${seqIdx === -1 ? 'Pool' : (isStart ? 'Start' : isEnd ? 'End' : 'Sequenced')}</div>
                                </div>
                                <button onclick="event.stopPropagation(); SpatialRouter.${seqIdx === -1 ? 'addToSequence' : 'removeFromSequence'}('${sid}')" class="v6-action-btn" style="color:${seqIdx === -1 ? '#10b981' : '#ef4444'}">
                                    <span class="material-icons-round" style="font-size:18px;">${seqIdx === -1 ? 'library_add' : 'remove_circle'}</span>
                                </button>
                            `;
                        }
                    }
                    this.updateStats();
                },

                removeFromSequence(sid) {
                    if (this.isLocked) { if (App.showToast) App.showToast("Sequence is locked."); return; }
                    const sidStr = String(sid);
                    this.sequence = this.sequence.filter(p => String(p.id) !== sidStr);
                    this.updateSpecificRouteItem(sidStr);
                },

                addToSequence(sid) {
                    if (this.isLocked) { if (App.showToast) App.showToast("Sequence is locked."); return; }
                    const sidStr = String(sid);
                    if (this.sequence.findIndex(p => String(p.id) === sidStr) !== -1) return;
                    const isMapReady = window.SID_MAP instanceof Map;
                    const row = isMapReady ? window.SID_MAP.get(sidStr) : null;
                    if (row) {
                        this.sequence.push({ id: sidStr, lat: parseFloat(row[1]), lng: parseFloat(row[2]), name: decodePII(row[4]) });
                        this.updateSpecificRouteItem(sidStr);
                    }
                },

                addToSequenceOnly(id) { this.addToSequence(id); }
            };



            const MapNavigator = {
                visible: false,
                toggle() {
                    this.visible = !this.visible;
                    const btn = document.getElementById('btn-nav-toggle');
                    if (btn) btn.classList.toggle('active', this.visible);
                    this.updateUI();
                },
                show() {
                    this.visible = true;
                    const btn = document.getElementById('btn-nav-toggle');
                    if (btn) btn.classList.add('active');
                    this.updateUI();
                },
                updateUI() {
                    setTimeout(() => {
                        const pager = document.getElementById('map-pager');
                        if (!pager) return;

                        const source = State.filtered;
                        const currentId = source && source[State.currentIdx] ? source[State.currentIdx][0] : null;

                        if (!source || source.length === 0 || !this.visible) {
                            pager.style.setProperty('display', 'none', 'important');
                            return;
                        }

                        pager.style.setProperty('display', 'flex', 'important');

                        // Update index display
                        let displayIdx = State.currentIdx + 1;
                        document.getElementById('map-nav-idx').innerText = displayIdx;
                        document.getElementById('map-nav-total').innerText = source.length;
                    }, 50);
                },
                move(dir) {
                    if (!State.filtered || State.filtered.length === 0) return;
                    let len = State.filtered.length;
                    let newIdx = (State.currentIdx + dir + len) % len;
                    State.currentIdx = newIdx;

                    const record = State.filtered[State.currentIdx];
                    if (record) {
                        // Use showOnMap which handles selection/zooming
                        ListView.showOnMap(record[0], false);
                    }
                    this.updateUI();
                }
            };

            // Expose Globals explicitly for inline event handlers and external access
            window.State = State;
            window.App = App;
            window.Sidebar = Sidebar;
            window.InfoCard = InfoCard;
            window.Settings = Settings;
            window.Gallery = Gallery;
            window.DriveSync = DriveSync;
            window.LayerManager = LayerManager || {};
            window.ViewSwitcher = ViewSwitcher;
            window.ListView = ListView;
            window.PerformanceLog = PerformanceLog;
            window.BillVerifier = BillVerifier;
            window.PaidBills = PaidBills;
            window.UniversalSearch = UniversalSearch;
            window.Stats = Stats;
            window.SpatialRouter = SpatialRouter;
            window.MapNavigator = MapNavigator;

            // Draggable / Resizable UI Helpers
            const UIInteractions = {
                setupDraggable(el, handle) {
                    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                    handle.onmousedown = dragMouseDown;

                    function dragMouseDown(e) {
                        e = e || window.event;
                        e.preventDefault();
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        document.onmouseup = closeDragElement;
                        document.onmousemove = elementDrag;
                        el.style.transition = 'none';
                        el.dataset.dragged = "true";
                    }

                    function elementDrag(e) {
                        e = e || window.event;
                        e.preventDefault();
                        pos1 = pos3 - e.clientX;
                        pos2 = pos4 - e.clientY;
                        pos3 = e.clientX;
                        pos4 = e.clientY;

                        let newTop = el.offsetTop - pos2;
                        let newLeft = el.offsetLeft - pos1;

                        // Contain within viewport
                        newTop = Math.max(0, Math.min(newTop, window.innerHeight - 50));
                        newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - 50));

                        el.style.top = newTop + "px";
                        el.style.left = newLeft + "px";
                        el.style.bottom = 'auto';
                        el.style.right = 'auto';
                    }

                    function closeDragElement() {
                        document.onmouseup = null;
                        document.onmousemove = null;
                        el.style.transition = '';
                    }
                },
                toggleExtraCtrls() {
                    const ctrls = document.getElementById('extra-ctrls');
                    const btn = document.getElementById('toggle-ctrls-btn');
                    if (!ctrls || !btn) return;
                    const isHidden = window.getComputedStyle(ctrls).display === 'none';
                    ctrls.style.display = isHidden ? 'flex' : 'none';
                    btn.querySelector('span').innerText = isHidden ? 'expand_less' : 'expand_more';
                },
                setupResizable(el, handle) {
                    handle.onmousedown = initResize;

                    function initResize(e) {
                        e.preventDefault();
                        window.addEventListener('mousemove', Resize, false);
                        window.addEventListener('mouseup', stopResize, false);
                        el.style.transition = 'none';
                    }

                    function Resize(e) {
                        const newWidth = Math.max(280, e.clientX - el.offsetLeft);
                        const newHeight = Math.max(200, e.clientY - el.offsetTop);
                        el.style.width = newWidth + 'px';
                        el.style.height = newHeight + 'px';
                        el.style.bottom = 'auto';
                        el.style.right = 'auto';
                        el.dataset.prevHeight = newHeight + 'px';
                    }

                    function stopResize(e) {
                        window.removeEventListener('mousemove', Resize, false);
                        window.removeEventListener('mouseup', stopResize, false);
                        el.style.transition = '';
                    }
                }
            };

            // Global Key Handlers
            document.addEventListener('keydown', (e) => {
                // CMD+K or CTRL+K for Universal Search
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    UniversalSearch.open();
                }

                if (e.key === 'Escape') {
                    UniversalSearch.close();
                    PaidBills.close();
                    BillVerifier.close();
                    if (typeof Gallery !== 'undefined') Gallery.close();
                }

                // [ for Previous, ] for Next (Survey ID iteration)
                if (e.key === '[') {
                    e.preventDefault();
                    MapNavigator.move(-1);
                } else if (e.key === ']') {
                    e.preventDefault();
                    MapNavigator.move(1);
                } else if (e.key.toLowerCase() === 'm') {
                    // "M" for Map
                    if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                        ViewSwitcher.toMap();
                    }
                }
            });


            window.onload = () => {
                if (window.APP_DATA_LOADED && window.App && !window.APP_INITIALIZED) {
                    window.App.init();
                    Auth.updateUI();
                }
                if (window.SpatialRouter) SpatialRouter.init();

                // Initialize Overlay Interactions
                const overlay = document.getElementById('routing-station-overlay');
                const handle = document.getElementById('routing-drag-handle');
                const resize = document.getElementById('routing-resize-handle');
                if (overlay && handle) UIInteractions.setupDraggable(overlay, handle);
                if (overlay && resize) UIInteractions.setupResizable(overlay, resize);

                // Prevent Accidental Exit
                window.addEventListener('beforeunload', (e) => {
                    e.preventDefault();
                    e.returnValue = ''; // Standard requirement for modern browsers
                });

                // Handle Mobile Back Button (Push a dummy state to history)
                window.history.pushState({ page: 1 }, "", "");
                window.onpopstate = function (event) {
                    if (confirm("Exit App? Unsaved progress (like selected filters) will be lost.")) {
                        window.history.back();
                    } else {
                        window.history.pushState({ page: 1 }, "", "");
                    }
                };
            };
        </script>
</body>

</html>